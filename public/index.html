<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Deriv Bot Store</title>
  <meta name="theme-color" content="#16a34a">
  <meta name="description" content="Explore trading bots at Deriv Bot Store. Find automated solutions for your trading needs.">
  <meta name="keywords" content="trading bots, Deriv, automation, Binary trading, Deriv Bots , Deriv strategies for begginers">
  <meta property="og:title" content="Deriv Bot Store">
  <meta property="og:description" content="Explore trading bots at Deriv Bot Store. Find automated solutions for your trading needs.">
  <meta property="og:image" content="/favicon.png">
  <meta property="og:type" content="website">
  <link rel="icon" type="image/png" href="/favicon.png">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked@4.0.12/marked.min.js"></script>
  <!-- PayHero Button SDK script REMOVED -->
  <script src="https://cdn.jsdelivr.net/npm/sanitize-html@2.7.0/dist/sanitize-html.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
  <style>
  body.popup-active {
    overflow: hidden;
  }

  .truncate-2-lines {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  .truncate-3-lines {
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
    overflow: hidden;
    min-height: 4.5rem;
  }

  #urgent-message {
    background: linear-gradient(90deg, rgba(255, 215, 0, 0.9), rgba(255, 165, 0, 0.9));
    border-radius: 0 0 15px 15px;
    animation: slideDown 0.5s ease-out;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
  }

  @keyframes slideDown {
    from { transform: translateY(-100%); opacity: 0; }
    to { transform: translateY(0); opacity: 1; }
  }

  .search-container {
    position: relative;
  }

  .search-container input {
    padding-left: 2.5rem;
    transition: all 0.3s ease;
    border: 1px solid #d1d5db;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
  }

  .search-container input:focus {
    border-color: #16a34a;
    box-shadow: 0 0 0 3px rgba(22, 163, 74, 0.2);
    outline: none;
  }

  .search-container svg {
    position: absolute;
    left: 0.75rem;
    top: 50%;
    transform: translateY(-50%);
    width: 1.25rem;
    height: 1.25rem;
    color: #6b7280;
  }

  #details-modal .modal-content {
    max-height: 90vh;
    overflow: hidden;
    display: flex;
    flex-direction: column;
    background: linear-gradient(145deg, #ffffff, #f0f4f8);
    border-radius: 16px;
    box-shadow: 0 8px 30px rgba(0, 0, 0, 0.15);
    border: 1px solid #e5e7eb;
    max-width: 900px;
    width: 90%;
  }

  #details-modal .modal-main {
    flex: 1;
    padding: 1rem;
    overflow-y: auto;
    scrollbar-width: thin;
    scrollbar-color: #16a34a #e5e7eb;
    max-height: 60vh; /* Limit height on mobile */
  }

  #details-modal .modal-main::-webkit-scrollbar {
    width: 8px;
  }

  #details-modal .modal-main::-webkit-scrollbar-track {
    background: #e5e7eb;
    border-radius: 4px;
  }

  #details-modal .modal-main::-webkit-scrollbar-thumb {
    background: #16a34a;
    border-radius: 4px;
  }

  #details-modal .modal-sidebar {
    width: 100%;
    padding: 1rem;
    border-top: 1px solid #e5e7eb;
    background: #f9fafb;
    display: flex;
    flex-direction: column;
    justify-content: flex-start;
  }

  #details-modal .close-btn {
    background: linear-gradient(90deg, #ef4444, #f87171);
    color: white;
    border-radius: 50%;
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
    z-index: 10;
    position: absolute;
    top: 1rem;
    right: 1rem;
  }

  #details-modal .close-btn:hover {
    background: linear-gradient(90deg, #dc2626, #ef4444);
    transform: scale(1.1) rotate(90deg);
    box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
  }

  #details-desc {
    line-height: 1.6;
    margin-bottom: 1rem;
    color: #4b5563;
    width: 100%;
    overflow-wrap: break-word;
    word-wrap: break-word;
    -webkit-hyphens: auto;
    -ms-hyphens: auto;
    hyphens: auto;
  }

  #details-desc p {
    margin-bottom: 1rem;
    word-break: break-word;
  }

  #details-desc ul,
  #details-desc ol {
    list-style: none;
    padding-left: 0;
    margin-bottom: 1rem;
  }

  #details-desc li {
    margin-bottom: 0.5rem;
    position: relative;
    padding-left: 1.5rem;
  }

  #details-desc li::before {
    content: "â€¢";
    color: #16a34a;
    position: absolute;
    left: 0;
    top: 0;
    font-size: 1.2rem;
  }

  .embed-container {
    position: relative;
    padding-bottom: 56.25%;
    height: 0;
    overflow: hidden;
    margin-bottom: 2rem;
  }

  .embed-container iframe {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    border: 0;
    border-radius: 12px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
  }

  .thumbnail-image {
    width: 100%;
    max-width: 640px;
    height: auto;
    border-radius: 12px;
    box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1);
    margin-bottom: 1.5rem;
    transition: transform 0.3s ease;
  }

  .thumbnail-image:hover {
    transform: scale(1.02);
  }

  .product-image-container {
    position: relative;
    width: 100%;
    padding-bottom: 56.25%;
    overflow: hidden;
  }

  .product-image-container img {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    object-fit: cover;
    border-top-left-radius: 12px;
    border-top-right-radius: 12px;
    aspect-ratio: 16 / 9;
    transition: transform 0.3s ease;
  }

  .product-image-container img:hover {
    transform: scale(1.05);
  }

  .new-badge {
    position: absolute;
    top: 0.75rem;
    left: 50%;
    transform: translateX(-50%);
    background: linear-gradient(90deg, #16a34a, #22c55e);
    color: white;
    font-size: 0.75rem;
    font-weight: 600;
    padding: 0.35rem 1rem;
    border-radius: 9999px;
    z-index: 10;
    box-shadow: 0 2px 8px rgba(22, 163, 74, 0.3);
  }

  .item-hidden {
    display: none;
  }

  #download-progress-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.7);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 999;
    display: none;
  }

  #download-progress-content {
    background: linear-gradient(145deg, #ffffff, #f0f4f8);
    padding: 1.5rem;
    border-radius: 16px;
    text-align: center;
    width: 90%;
    max-width: 420px;
    box-shadow: 0 8px 30px rgba(0, 0, 0, 0.15);
    transform: translateY(20px) scale(0.9);
    animation: popupFadeIn 0.5s ease-out forwards;
  }

  #download-progress-bar {
    width: 100%;
    height: 20px;
    background: #e5e7eb;
    border-radius: 10px;
    overflow: hidden;
    margin-top: 10px;
  }

  #download-progress-fill {
    height: 100%;
    background: linear-gradient(90deg, #16a34a, #22c55e);
    width: 0%;
    transition: width 0.3s ease;
  }

  #download-error {
    color: #dc2626;
    margin-top: 10px;
    display: none;
  }

  #product-grid .bg-white {
    display: flex;
    flex-direction: column;
    height: 100%;
    border-radius: 12px;
    overflow: hidden;
    transition: all 0.3s ease;
  }

  #product-grid .bg-white:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
  }

  #product-grid .p-6 {
    flex: 1;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
  }

  #product-grid .view-details {
    background: linear-gradient(90deg, #16a34a, #22c55e);
    transition: all 0.3s ease;
  }

  #product-grid .view-details:hover {
    background: linear-gradient(90deg, #15803d, #16a34a);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(22, 163, 74, 0.3);
  }

  #payment-modal .bg-white,
  #ref-code-modal .bg-white,
  #status-modal .bg-white,
  #static-page-modal .bg-white {
    background: linear-gradient(145deg, #ffffff, #f0f4f8);
    border-radius: 16px;
    box-shadow: 0 8px 30px rgba(0, 0, 0, 0.15);
    transform: translateY(20px) scale(0.9);
    animation: popupFadeIn 0.5s ease-out forwards;
  }

  #payment-modal .bg-white button,
  #ref-code-modal .bg-white button,
  #status-modal .bg-white button {
    transition: all 0.3s ease;
  }

  #payment-modal .bg-white button:hover,
  #ref-code-modal .bg-white button:hover,
  #status-modal .bg-white button:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
  }

  #confirm-payment,
  #submit-ref-code {
    background: linear-gradient(90deg, #16a34a, #22c55e);
  }

  #confirm-payment:hover,
  #submit-ref-code:hover {
    background: linear-gradient(90deg, #15803d, #16a34a);
  }

  #payment-cancel,
  #ref-code-cancel {
    background: linear-gradient(90deg, #6b7280, #9ca3af);
  }

  #payment-cancel:hover,
  #ref-code-cancel:hover {
    background: linear-gradient(90deg, #4b5563, #6b7280);
  }

  #status-retry {
    background: linear-gradient(90deg, #2563eb, #3b82f6);
  }

  #status-retry:hover {
    background: linear-gradient(90deg, #1d4ed8, #2563eb);
  }

  #mobile-menu {
    transform: translateX(-100%);
    transition: transform 0.3s ease-in-out;
    background: linear-gradient(145deg, #ffffff, #f0f4f8);
  }

  #mobile-menu.open {
    transform: translateX(0);
  }

  #cookie-popup-container {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.7);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 999;
  }

  #cookie-popup {
    background: linear-gradient(145deg, #ffffff, #f0f4f8);
    padding: 2rem;
    border-radius: 16px;
    text-align: center;
    box-shadow: 0 15px 40px rgba(0, 0, 0, 0.25);
    animation: popupFadeIn 0.5s ease-out forwards;
    max-width: 90%;
    width: 500px;
  }

  #cookie-popup p {
    color: #444;
    font-size: 1rem;
    margin-bottom: 20px;
  }

  #cookie-popup button {
    padding: 12px 24px;
    border: none;
    border-radius: 10px;
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    display: block;
    margin: 20px auto 0;
    background: linear-gradient(90deg, #28a745, #34d058);
    color: white;
  }

  #cookie-popup button:hover {
    background: linear-gradient(90deg, #218838, #2cb94e);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
  }

  .popup {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.7);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 999;
  }

  .popup-content {
    background: linear-gradient(145deg, #ffffff, #f0f4f8);
    padding: 2rem;
    border-radius: 16px;
    text-align: center;
    box-shadow: 0 15px 40px rgba(0, 0, 0, 0.25);
    animation: popupFadeIn 0.5s ease-out forwards;
    max-width: 90%;
    width: 500px;
  }

  .popup-content h3 {
    margin-bottom: 1.5rem;
    font-size: 1.75rem;
    color: #222;
    font-weight: 600;
  }

  @keyframes popupFadeIn {
    from { transform: translateY(20px) scale(0.9); opacity: 0; }
    to { transform: translateY(0) scale(1); opacity: 1; }
  }

  .browser-popup-button {
    padding: 12px 24px;
    border: none;
    border-radius: 10px;
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    display: block;
    margin: 20px auto 0;
  }

  .browser-popup-button.cancel {
    background: linear-gradient(90deg, #28a745, #34d058);
    color: white;
  }

  .browser-popup-button.cancel:hover {
    background: linear-gradient(90deg, #218838, #2cb94e);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
  }

  #details-desc h1 { font-size: 18px; }
  #details-desc h2 { font-size: 14px; }
  #details-desc h3 { font-size: 12px; }
  #details-desc img { box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); }

  @media (min-width: 769px) {
    #details-modal .modal-content {
      flex-direction: row;
    }

    #details-modal .modal-main {
      padding: 2rem;
      max-height: none; /* Reset for desktop */
    }

    #details-modal .modal-sidebar {
      width: 250px;
      border-left: 1px solid #e5e7eb;
      position: sticky;
      top: 0;
      height: 100%;
    }
  }

  @media (max-width: 768px) {
    #details-modal .modal-content {
      flex-direction: column;
    }

    #details-modal .modal-main {
      padding: 1rem;
    }

    #details-desc li {
      padding-left: 1rem; /* Reduce padding on mobile */
    }
  }

  @media (max-width: 640px) {
    #nav-links {
      display: none;
    }

    #mobile-menu {
      display: block;
    }

    #mobile-nav-links {
      flex-direction: column;
      align-items: flex-start;
    }

    #mobile-nav-links a {
      padding: 0.5rem 0;
      width: 100%;
    }

    .create-account-btn {
      font-size: 0.875rem;
      padding: 0.5rem 1rem;
      background: linear-gradient(90deg, #16a34a, #22c55e);
    }

    .create-account-btn:hover {
      background: linear-gradient(90deg, #15803d, #16a34a);
    }

    footer {
      display: none;
    }

    #mobile-footer {
      display: flex;
      flex-direction: column;
      padding: 1rem;
      border-top: 1px solid #e5e7eb;
      background: #f9fafb;
    }
  }

  @media (min-width: 641px) {
    #mobile-footer {
      display: none;
    }
  }

  /* PayHero Styles - Kept for modal structure, actual SDK button styling is removed */
  .payhero-modal {
    display: none;
    position: fixed;
    z-index: 9999;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    overflow: hidden;
    background-color: rgba(0, 0, 0, 0.7);
    animation: payheroFadeIn 0.3s ease;
    backdrop-filter: blur(3px);
  }

  .payhero-modal-content {
    background-color: #fff;
    margin: 2vh auto;
    padding: 0;
    border-radius: 12px;
    box-shadow: 0 8px 30px rgba(0, 0, 0, 0.3);
    overflow: hidden;
    max-width: 400px;
    max-height: 90%;
    animation: payheroSlideIn 0.3s ease;
    display: flex;
    flex-direction: column;
  }

  .payhero-modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 16px 20px;
    background-color: #f8f9fa;
    border-bottom: 1px solid #eaeaea;
  }

  .payhero-modal-title {
    margin: 0;
    font-size: 18px;
    color: #333;
    font-weight: 600;
  }

  .payhero-close-button {
    background: none;
    border: none;
    font-size: 24px;
    line-height: 1;
    color: #999;
    cursor: pointer;
    padding: 0 8px;
    transition: color 0.2s;
  }

  .payhero-close-button:hover {
    color: #333;
  }

  .payhero-form-container {
    padding: 20px;
    display: flex;
    flex-direction: column;
    gap: 15px;
  }

  .payhero-form-container label {
    font-weight: 500;
    color: #333;
    margin-bottom: 5px;
  }

  .payhero-form-container input[type="text"],
  .payhero-form-container input[type="tel"] {
    width: 100%;
    padding: 10px;
    border: 1px solid #ccc;
    border-radius: 6px;
    font-size: 16px;
    box-sizing: border-box;
  }

  .payhero-form-container .amount-display {
    font-size: 18px;
    font-weight: bold;
    color: #16a34a;
    text-align: center;
    margin-bottom: 10px;
  }

  @keyframes payheroFadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
  }

  @keyframes payheroSlideIn {
    from { transform: translateY(-20px); opacity: 0; }
    to { transform: translateY(0); opacity: 1; }
  }

  @media (max-width: 768px) {
    .payhero-modal-content {
      width: 95% !important;
      margin: 5vh auto;
    }
  }
</style>
</head>
<body class="bg-gray-100">
  <div id="urgent-message" class="fixed top-0 left-0 right-0 text-white p-4 z-50 hidden">
    <p id="urgent-text" class="text-center text-lg font-semibold"></p>
    <button id="urgent-close" class="mt-2 block mx-auto bg-gray-600 text-white px-4 py-1 rounded-full">Okay</button>
  </div>

  <nav class="bg-white shadow-md sticky top-0 z-20">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex justify-between h-16">
        <div class="flex items-center">
          <div id="logo-container">
            <h1 class="text-xl sm:text-2xl font-bold text-gray-800">Deriv Bot Store</h1>
          </div>
          <div id="nav-links" class="hidden sm:ml-6 sm:flex sm:space-x-8">
            <a href="#" data-category="all" class="nav-link border-b-2 border-green-500 text-gray-900 px-1 pt-1 text-sm font-medium">Home</a>
          </div>
        </div>
        <div class="flex items-center space-x-4">
          <div class="hidden sm:block search-container">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
            </svg>
            <input id="search-bar" type="text" placeholder="Search bots by name..." class="p-2 rounded-md border">
          </div>
          <a href="https://track.deriv.com/_5b97G5QPtjsKqFKZ7JdnQ2Nd7ZgqdRLk/1/" class="create-account-btn bg-green-600 text-white px-4 py-2 rounded-lg font-medium hover:bg-green-700 transition-colors">Create Account</a>
          <button id="mobile-menu-button" class="sm:hidden text-gray-500 p-2">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
            </svg>
          </button>
        </div>
      </div>
    </div>
    <div id="mobile-menu" class="sm:hidden fixed top-0 left-0 h-full w-64 bg-white shadow-lg z-30">
      <div class="flex justify-between items-center p-4 border-b">
        <h2 class="text-lg font-bold text-gray-800">Menu</h2>
        <button id="mobile-menu-close" class="text-gray-500">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
      </div>
      <div id="mobile-nav-links" class="flex flex-col p-4 space-y-4"></div>
      <div id="mobile-footer" class="mt-auto p-4">
        <p id="mobile-copyright-text" class="text-gray-600 text-sm"></p>
        <p class="text-gray-500 mt-2 text-sm">Support: <a id="mobile-support-email" class="underline"></a></p>
        <div id="mobile-social-links" class="mt-4 flex flex-col space-y-2"></div>
        <div id="mobile-static-links" class="mt-4 flex flex-col space-y-2"></div>
      </div>
    </div>
  </nav>

  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6 sm:hidden">
    <div class="search-container">
      <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
      </svg>
      <input id="mobile-search-bar" type="text" placeholder="Search bots by name..." class="w-full p-3 rounded-md border">
    </div>
  </div>

  <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
    <h2 class="text-3xl font-bold text-gray-900 mb-8 text-center">Explore Our Bots</h2>
    <div id="product-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
      <div id="loading-message" class="col-span-full text-center text-gray-600">
        Loading bots... If this takes too long, please refresh the page or contact support at <a href="/cdn-cgi/l/email-protection#5e353f2732373b6c6b6a703c2b2d37303b2d2d1e39333f3732703d3133" class="underline text-green-600"><span class="__cf_email__" data-cfemail="b8d3d9c1d4d1dd8a8d8c96dacdcbd1d6ddcbcbf8dfd5d9d1d496dbd7d5">[email&#160;protected]</span></a>.
      </div>
    </div>
  </main>

  <footer class="bg-white shadow-inner mt-12 py-6">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 text-center">
      <p id="copyright-text" class="text-gray-600"></p>
      <p class="text-gray-500 mt-2">Support: <a id="support-email" class="underline"></a></p>
      <div id="social-links" class="mt-4 flex justify-center space-x-4 flex-wrap"></div>
      <div id="static-links" class="mt-4 flex justify-center space-x-4 flex-wrap"></div>
    </div>
  </footer>

  <div id="cookie-popup-container" class="hidden">
    <div id="cookie-popup" class="popup-content">
      <p>We use cookies to enhance your experience. By continuing, you agree to our <a href="/cookie-policy" class="underline text-green-600">Cookie Policy</a>.</p>
      <button id="cookie-accept" class="browser-popup-button cancel">Accept Cookies</button>
    </div>
  </div>

  <script>
    // Define handleCookiePopup before calling it
    function handleCookiePopup() {
      const cookiePopup = document.getElementById('cookie-popup-container');
      const acceptButton = document.getElementById('cookie-accept');
      
      const cookiesAccepted = localStorage.getItem('cookiesAccepted') === 'true';
      const lastShown = parseInt(localStorage.getItem('cookiePopupLastShown'), 10);
      const threeDays = 3 * 24 * 60 * 60 * 1000;
      const now = Date.now();

      if (cookiesAccepted && lastShown && (now - lastShown) < threeDays) {
        cookiePopup.classList.add('hidden');
        cookiePopup.style.display = 'none';
        return;
      }

      cookiePopup.classList.remove('hidden');
      cookiePopup.style.display = 'flex';
      document.body.classList.add('popup-active');

      acceptButton.removeEventListener('click', handleAcceptClick);
      
      function handleAcceptClick() {
        localStorage.setItem('cookiesAccepted', 'true');
        localStorage.setItem('cookiePopupLastShown', Date.now().toString());
        cookiePopup.classList.add('hidden');
        cookiePopup.style.display = 'none';
        document.body.classList.remove('popup-active');
      }
      acceptButton.addEventListener('click', handleAcceptClick);
    }
    handleCookiePopup();
  </script>

  <div id="details-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="modal-content flex flex-col md:flex-row relative">
      <button id="details-close" class="close-btn">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
        </svg>
      </button>
      <div class="modal-main">
        <img id="details-thumbnail" class="thumbnail-image" src="" alt="">
        <h3 id="details-name" class="text-2xl font-bold text-gray-900 mb-3"></h3>
        <p id="details-item" class="text-sm text-gray-500 mb-3">File: <span id="details-item-name"></span></p>
        <div id="details-desc" class="text-gray-600"></div>
        <div id="details-embed"></div>
      </div>
      <div class="modal-sidebar">
        <button id="details-buy-now" class="buy-now-btn bg-green-600 text-white py-2 rounded-md hover:bg-green-700 mb-2">Buy Now</button>
        <button id="details-test-pay" class="buy-now-btn bg-blue-600 text-white py-2 rounded-md hover:bg-blue-700 hidden">Test Instant Payment</button>
      </div>
    </div>
  </div>

  <!-- Payment Choice Modal -->
  <div id="payment-choice-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-lg p-6 w-full max-w-sm">
      <h3 class="text-xl font-bold text-gray-900 mb-4">Choose Payment Method</h3>
      <p id="payment-choice-product-name" class="text-gray-700 mb-1"></p>
      <p id="payment-choice-amount" class="text-green-600 font-bold mb-6"></p>
      <button id="manual-mpesa-choice" class="w-full bg-blue-600 text-white py-2 rounded-md hover:bg-blue-700 mb-3">Pay with Mpesa Till (Manual)</button>
      <button id="payhero-choice" class="w-full bg-green-600 text-white py-2 rounded-md hover:bg-green-700 mb-3">Pay with Pay Hero (Mpesa STK)</button>
      <button id="nowpayments-choice" class="w-full bg-yellow-500 text-white py-2 rounded-md hover:bg-yellow-600">Pay with Crypto (NOWPayments)</button>
      <button id="payment-choice-cancel" class="mt-4 w-full bg-gray-600 text-white py-2 rounded-md hover:bg-gray-700">Cancel</button>
    </div>
  </div>

  <!-- NOWPayments Modal -->
  <div id="nowpayments-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden px-4 py-6">
    <div class="bg-white rounded-lg p-5 sm:p-6 w-full max-w-md shadow-xl transform transition-all" style="max-height: 90vh; overflow-y: auto;">
      <h3 id="nowpayments-title" class="text-xl sm:text-2xl font-bold text-gray-800 mb-4 text-center">Pay with Cryptocurrency</h3>
      <p id="nowpayments-product-name" class="text-gray-600 text-sm mb-1 text-center"></p>
      <p id="nowpayments-amount-usd" class="text-green-600 font-semibold mb-5 text-center"></p>

      <div class="space-y-4">
        <div>
          <label for="nowpayments-email" class="block text-sm font-medium text-gray-700 mb-1">Your Email:</label>
          <input type="email" id="nowpayments-email" class="mt-1 block w-full p-2.5 border border-gray-300 rounded-lg shadow-sm focus:ring-green-500 focus:border-green-500 sm:text-sm" placeholder="you@example.com" required>
        </div>

        <div>
          <label for="nowpayments-currency-search" class="block text-sm font-medium text-gray-700 mb-1">Search Currency:</label>
          <input type="text" id="nowpayments-currency-search" class="mt-1 block w-full p-2.5 border border-gray-300 rounded-lg shadow-sm focus:ring-green-500 focus:border-green-500 sm:text-sm" placeholder="e.g., Bitcoin or BTC">
        </div>

        <div>
          <label for="nowpayments-currency" class="block text-sm font-medium text-gray-700 mb-1">Select Cryptocurrency:</label>
          <select id="nowpayments-currency" class="mt-1 block w-full p-2.5 border border-gray-300 rounded-lg shadow-sm focus:ring-green-500 focus:border-green-500 sm:text-sm bg-white">
            <option value="">Loading currencies...</option>
          </select>
        </div>
      </div>

      <button id="nowpayments-proceed" class="mt-6 w-full bg-yellow-500 text-white py-2.5 px-4 rounded-lg hover:bg-yellow-600 focus:ring-4 focus:ring-yellow-300 transition-all duration-150 ease-in-out font-medium flex items-center justify-center">
        Proceed to Payment
      </button>
      <button id="nowpayments-cancel" class="mt-2.5 w-full bg-gray-200 text-gray-700 py-2.5 px-4 rounded-lg hover:bg-gray-300 focus:ring-4 focus:ring-gray-100 transition-all duration-150 ease-in-out font-medium">Cancel</button>

      <p id="nowpayments-status-message" class="text-center text-sm mt-4 font-medium"></p>

      <div id="nowpayments-payment-info" class="mt-6 hidden bg-gray-50 p-4 rounded-lg">
        <div id="nowpayments-timer" class="text-center font-semibold text-blue-600 mb-3"></div>
        <div id="nowpayments-payment-details-content">
            <p class="text-gray-700 mb-2 text-sm">Please send exactly <strong id="nowpayments-pay-amount" class="text-gray-900"></strong> <strong id="nowpayments-pay-currency" class="text-gray-900"></strong> to the address below:</p>
            <div class="bg-gray-100 p-3 my-2 rounded-md border border-gray-200">
              <p class="text-xs sm:text-sm font-mono break-all text-gray-800" id="nowpayments-pay-address"></p>
            </div>
            <button id="nowpayments-copy-address" class="w-full text-sm bg-green-500 hover:bg-green-600 text-white font-medium py-2 px-3 rounded-md transition-colors duration-150 ease-in-out flex items-center justify-center">
              Copy Address
            </button>
            <p class="text-xs text-gray-500 mt-3">Ensure you send the exact amount and use the correct network. Underpayments or payments to the wrong network may be lost.</p>
        </div>
        <!-- Status message moved up -->
      </div>
    </div>
  </div>

  <div id="payment-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-lg p-6 w-full max-w-md">
      <div id="countdown-timer" class="mb-4">
        <p class="text-gray-600">Time remaining: <span id="timer-text">10:00</span></p>
        <div class="w-full h-2 bg-gray-200 rounded-full overflow-hidden">
          <div id="timer-bar" class="h-full bg-green-600 transition-all duration-1000" style="width: 100%;"></div>
        </div>
      </div>
      <h3 id="payment-title" class="text-xl font-bold text-gray-900 mb-4"></h3>
      <p class="text-gray-600 mb-4">Please send the payment via MPESA to:</p>
      <div class="flex items-center space-x-2">
        <p class="font-semibold text-gray-900">Till Number: <span id="mpesa-till-number">4933614</span></p>
        <button id="copy-till" class="text-sm text-green-600 hover:underline">Copy Till</button>
      </div>
      <p id="payment-amount" class="text-green-600 font-bold mt-2"></p>
      <p class="text-gray-600 mt-4">We are working to add more payment options on the checkout. Meanwhile, if you do not find your preferred Payment option, <a href="https://wa.link/11x0nx" class="text-blue-600 underline" target="_blank">contact us</a>.</p>
      <button id="confirm-payment" class="mt-6 w-full bg-green-600 text-white py-2 rounded-md hover:bg-green-700">I Have Paid</button>
      <button id="payment-cancel" class="mt-2 w-full bg-gray-600 text-white py-2 rounded-md hover:bg-gray-700">Cancel</button>
    </div>
  </div>

  <!-- PayHero Modal (for Server-Side STK Push) -->
  <div id="payhero-modal" class="payhero-modal">
    <div class="payhero-modal-content">
      <div class="payhero-modal-header">
        <h3 class="payhero-modal-title">Pay with Pay Hero (Mpesa STK)</h3>
        <button id="payhero-close-button" class="payhero-close-button" aria-label="Close payment form">Ã—</button>
      </div>
      <div class="payhero-form-container">
        <p class="amount-display">Amount: KES <span id="payhero-amount-display">0.00</span></p>
        <div>
          <label for="payhero-customer-name">Name (Optional):</label>
          <input type="text" id="payhero-customer-name" placeholder="Enter your name">
        </div>
        <div>
          <label for="payhero-phone-number">Mpesa Number:</label>
          <input type="tel" id="payhero-phone-number" placeholder="e.g., 0712345678 or 254712345678">
        </div>
        <div>
          <button id="payhero-proceed-button" class="w-full bg-green-600 text-white py-2.5 rounded-md hover:bg-green-700 transition-colors">Proceed to Pay via Mpesa</button>
        </div>
        <p id="payhero-status-message" class="text-center text-sm mt-2"></p>
      </div>
    </div>
  </div>

  <div id="ref-code-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-lg p-6 w-full max-w-md">
      <h3 class="text-xl font-bold text-gray-900 mb-4">Enter MPESA Ref Code</h3>
      <input id="ref-code-input" type="text" placeholder="e.g., QK12345678" class="w-full p-2 border rounded-md mb-4">
      <button id="submit-ref-code" class="w-full bg-green-600 text-white py-2 rounded-md hover:bg-green-700">Submit</button>
      <button id="ref-code-cancel" class="mt-2 w-full bg-gray-600 text-white py-2 rounded-md hover:bg-gray-700">Cancel</button>
    </div>
  </div>

  <div id="status-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-lg p-6 w-full max-w-md">
      <div id="status-countdown" class="mb-4">
        <p class="text-gray-600">Confirming payment... Time remaining: <span id="status-timer-text">5:00</span></p>
        <div class="w-full h-2 bg-gray-200 rounded-full overflow-hidden">
          <div id="status-timer-bar" class="h-full bg-green-600 transition-all duration-1000" style="width: 100%;"></div>
        </div>
      </div>
      <p id="status-message" class="text-gray-600 mb-4"></p>
      <button id="status-retry" class="mt-2 w-full bg-blue-600 text-white py-2 rounded-md hover:bg-blue-700 hidden">Retry</button>
    </div>
  </div>

  <div id="download-progress-modal">
    <div id="download-progress-content">
      <h3 class="text-xl font-bold text-gray-900 mb-4">Downloading File</h3>
      <p id="download-progress-text" class="text-gray-600 mb-4">Starting download...</p>
      <div id="download-progress-bar">
        <div id="download-progress-fill"></div>
      </div>
      <p id="download-error"></p>
    </div>
  </div>

  <div id="static-page-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-lg p-6 max-w-2xl w-full relative max-h-[80vh] overflow-y-auto">
      <button id="static-page-close" class="absolute top-4 right-4 text-gray-500 hover:text-gray-700">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
        </svg>
      </button>
      <h3 id="static-page-title" class="text-2xl font-bold text-gray-900 mb-4"></h3>
      <div id="static-page-content" class="prose"></div>
    </div>
  </div>

  <script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script>
  <script>
    const WHATSAPP_REDIRECT = 'https://wa.link/j8hx47';
    const BASE_URL = 'https://bot-delivery-system-qlx4j.ondigitalocean.app';
    let products = [];
    let categories = [];
    let settings = {};
    let staticPages = [];
    let exchangeRate = null;
    let allowInAppBrowser = false;
    const TEST_MODE = new URLSearchParams(window.location.search).get('test') === 'true';

    async function fetchWithTimeout(url, options = {}, timeout = 15000) {
      const controller = new AbortController();
      const id = setTimeout(() => controller.abort(), timeout);
      const headers = options.headers || {};
      if (options.method === 'GET') {
        delete headers['Content-Type'];
      }
      try {
        const response = await fetch(url, { 
          ...options, 
          signal: controller.signal,
          headers
        });
        clearTimeout(id);
        return response;
      } catch (error) {
        clearTimeout(id);
        throw error;
      }
    }

    async function getExchangeRate() {
      if (exchangeRate) return exchangeRate;
      try {
        const response = await fetchWithTimeout('https://api.exchangerate-api.com/v4/latest/USD', {}, 5000);
        const data = await response.json();
        exchangeRate = data.rates.KES || settings.fallbackRate || 130;
        console.log('Exchange rate fetched:', exchangeRate);
      } catch (error) {
        console.error('Error fetching exchange rate:', error.message);
        exchangeRate = settings.fallbackRate || 130;
      }
      return exchangeRate;
    }

    async function fetchData() {
      try {
        const response = await fetchWithTimeout(`${BASE_URL}/api/data`, { credentials: 'include' }, 15000);
        if (!response.ok) {
          throw new Error(`HTTP error! Status: ${response.status}, StatusText: ${response.statusText}`);
        }
        const data = await response.json();
        products = data.products.filter(p => !p.isArchived);
        categories = data.categories;
        settings = data.settings;
        staticPages = data.staticPages;
        console.log('Data fetched successfully:', { products, categories, settings, staticPages });
        return true;
      } catch (error) {
        console.error('Error fetching data:', error.message);
        document.getElementById('loading-message').innerHTML = `Failed to load bots. Please try again later or contact support at <a href="mailto:${settings.supportEmail || 'kaylie254.business@gmail.com'}" class="underline text-green-600">${settings.supportEmail || 'kaylie254.business@gmail.com'}</a>. (Error: ${error.message})`;
        return false;
      }
    }

    async function fetchModalContent() {
      const paymentModalContent = staticPages.find(page => page.slug === '/payment-modal');
      const refCodeModalContent = staticPages.find(page => page.slug === '/ref-code-modal');

      if (typeof sanitizeHtml !== 'function') {
        console.error('sanitizeHtml is not available. Skipping modal content rendering.');
        return;
      }
      if (typeof marked !== 'function') {
        console.error('marked is not available. Skipping modal content rendering.');
        return;
      }

      if (paymentModalContent && typeof paymentModalContent.content === 'string') {
        const paymentModalDiv = document.getElementById('payment-modal').querySelector('.bg-white');
        paymentModalDiv.innerHTML = sanitizeHtml(marked(paymentModalContent.content));
      }
      if (refCodeModalContent && typeof refCodeModalContent.content === 'string') {
        const refCodeModalDiv = document.getElementById('ref-code-modal').querySelector('.bg-white');
        refCodeModalDiv.innerHTML = sanitizeHtml(marked(refCodeModalContent.content));
      }
    }

    function renderNavLinks() {
      const navLinks = document.getElementById('nav-links');
      const mobileNavLinks = document.getElementById('mobile-nav-links');
      navLinks.innerHTML = `<a href="#" data-category="all" class="nav-link border-b-2 border-green-500 text-gray-900 px-1 pt-1 text-sm font-medium">Home</a>`;
      mobileNavLinks.innerHTML = `<a href="#" data-category="all" class="nav-link text-gray-900 text-sm font-medium">Home</a>`;
      categories.forEach(cat => {
        navLinks.innerHTML += `<a href="#" data-category="${cat}" class="nav-link text-gray-500 hover:text-gray-900 px-1 pt-1 text-sm font-medium">${cat}</a>`;
        mobileNavLinks.innerHTML += `<a href="#" data-category="${cat}" class="nav-link text-gray-500 hover:text-gray-900 text-sm font-medium">${cat}</a>`;
      });

      document.querySelectorAll('.nav-link').forEach(link => {
        link.addEventListener('click', e => {
          e.preventDefault();
          const category = link.dataset.category;
          filterProducts(category);
          document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('border-b-2', 'border-green-500', 'text-gray-900'));
          link.classList.add('border-b-2', 'border-green-500', 'text-gray-900');
          document.getElementById('mobile-menu').classList.remove('open');
        });
      });
    }

    function formatDescription(desc) {
      const lines = desc.split('\n').filter(line => line.trim() !== '');
      let html = '';
      let inList = false;

      lines.forEach(line => {
        line = line.trim();
        if (line.startsWith('âœ…') || line.startsWith('ðŸš€') || line.startsWith('ðŸ§ ')) {
          if (!inList) {
            html += '<ul>';
            inList = true;
          }
          const content = line.replace(/^(âœ…|ðŸš€|ðŸ§ )\s*/, '');
          html += `<li>${content}</li>`;
        } else {
          if (inList) {
            html += '</ul>';
            inList = false;
          }
          html += `<p>${line}</p>`;
        }
      });

      if (inList) {
        html += '</ul>';
      }

      return html;
    }

    async function renderProducts(category = 'all', search = '') {
      const grid = document.getElementById('product-grid');
      const loadingMessage = document.getElementById('loading-message');
      if (loadingMessage) {
        loadingMessage.classList.add('hidden');
      } else {
        console.warn('Loading message element not found.');
      }
      grid.innerHTML = '';
      let filteredProducts = products;
      if (category !== 'all') {
        filteredProducts = products.filter(p => p.category === category);
      }
      if (search) {
        const searchTerm = search.toLowerCase();
        filteredProducts = filteredProducts.filter(p => p.name.toLowerCase().includes(searchTerm) || p.desc.toLowerCase().includes(searchTerm));
      }
      if (!filteredProducts.length) {
        grid.innerHTML = '<p class="text-center col-span-full text-gray-600">No products found.</p>';
        return;
      }
      filteredProducts.forEach(product => {
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = product.desc;
        const plainText = tempDiv.textContent || tempDiv.innerText || '';
        const excerpt = plainText.length > 250 ? plainText.substring(0, 250).trim() + '...' : plainText;

        const card = document.createElement('div');
        card.className = 'bg-white rounded-xl shadow-lg hover:shadow-xl transition-all duration-300 overflow-hidden h-full flex flex-col';
        card.innerHTML = `
          <div class="relative">
            <div class="product-image-container">
              <img src="${product.img}" alt="${product.name}" class="thumbnail-image object-cover">
            </div>
            ${product.isNew ? '<span class="new-badge">NEW</span>' : ''}
          </div>
          <div class="p-6 flex-1">
            <h3 class="text-lg font-semibold text-gray-900 line-clamp-2">${product.name}</h3>
            <p class="mt-2 text-gray-600 text-sm line-clamp-3" style="color: inherit;">${excerpt.replace(/(https?:\/\/[^\s]+)/g, '<a href="$1" style="color: blue; text-decoration: underline;" target="_blank">$1</a>')}</p>
            <p class="mt-2 text-green-600 font-bold">${product.price.toFixed(2)} USD</p>
            <p class="mt-1 text-gray-500 text-sm item-hidden">Item: ${product.item}</p>
            <button class="view-details mt-4 w-full bg-green-600 text-white py-2 rounded-md hover:bg-green-700 transition-colors" data-item="${product.item}">View Details</button>
          </div>
        `;
        grid.appendChild(card);
      });

      document.querySelectorAll('.view-details').forEach(btn => {
        btn.addEventListener('click', async () => {
          const item = btn.dataset.item;
          const product = products.find(p => p.item === item);
          const rate = await getExchangeRate();
          const kesPrice = (product.price * rate).toFixed(2);

          document.getElementById('details-thumbnail').src = product.img;
          document.getElementById('details-name').textContent = product.name;
          document.getElementById('details-item-name').textContent = product.item;

          const descContainer = document.getElementById('details-desc');
          let cleanedDesc = product.desc
            .replace(/<p>\s*<\/p>/g, '')
            .replace(/<p>\s*<br\s*\/?>\s*<\/p>/g, '')
            .replace(/<span class="ql-ui"[^>]*><\/span>/g, '')
            .trim();

          cleanedDesc = cleanedDesc.replace(/<h(\d)>/g, (match, level) => `<h${level} style="font-size: ${20 - (level - 1) * 4}px; margin-bottom: 0.75rem;">`)
                                  .replace(/<\/h\d>/g, '</h$1>');

          descContainer.innerHTML = cleanedDesc || '<p>No description available.</p>';

          const paragraphs = descContainer.querySelectorAll('p');
          paragraphs.forEach(p => {
            p.style.marginBottom = '1rem';
            p.style.lineHeight = '1.6';
            p.style.wordBreak = 'break-word';
          });

          const headers = descContainer.querySelectorAll('h1, h2, h3');
          headers.forEach(h => {
            h.style.fontWeight = '600';
            h.style.marginBottom = '0.75rem';
          });

          const lists = descContainer.querySelectorAll('ul, ol');
          lists.forEach(list => {
            list.style.marginBottom = '1rem';
            list.style.paddingLeft = '1.5rem';
            list.style.listStyleType = 'none';
          });

          const listItems = descContainer.querySelectorAll('li');
          listItems.forEach(li => {
            li.style.marginBottom = '0.5rem';
            const indentLevel = li.className.match(/ql-indent-(\d+)/);
            if (indentLevel) {
              li.style.marginLeft = `${parseInt(indentLevel[1]) * 1.5}rem`;
            }
            li.style.position = 'relative';
            li.style.paddingLeft = '1.5rem';
          });

          const boldText = descContainer.querySelectorAll('strong, b');
          boldText.forEach(b => {
            b.style.fontWeight = 'bold';
          });

          const italicText = descContainer.querySelectorAll('em, i');
          italicText.forEach(i => {
            i.style.fontStyle = 'italic';
          });

          const underlineText = descContainer.querySelectorAll('u');
          underlineText.forEach(u => {
            u.style.textDecoration = 'underline';
          });

          const links = descContainer.querySelectorAll('a');
          links.forEach(link => {
            link.style.color = 'blue';
            link.style.textDecoration = 'underline';
            link.setAttribute('target', '_blank');
          });

          const blockquotes = descContainer.querySelectorAll('blockquote');
          blockquotes.forEach(bq => {
            bq.style.borderLeft = '4px solid #ccc';
            bq.style.paddingLeft = '1rem';
            bq.style.margin = '1rem 0';
            bq.style.color = '#666';
          });

          const codeElements = descContainer.querySelectorAll('code');
          codeElements.forEach(code => {
            code.style.backgroundColor = '#f4f4f4';
            code.style.padding = '2px 4px';
            code.style.borderRadius = '4px';
            code.style.fontFamily = 'monospace';
          });

          const images = descContainer.querySelectorAll('img');
          images.forEach(img => {
            img.style.maxWidth = '100%';
            img.style.height = 'auto';
            img.style.marginBottom = '1rem';
            img.style.borderRadius = '8px';
          });

          const embedDiv = document.getElementById('details-embed');
          if (product.embed) {
            embedDiv.innerHTML = `
              <div class="embed-container">
                <iframe src="${product.embed}" frameborder="0" allowfullscreen></iframe>
              </div>
            `;
          } else {
            embedDiv.innerHTML = '';
          }

          const modal = document.getElementById('details-modal');
          modal.classList.remove('hidden');
          document.body.classList.add('popup-active');

          const buyNowBtn = document.getElementById('details-buy-now');
          buyNowBtn.dataset.item = item;
          buyNowBtn.dataset.kesPrice = kesPrice;
          buyNowBtn.onclick = () => {
            showPaymentChoiceModal(product, kesPrice);
          };

          const testPayBtn = document.getElementById('details-test-pay');
          testPayBtn.classList.toggle('hidden', !TEST_MODE);
          testPayBtn.dataset.item = item;
          testPayBtn.dataset.kesPrice = kesPrice;
          testPayBtn.onclick = () => {
            modal.classList.add('hidden');
            document.body.classList.remove('popup-active');
            initiateTestPayment(product, product.price);
          };

          document.getElementById('details-close').onclick = () => {
            modal.classList.add('hidden');
            document.body.classList.remove('popup-active');
          };
        });
      });
    }
    
    function debounce(func, wait) {
      let timeout;
      return function (...args) {
        clearTimeout(timeout);
        timeout = setTimeout(() => func.apply(this, args), wait);
      };
    }

    const debouncedFilterProducts = debounce((category) => {
      const search = document.getElementById('search-bar')?.value || document.getElementById('mobile-search-bar')?.value || '';
      renderProducts(category, search);
    }, 300);

    function filterProducts(category) {
      debouncedFilterProducts(category);
    }

    function showPaymentChoiceModal(product, kesPrice) {
      const choiceModal = document.getElementById('payment-choice-modal');
      document.getElementById('payment-choice-product-name').textContent = `Product: ${product.name}`;
      document.getElementById('payment-choice-amount').textContent = `Amount: ${kesPrice} KES`;
      choiceModal.classList.remove('hidden');
      document.body.classList.add('popup-active');

      const manualMpesaChoiceBtn = document.getElementById('manual-mpesa-choice');
      const payheroChoiceBtn = document.getElementById('payhero-choice');
      const nowPaymentsChoiceBtn = document.getElementById('nowpayments-choice');
      const cancelBtn = document.getElementById('payment-choice-cancel');

      manualMpesaChoiceBtn.onclick = () => {
        choiceModal.classList.add('hidden');
        document.body.classList.remove('popup-active');
        showPaymentModal(product, kesPrice);
      };

      payheroChoiceBtn.onclick = () => {
        choiceModal.classList.add('hidden');
        document.body.classList.remove('popup-active');
        showPayHeroModal(product, kesPrice);
      };

      nowPaymentsChoiceBtn.onclick = async () => {
        // Add spinner and disable the button
        const originalButtonText = nowPaymentsChoiceBtn.innerHTML;
        nowPaymentsChoiceBtn.innerHTML = '<svg class="animate-spin h-5 w-5 mr-2 inline-block" viewBox="0 0 24 24" fill="none" stroke="currentColor"><circle cx="12" cy="12" r="10" stroke-width="4" class="opacity-25"></circle><path d="M4 12a8 8 0 018-8" stroke-width="4" class="opacity-75"></path></svg>Loading...';
        nowPaymentsChoiceBtn.disabled = true;
        manualMpesaChoiceBtn.disabled = true;
        payheroChoiceBtn.disabled = true;
        cancelBtn.disabled = true;

        try {
          // Pre-fetch currencies here or ensure showNowPaymentsModal does it and handles UI updates
          // For now, directly call showNowPaymentsModal which fetches currencies.
          // The key is that showNowPaymentsModal will now handle its own loading state for currencies.
          await showNowPaymentsModal(product, product.price); // Pass USD price
          // Only hide choiceModal if showNowPaymentsModal successfully displayed the next modal
          // This logic is now effectively handled inside showNowPaymentsModal if it takes over display
          choiceModal.classList.add('hidden');
          // popup-active will be managed by showNowPaymentsModal
        } catch (error) {
          // If showNowPaymentsModal itself throws an error (e.g., initial setup before currency fetch)
          console.error("Error preparing NOWPayments modal:", error);
          // Potentially show an error on the choice modal or an alert
          alert("Could not load cryptocurrency payment option. Please try again or select another method.");
        } finally {
          // Re-enable buttons on the choice modal if it's still shown (e.g. if NOWPayments modal failed to open)
          // However, if NOWPayments modal opened, it's responsible for its own lifecycle.
          // This re-enabling should ideally only happen if an error prevented NOWPayments modal from opening.
          if (!document.getElementById('nowpayments-modal').classList.contains('hidden')) {
            // If nowpayments modal is visible, do nothing here, it handles its state
          } else {
            nowPaymentsChoiceBtn.innerHTML = originalButtonText;
            nowPaymentsChoiceBtn.disabled = false;
            manualMpesaChoiceBtn.disabled = false;
            payheroChoiceBtn.disabled = false;
            cancelBtn.disabled = false;
          }
        }
      };

      cancelBtn.onclick = () => {
        choiceModal.classList.add('hidden');
        document.body.classList.remove('popup-active');
      };
    }

    async function showNowPaymentsModal(product, usdPrice) {
      const modal = document.getElementById('nowpayments-modal');
      document.getElementById('nowpayments-title').textContent = `Pay for ${product.name}`;
      document.getElementById('nowpayments-product-name').textContent = `Product: ${product.name}`;
      document.getElementById('nowpayments-amount-usd').textContent = `Amount: ${usdPrice.toFixed(2)} USD`;

      const emailInput = document.getElementById('nowpayments-email');
      const currencySelect = document.getElementById('nowpayments-currency');
      const proceedBtn = document.getElementById('nowpayments-proceed');
      const cancelBtn = document.getElementById('nowpayments-cancel');
      const paymentDetailsDiv = document.getElementById('nowpayments-payment-details');
      const statusMessageEl = document.getElementById('nowpayments-status-message');
      const currencySearchInput = document.getElementById('nowpayments-currency-search');
      const timerDisplay = document.getElementById('nowpayments-timer');
      const paymentInfoSection = document.getElementById('nowpayments-payment-info'); // The new div for payment details + timer

      emailInput.value = '';
      paymentInfoSection.classList.add('hidden');
      statusMessageEl.textContent = '';
      proceedBtn.disabled = false;
      proceedBtn.innerHTML = 'Proceed to Payment'; // Reset button text/spinner
      currencySearchInput.value = '';
      timerDisplay.textContent = '';
      if (window.nowPaymentsTimerIntervalId) {
        clearInterval(window.nowPaymentsTimerIntervalId);
        window.nowPaymentsTimerIntervalId = null;
      }


      // Enable inputs initially
      emailInput.disabled = false;
      currencySelect.disabled = false;
      currencySearchInput.disabled = false;

      // Fetch available currencies for NOWPayments
      currencySelect.innerHTML = '<option value="">Loading currencies...</option>';
      proceedBtn.disabled = true;
      // Spinner for the main proceed button of NOWPayments modal, not the choice modal button
      const nowPaymentsProceedBtnSpinner = '<svg class="animate-spin h-5 w-5 mr-3 inline-block" viewBox="0 0 24 24" fill="none" stroke="currentColor"><circle cx="12" cy="12" r="10" stroke-width="4" class="opacity-25"></circle><path d="M4 12a8 8 0 018-8" stroke-width="4" class="opacity-75"></path></svg>';
      proceedBtn.innerHTML = `${nowPaymentsProceedBtnSpinner}Loading Currencies...`;


      modal.classList.remove('hidden'); // Show modal immediately
      document.body.classList.add('popup-active');
      // Ensure modal is scrollable
      const nowPaymentsModalContent = modal.querySelector('.bg-white');
      nowPaymentsModalContent.style.maxHeight = '90vh';
      nowPaymentsModalContent.style.overflowY = 'auto';

      try {
        const response = await fetchWithTimeout(`${BASE_URL}/api/nowpayments/currencies`, {}, 20000); // Increased timeout for currency fetching
        if (!response.ok) {
            const errorData = await response.json().catch(() => ({error: `HTTP error ${response.status}`}));
            throw new Error(errorData.error || 'Failed to load currencies from server.');
        }
        const data = await response.json();
        if (data.success && data.currencies) {
          populateCurrencyDropdown(data.currencies);
          proceedBtn.disabled = false;
          proceedBtn.innerHTML = 'Proceed to Payment';
        } else {
          currencySelect.innerHTML = '<option value="">Error: Could not load currencies.</option>';
          statusMessageEl.textContent = data.error || 'Error loading currencies.';
          statusMessageEl.style.color = 'red';
          proceedBtn.innerHTML = 'Proceed to Payment'; // Re-enable but show error
          proceedBtn.disabled = true; // Keep disabled if currencies failed to load
        }
      } catch (error) {
        console.error('Error fetching NOWPayments currencies (showNowPaymentsModal):', error.message, error.name);
        currencySelect.innerHTML = '<option value="">Error loading currencies. Please try again.</option>';
        statusMessageEl.textContent = `Error loading currencies: ${error.message}. Please close and try again.`;
        statusMessageEl.style.color = 'red';
        proceedBtn.disabled = true;
        proceedBtn.innerHTML = 'Unavailable (Currency Load Failed)';
      }

      currencySearchInput.oninput = () => {
          const searchTerm = currencySearchInput.value.toLowerCase();
          const options = currencySelect.options;
          for (let i = 0; i < options.length; i++) {
              if (options[i].value === "") continue; // Skip "Select a currency" or loading messages
              const optionText = options[i].text.toLowerCase();
              options[i].style.display = optionText.includes(searchTerm) ? '' : 'none';
          }
      };


      // The following block was redundant and caused the error.
      // modal.classList.remove('hidden');
      // document.body.classList.add('popup-active');
      // // Ensure modal is scrollable
      // const nowPaymentsModalContent = modal.querySelector('.bg-white');
      // nowPaymentsModalContent.style.maxHeight = '90vh';
      // nowPaymentsModalContent.style.overflowY = 'auto';


      proceedBtn.onclick = async () => {
        const email = emailInput.value.trim();
        const selectedCurrency = currencySelect.value;

        // Clear previous error messages
        statusMessageEl.textContent = '';
        statusMessageEl.style.color = 'inherit'; // Reset color

        if (!email || !/^\S+@\S+\.\S+$/.test(email)) {
          statusMessageEl.textContent = !email ? 'Email is required.' : 'Invalid email format.';
          statusMessageEl.style.color = 'red';
          emailInput.focus(); // Focus on email input for quick correction
          return;
        }
        if (!selectedCurrency) {
          statusMessageEl.textContent = 'Please select a cryptocurrency.';
          statusMessageEl.style.color = 'red';
          currencySelect.focus(); // Focus on currency select
          return;
        }

        proceedBtn.disabled = true;
        proceedBtn.innerHTML = '<svg class="animate-spin h-5 w-5 mr-3 inline-block" viewBox="0 0 24 24">...</svg>Creating Payment...';
        statusMessageEl.textContent = 'Creating payment, please wait...';
        statusMessageEl.style.color = 'inherit';
        emailInput.disabled = true;
        currencySelect.disabled = true;
        currencySearchInput.disabled = true;


        try {
          await initiateNowPaymentsPayment(product, email, selectedCurrency);
        } catch (error) {
            console.error('Error initiating NOWPayments payment:', error);
            statusMessageEl.textContent = `Error: ${error.message || 'Could not create payment.'}`;
            statusMessageEl.style.color = 'red';
            proceedBtn.disabled = false;
            proceedBtn.innerHTML = 'Proceed to Payment';
            emailInput.disabled = false;
            currencySelect.disabled = false;
            currencySearchInput.disabled = false;
        }
      };

      cancelBtn.onclick = () => {
        const paymentInfoSection = document.getElementById('nowpayments-payment-info');
        if (!paymentInfoSection.classList.contains('hidden')) { // Payment process active
            if (confirm('You have a pending payment. Are you sure you want to cancel and start over?')) {
                modal.classList.add('hidden');
                document.body.classList.remove('popup-active');
                if (window.nowPaymentsPollIntervalId) {
                    clearInterval(window.nowPaymentsPollIntervalId);
                    window.nowPaymentsPollIntervalId = null;
                }
                if (window.nowPaymentsTimerIntervalId) {
                    clearInterval(window.nowPaymentsTimerIntervalId);
                    window.nowPaymentsTimerIntervalId = null;
                }
            }
        } else {
            modal.classList.add('hidden');
            document.body.classList.remove('popup-active');
        }
      };
    }

    function populateCurrencyDropdown(currencies) {
        const currencySelect = document.getElementById('nowpayments-currency');
        currencySelect.innerHTML = '<option value="">Select a currency</option>';
        currencies.sort((a, b) => (a.name || "").localeCompare(b.name || "")).forEach(currency => {
            const option = document.createElement('option');
            option.value = currency.code;
            let displayText = `${currency.name} (${currency.code.toUpperCase()})`;
            if (currency.min_payment_amount) {
                displayText += ` - Min: ${parseFloat(currency.min_payment_amount).toFixed(8)} ${currency.code.toUpperCase()}`;
            }
            option.textContent = displayText;
            currencySelect.appendChild(option);
        });
    }


    async function initiateNowPaymentsPayment(product, email, currency) {
        const paymentInfoSection = document.getElementById('nowpayments-payment-info');
        const statusMessageEl = document.getElementById('nowpayments-status-message');
        const proceedBtn = document.getElementById('nowpayments-proceed');
        const timerDisplay = document.getElementById('nowpayments-timer');
        const paymentDetailsContent = document.getElementById('nowpayments-payment-details-content'); // Target the content div

        // Show an SVG spinner within the proceed button (replace ... with actual SVG path)
        proceedBtn.innerHTML = '<svg class="animate-spin h-5 w-5 mr-3 inline-block" viewBox="0 0 24 24">...</svg>Creating Payment...';


        const response = await fetchWithTimeout(`${BASE_URL}/api/nowpayments/create-payment`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                item: product.item,
                price_amount: product.price, // USD price
                price_currency: 'usd',
                pay_currency: currency,
                email: email,
                order_description: product.name,
            }),
            credentials: 'include'
        });

        const data = await response.json();

        if (!response.ok || !data.success) {
            const emailInput = document.getElementById('nowpayments-email');
            const currencySelect = document.getElementById('nowpayments-currency');
            const currencySearchInput = document.getElementById('nowpayments-currency-search');

            // Restore button and inputs if creation fails
            proceedBtn.disabled = false;
            proceedBtn.innerHTML = 'Proceed to Payment';
            emailInput.disabled = false;
            currencySelect.disabled = false;
            currencySearchInput.disabled = false;

            let errorMessage = data.error || 'Failed to create NOWPayments payment.';
            if (errorMessage.includes("is below the minimum required")) {
                // Example: "The amount for Under 7 Bollinger Bands BOT (6.99 USD) is below the minimum required for USDTTRC20. Minimum: 9.821729 USDTTRC20. Your order's equivalent: ~6.97163 USDTTRC20. Please increase the quantity or contact support if prices seem incorrect."
                const productNameMatch = errorMessage.match(/The amount for (.*?) \(/);
                const originalPriceMatch = errorMessage.match(/\(([\d.]+ USD)\) is below/);
                const cryptoCurrencyMatch = errorMessage.match(/minimum required for (\w+)\./);
                const minimumAmountMatch = errorMessage.match(/Minimum: ([\d.]+) (\w+)\./);

                if (productNameMatch && originalPriceMatch && cryptoCurrencyMatch && minimumAmountMatch && minimumAmountMatch[2] === cryptoCurrencyMatch[1]) {
                    const productName = productNameMatch[1];
                    const originalPrice = originalPriceMatch[1];
                    const cryptoCurrency = cryptoCurrencyMatch[1];
                    const minimumAmount = minimumAmountMatch[1];
                    errorMessage = `Amount for ${productName} (${originalPrice}) is too low for ${cryptoCurrency}. Minimum: ${minimumAmount} ${cryptoCurrency}. Please choose another crypto or increase quantity.`;
                } else {
                    // Fallback if parsing fails, use a slightly modified generic message
                    errorMessage = `The selected amount is below the minimum for the chosen cryptocurrency. Please choose another crypto or increase quantity. (Details: ${errorMessage})`;
                }
            }
            throw new Error(errorMessage);
        }

        // Update UI with payment details
        document.getElementById('nowpayments-pay-amount').textContent = data.payment.pay_amount;
        document.getElementById('nowpayments-pay-currency').textContent = data.payment.pay_currency.toUpperCase();
        document.getElementById('nowpayments-pay-address').textContent = data.payment.pay_address;

        const copyAddressBtn = document.getElementById('nowpayments-copy-address');
        copyAddressBtn.onclick = () => {
            const addressToCopy = data.payment.pay_address;
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(addressToCopy).then(() => {
                    copyAddressBtn.innerHTML = '<svg class="w-4 h-4 mr-1 inline-block" fill="currentColor" viewBox="0 0 20 20"><path d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z"></path></svg>Copied!';
                    setTimeout(() => copyAddressBtn.innerHTML = 'Copy Address', 2000);
                }).catch(err => {
                    console.warn('Async clipboard copy failed:', err);
                    fallbackCopyTextToClipboard(addressToCopy, copyAddressBtn);
                });
            } else {
                fallbackCopyTextToClipboard(addressToCopy, copyAddressBtn);
            }
        };

        paymentInfoSection.classList.remove('hidden');
        statusMessageEl.textContent = 'Waiting for payment. Please send the funds to the address shown.';
        proceedBtn.innerHTML = 'Payment Initiated'; // Keep button disabled (it's already disabled)

        // Start 20-minute countdown timer
        let timeLeft = 20 * 60;
        if (window.nowPaymentsTimerIntervalId) clearInterval(window.nowPaymentsTimerIntervalId); // Clear existing timer
        window.nowPaymentsTimerIntervalId = setInterval(() => {
            if (timeLeft <= 0) {
                clearInterval(window.nowPaymentsTimerIntervalId);
                timerDisplay.textContent = 'Expired';
                statusMessageEl.textContent = 'The payment window has expired. Please try creating a new payment.';
                statusMessageEl.style.color = 'orange';
                // Re-enable inputs for new attempt
                proceedBtn.disabled = false;
                proceedBtn.innerHTML = 'Proceed to Payment';
                document.getElementById('nowpayments-email').disabled = false;
                document.getElementById('nowpayments-currency').disabled = false;
                document.getElementById('nowpayments-currency-search').disabled = false;
                paymentInfoSection.classList.add('hidden'); // Hide old payment details
                if(window.nowPaymentsPollIntervalId) clearInterval(window.nowPaymentsPollIntervalId); // Stop polling
                return;
            }
            const minutes = Math.floor(timeLeft / 60);
            const seconds = timeLeft % 60;
            timerDisplay.textContent = `Time left: ${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
            timeLeft--;
        }, 1000);


        // Start polling for payment status
        handleNowPaymentsStatus(data.orderId, product);
    }

    function fallbackCopyTextToClipboard(text, buttonElement) {
        const textArea = document.createElement("textarea");
        textArea.value = text;
        textArea.style.position = "fixed"; // Prevent scrolling to bottom of page in MS Edge.
        document.body.appendChild(textArea);
        textArea.focus();
        textArea.select();
        try {
            const successful = document.execCommand('copy');
            if (successful) {
                buttonElement.innerHTML = '<svg class="w-4 h-4 mr-1 inline-block" fill="currentColor" viewBox="0 0 20 20"><path d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z"></path></svg>Copied!';
            } else {
                buttonElement.textContent = 'Copy Failed';
            }
        } catch (err) {
            console.error('Fallback copy failed', err);
            buttonElement.textContent = 'Copy Failed';
        }
        document.body.removeChild(textArea);
        setTimeout(() => buttonElement.innerHTML = 'Copy Address', 2000);
    }


    function handleNowPaymentsStatus(orderId, product) {
        const statusMessageEl = document.getElementById('nowpayments-status-message');
        const modal = document.getElementById('nowpayments-modal');
        const proceedBtn = document.getElementById('nowpayments-proceed');
        const paymentInfoSection = document.getElementById('nowpayments-payment-info');


        if (window.nowPaymentsPollIntervalId) {
            clearInterval(window.nowPaymentsPollIntervalId);
        }

        let pollCount = 0;
        const maxPolls = (20 * 60) / 5; // Poll for 20 minutes (matches timer), every 5 seconds

        window.nowPaymentsPollIntervalId = setInterval(async () => {
            pollCount++;
            if (pollCount > maxPolls && window.nowPaymentsTimerIntervalId) { // Stop if timer is still running but polling maxed out (should not happen if timer clears polling)
                // This is a fallback, timer expiration should handle UI reset
                console.warn("Polling maxed out before timer expired or payment completed.");
                // No UI change here, let timer handle it or successful payment handle it.
                return;
            }
            if (!window.nowPaymentsTimerIntervalId && !['finished', 'confirmed_nowpayments'].includes(statusMessageEl.textContent.toLowerCase()) ) {
                // If timer expired and payment not successful, stop polling.
                clearInterval(window.nowPaymentsPollIntervalId);
                window.nowPaymentsPollIntervalId = null;
                return;
            }


            try {
                const response = await fetchWithTimeout(`${BASE_URL}/api/nowpayments/payment-status/${orderId}`, {credentials: 'include'});
                const data = await response.json();

                if (!response.ok) {
                    statusMessageEl.textContent = `Error checking status: ${data.error || 'Unknown error'}`;
                    statusMessageEl.style.color = 'red';
                    // Potentially stop polling on certain errors if needed
                    return;
                }

                statusMessageEl.textContent = `Status: ${data.payment_status}. ${data.message || ''}`;

                if (data.payment_status === 'finished' || data.status === 'confirmed_nowpayments') {
                    if(window.nowPaymentsTimerIntervalId) clearInterval(window.nowPaymentsTimerIntervalId);
                    window.nowPaymentsTimerIntervalId = null;
                    document.getElementById('nowpayments-timer').textContent = 'Payment Complete!';

                    clearInterval(window.nowPaymentsPollIntervalId);
                    window.nowPaymentsPollIntervalId = null;
                    statusMessageEl.textContent = 'Payment successful! Preparing your download...';
                    statusMessageEl.style.color = 'green';
                    if (data.downloadLink) {
                        await downloadFile(data.downloadLink, product.name);
                        setTimeout(() => {
                            modal.classList.add('hidden');
                            document.body.classList.remove('popup-active');
                        }, 2000);
                    } else {
                         statusMessageEl.textContent = 'Payment confirmed, but download link missing. Contact support.';
                         console.error("NOWPayments success, but no download link from server status update.");
                    }
                } else if (['failed', 'refunded', 'expired'].includes(data.payment_status) || (data.status && data.status.startsWith('failed_nowpayments_'))) {
                    if(window.nowPaymentsTimerIntervalId) clearInterval(window.nowPaymentsTimerIntervalId);
                     window.nowPaymentsTimerIntervalId = null;
                    document.getElementById('nowpayments-timer').textContent = `Status: ${data.payment_status}`;

                    clearInterval(window.nowPaymentsPollIntervalId);
                    window.nowPaymentsPollIntervalId = null;
                    statusMessageEl.textContent = `Payment ${data.payment_status}. Please try again or contact support.`;
                    statusMessageEl.style.color = 'red';

                    proceedBtn.disabled = false;
                    proceedBtn.innerHTML = 'Proceed to Payment';
                    document.getElementById('nowpayments-email').disabled = false;
                    document.getElementById('nowpayments-currency').disabled = false;
                    document.getElementById('nowpayments-currency-search').disabled = false;
                    paymentInfoSection.classList.add('hidden'); // Hide old payment details
                } else {
                    // Continue polling for statuses like 'waiting', 'confirming', 'sending'
                    statusMessageEl.style.color = 'inherit';
                }
            } catch (error) {
                console.error('Error polling NOWPayments status:', error);
                statusMessageEl.textContent = 'Error checking payment status. Please wait or contact support.';
                statusMessageEl.style.color = 'red';
                // Potentially stop polling on repeated network errors if they persist
            }
        }, 5000); // Poll every 5 seconds
    }


    async function showPaymentModal(product, kesPrice) {
      const modal = document.getElementById('payment-modal');
      document.getElementById('payment-title').textContent = `Pay for ${product.name}`;
      document.getElementById('mpesa-till-number').textContent = settings.mpesaTill || '4933614';
      document.getElementById('payment-amount').textContent = `Amount: ${kesPrice} KES`;
      modal.classList.remove('hidden');
      document.body.classList.add('popup-active');

      let timeLeft = 10 * 60;
      const timerText = document.getElementById('timer-text');
      const timerBar = document.getElementById('timer-bar');

      const countdown = setInterval(() => {
        if (timeLeft <= 0) {
          clearInterval(countdown);
          modal.classList.add('hidden');
          document.body.classList.remove('popup-active');
          window.location.href = WHATSAPP_REDIRECT;
          return;
        }
        const minutes = Math.floor(timeLeft / 60);
        const seconds = timeLeft % 60;
        timerText.textContent = `${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
        const percentage = (timeLeft / (10 * 60)) * 100;
        timerBar.style.width = `${percentage}%`;
        timeLeft--;
      }, 1000);

      const copyTillBtn = document.getElementById('copy-till');
      copyTillBtn.onclick = () => {
        const tillNumber = document.getElementById('mpesa-till-number').textContent;
        navigator.clipboard.writeText(tillNumber).then(() => {
          copyTillBtn.textContent = 'Copied';
          setTimeout(() => {
            copyTillBtn.textContent = 'Copy Till';
          }, 2000);
        }).catch(err => {
          const textarea = document.createElement('textarea');
          textarea.value = tillNumber;
          document.body.appendChild(textarea);
          textarea.select();
          document.execCommand('copy');
          document.body.removeChild(textarea);
          copyTillBtn.textContent = 'Copied';
          setTimeout(() => {
            copyTillBtn.textContent = 'Copy Till';
          }, 2000);
        });
      };

      const confirmPaymentBtn = document.getElementById('confirm-payment');
      confirmPaymentBtn.onclick = () => {
        clearInterval(countdown);
        const expiry = new Date(Date.now() + 5 * 60 * 1000).toUTCString();
        document.cookie = `payment_${product.item}=initiated; expires=${expiry}; path=/`;
        localStorage.setItem(`payment_${product.item}_kesPrice`, kesPrice);
        modal.classList.add('hidden');
        document.body.classList.remove('popup-active');
        showRefCodeModal(product, kesPrice);
      };
      confirmPaymentBtn.dataset.item = product.item;
      confirmPaymentBtn.dataset.kesPrice = kesPrice;

      document.getElementById('payment-cancel').onclick = () => {
        clearInterval(countdown);
        modal.classList.add('hidden');
        document.body.classList.remove('popup-active');
      };
    }

    async function showPayHeroModal(product, kesPrice) {
      const modal = document.getElementById('payhero-modal');
      const amountDisplay = document.getElementById('payhero-amount-display');
      const customerNameInput = document.getElementById('payhero-customer-name');
      const phoneNumberInput = document.getElementById('payhero-phone-number');
      const payheroStatusMessage = document.getElementById('payhero-status-message');
      const closeButton = document.getElementById('payhero-close-button');
      const proceedButton = document.getElementById('payhero-proceed-button');

      // Ensure our local form inputs are visible
      customerNameInput.style.display = 'block';
      phoneNumberInput.style.display = 'block';
      const nameLabel = document.querySelector('label[for="payhero-customer-name"]');
      if (nameLabel) nameLabel.style.display = 'block';
      const phoneLabel = document.querySelector('label[for="payhero-phone-number"]');
      if (phoneLabel) phoneLabel.style.display = 'block';

      const roundedAmount = Math.round(parseFloat(kesPrice));
      amountDisplay.textContent = roundedAmount.toFixed(2);

      payheroStatusMessage.textContent = '';
      payheroStatusMessage.style.color = 'inherit';
      proceedButton.disabled = false;

      customerNameInput.value = '';
      phoneNumberInput.value = '';

      modal.style.display = 'flex';
      document.body.classList.add('popup-active');

      closeButton.onclick = () => {
        modal.style.display = 'none';
        document.body.classList.remove('popup-active');
      };

      proceedButton.onclick = async () => {
        const phone = phoneNumberInput.value.trim();
        const customerName = customerNameInput.value.trim() || "Valued Customer";

        if (!phone) {
          payheroStatusMessage.textContent = 'Please enter your Mpesa phone number.';
          payheroStatusMessage.style.color = 'red';
          return;
        }
        if (!/^(01|07|2541|2547)\d{8}$/.test(phone.replace(/^\+/, ''))) {
            payheroStatusMessage.textContent = 'Invalid Mpesa phone number. Use formats like 07xx..., 01xx..., 2547xx..., 2541xx...';
            payheroStatusMessage.style.color = 'red';
            return;
        }

        proceedButton.disabled = true;
        payheroStatusMessage.textContent = 'Initiating payment... Please wait.';
        payheroStatusMessage.style.color = 'inherit';

        try {
          const response = await fetchWithTimeout(`${BASE_URL}/api/initiate-server-stk-push`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              item: product.item,
              amount_kes: roundedAmount,
              phone: phone,
              customerName: customerName,
              used_exchange_rate: exchangeRate // Send the exchange rate used by client
            }),
            credentials: 'include'
          }, 20000);

          const data = await response.json();

          if (response.ok && data.success) {
            payheroStatusMessage.textContent = data.message || 'STK Push initiated. Check your phone to complete payment.';
            payheroStatusMessage.style.color = 'green';

            setTimeout(() => {
                modal.style.display = 'none';
                if (data.serverReference) {
                    showStatusModal(product, data.serverReference, 'Waiting for Mpesa payment confirmation via STK push...', true);
                } else {
                    payheroStatusMessage.textContent = 'Error: Missing transaction reference from server. Please contact support.';
                    payheroStatusMessage.style.color = 'red';
                    proceedButton.disabled = false;
                    document.body.classList.add('popup-active');
                }
            }, 2500);
          } else {
            const errorMsg = data.error || `Failed to initiate payment: ${response.statusText || response.status}`;
            console.error('Server STK Push Initiation Error:', errorMsg, data);
            payheroStatusMessage.textContent = `Error: ${errorMsg}. Please try again.`;
            payheroStatusMessage.style.color = 'red';
            proceedButton.disabled = false;
          }
        } catch (error) {
          console.error('Error initiating server STK push (fetch):', error.message, error);
          payheroStatusMessage.textContent = `Network or server error: ${error.message}. Please try again.`;
          payheroStatusMessage.style.color = 'red';
          proceedButton.disabled = false;
        }
      };
    }

    /*
    // Global event listener for PayHero Button SDK - No longer needed for server-side STK push
    window.addEventListener('message', async function(event) {
        if (event.data.paymentSuccess) {
            // ... old PayHero SDK success logic ...
        } else if (event.data.paymentSuccess === false) {
            // ... old PayHero SDK failure logic ...
        }
    });
    */

    async function initiateTestPayment(product, price) {
      try {
        const response = await fetchWithTimeout(`${BASE_URL}/deliver-bot`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            item: product.item,
            price: price,
            payment_method: 'test'
          }),
          credentials: 'include'
        }, 15000);

        const data = await response.json();
        if (response.ok && data.success && data.downloadLink) {
          await downloadFile(data.downloadLink, product.name);
        } else {
          throw new Error(data.error || 'Failed to initiate test payment');
        }
      } catch (error) {
        console.error('Error initiating test payment:', error.message);
        showStatusModal({ item: product.item }, null, `Test payment failed: ${error.message}. Contact support.`, false);
      }
    }

    function showRefCodeModal(product, kesPrice) {
      const modal = document.getElementById('ref-code-modal');
      modal.classList.remove('hidden');
      document.body.classList.add('popup-active');

      const refCodeInput = document.getElementById('ref-code-input');
      refCodeInput.value = localStorage.getItem(`payment_${product.item}_refCode`) || '';

      document.getElementById('submit-ref-code').onclick = async () => {
        const refCode = refCodeInput.value.trim();
        if (!refCode.match(/^[A-Z0-9]{8,12}$/)) {
          alert('Please enter a valid MPESA ref code (8-12 alphanumeric characters).');
          return;
        }

        try {
          const response = await fetchWithTimeout(`${BASE_URL}/api/submit-ref`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              item: product.item,
              refCode,
              amount: kesPrice,
              timestamp: new Date().toISOString()
            }),
            credentials: 'include'
          }, 15000);

          const data = await response.json();
          if (response.ok && data.success) {
            localStorage.setItem(`payment_${product.item}_refCode`, refCode);
            modal.classList.add('hidden');
            document.body.classList.remove('popup-active');
            await showStatusModal(product, refCode);
          } else {
            throw new Error(data.error || `Failed to submit ref code: ${response.status}`);
          }
        } catch (error) {
          console.error('Error submitting ref code:', error.message);
          alert(`Error submitting ref code: ${error.message}. Please try again or contact support at ${settings.supportEmail}.`);
        }
      };

      document.getElementById('ref-code-cancel').onclick = () => {
        modal.classList.add('hidden');
        document.body.classList.remove('popup-active');
      };
    }

    async function showStatusModal(product, refCode, initialMessage = 'Confirming payment...', showRetry = true) {
      const modal = document.getElementById('status-modal');
      const statusMessage = document.getElementById('status-message');
      const statusTimerText = document.getElementById('status-timer-text');
      const statusTimerBar = document.getElementById('status-timer-bar');
      const retryBtn = document.getElementById('status-retry');
      statusMessage.innerHTML = initialMessage;
      modal.classList.remove('hidden');
      document.body.classList.add('popup-active');
      retryBtn.classList.add('hidden');

      let timeLeft = 5 * 60; // 5 minutes timeout for the modal itself
      const pollInterval = 3; // Check status every 3 seconds
      let elapsedSinceLastPoll = 0; // Tracks time since last status poll
      let retryCount = 0;
      const maxRetries = 3;

      const countdown = setInterval(async () => {
        if (timeLeft <= 0) {
          clearInterval(countdown);
          statusMessage.innerHTML = `Confirmation timed out. <a href="${WHATSAPP_REDIRECT}" class="text-green-600 underline">Contact support.</a>`;
          if (showRetry && retryCount < maxRetries) {
            retryBtn.classList.remove('hidden');
            retryBtn.onclick = () => {
              retryCount++;
              modal.classList.add('hidden');
              document.body.classList.remove('popup-active');
              showStatusModal(product, refCode, 'Retrying confirmation...', showRetry);
            };
          } else {
            setTimeout(() => {
              modal.classList.add('hidden');
              document.body.classList.remove('popup-active');
              clearPaymentCookie(product.item);
              window.location.href = WHATSAPP_REDIRECT;
            }, 3000);
          }
          return;
        }

        const minutes = Math.floor(timeLeft / 60);
        const seconds = timeLeft % 60;
        statusTimerText.textContent = `${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
        const percentage = (timeLeft / (5 * 60)) * 100;
        statusTimerBar.style.width = `${percentage}%`;

        elapsedSinceLastPoll += 1;
        if (refCode && elapsedSinceLastPoll >= pollInterval) {
          elapsedSinceLastPoll = 0; // Reset counter for next poll interval
          try {
            const statusRes = await fetchWithTimeout(`${BASE_URL}/api/order-status/${product.item}/${refCode}`, {
              credentials: 'include',
              headers: { 'X-Debug-Source': 'Client-Polling' }
            }, 10000);
            const data = await statusRes.json();

            let currentStatusDisplay = `Polling status... (${data.status || 'Unknown'})`; // Default
            if (data.message) {
                currentStatusDisplay = data.message;
            }

            // More specific messages based on known statuses
            if (data.status === 'QUEUED' || data.status === 'pending_stk_push') {
                currentStatusDisplay = data.message || "STK push sent. Waiting for you to complete the transaction on your phone...";
            } else if (data.status === 'SUCCESS' || data.status === 'confirmed' || data.status === 'confirmed_server_stk') {
                if (!data.downloadLink) {
                    currentStatusDisplay = data.message || "Payment confirmed! Preparing your download...";
                } else {
                    currentStatusDisplay = data.message || "Payment successful! Downloading your file...";
                }
            } else if (data.status && (data.status.startsWith('failed_') || data.status === 'FAILED')) {
                currentStatusDisplay = data.message || `Payment ${data.status}. Please check details or contact support.`;
            }
            // ... any other specific statuses from your backend for /api/order-status

            statusMessage.innerHTML = currentStatusDisplay; // Update the message


            if (!statusRes.ok && statusRes.status !== 403 && statusRes.status !== 404) { // 403/404 handled by data.message
                clearInterval(countdown);
                statusMessage.innerHTML = `Error checking status: ${data.error || `HTTP ${statusRes.status}`}. <a href="${WHATSAPP_REDIRECT}" class="text-green-600 underline">Contact support.</a>`;
                // General error, allow retry if applicable
                if (showRetry && retryCount < maxRetries) {
                    retryBtn.classList.remove('hidden');
                    retryBtn.textContent = 'Retry Check';
                    retryBtn.onclick = () => {
                        retryCount++;
                        modal.classList.add('hidden'); document.body.classList.remove('popup-active');
                        showStatusModal(product, refCode, 'Retrying status check...', showRetry);
                    };
                } else {
                    setTimeout(() => { modal.classList.add('hidden'); document.body.classList.remove('popup-active'); clearPaymentCookie(product.item); }, 5000);
                }
                return;
            }

            if (data.downloaded) { // Specifically check for already downloaded
                clearInterval(countdown);
                statusMessage.innerHTML = data.message || 'File already downloaded for this order.';
                setTimeout(() => { modal.classList.add('hidden'); document.body.classList.remove('popup-active'); clearPaymentCookie(product.item); }, 3000);
                return;
            }

            if (data.status === 'confirmed' || data.status === 'confirmed_server_stk') {
              if (data.downloadLink) {
                clearInterval(countdown);
                statusMessage.textContent = data.message || 'Payment successful! Downloading your file, do not exit the page...';
                const downloadSuccess = await downloadFile(data.downloadLink, product.name);
                if (downloadSuccess) {
                  setTimeout(() => { modal.classList.add('hidden'); document.body.classList.remove('popup-active'); clearPaymentCookie(product.item); }, 2000);
                } else {
                  statusMessage.innerHTML = `Error initiating download. <a href="${WHATSAPP_REDIRECT}" class="text-green-600 underline">Contact support.</a>`;
                  // Allow retry for download failure specifically
                  if (showRetry && retryCount < maxRetries) {
                    retryBtn.classList.remove('hidden');
                    retryBtn.textContent = 'Retry Download';
                    retryBtn.onclick = () => {
                        retryCount++;
                        modal.classList.add('hidden'); document.body.classList.remove('popup-active');
                        // Re-trigger download attempt, assuming status is still confirmed
                        showStatusModal(product, refCode, 'Retrying download...', showRetry);
                    };
                  } else {
                    setTimeout(() => { modal.classList.add('hidden'); document.body.classList.remove('popup-active'); clearPaymentCookie(product.item); }, 3000);
                  }
                }
              } else {
                // Status is confirmed, but no download link (should not happen if server logic is correct)
                statusMessage.textContent = data.message || 'Payment confirmed, but download link is missing. Contacting support...';
                console.error("Confirmed status but no download link from server:", data);
                setTimeout(() => { window.location.href = WHATSAPP_REDIRECT; }, 3000);
              }
            } else if (data.status && data.status.startsWith('failed_')) {
                clearInterval(countdown);
                statusMessage.innerHTML = `${data.message || `Payment failed: ${data.status}`}. You can <a href="${WHATSAPP_REDIRECT}" class="text-green-600 underline">contact support</a> if the issue persists.`;

                // More specific retry logic for STK failures
                const retryableStkFailures = ['failed_stk_timeout', 'failed_stk_initiation'];
                // failed_stk_cb_ might also be retryable if it was a temporary PayHero issue
                // but cancelled_by_user, insufficient_funds, invalid_pin are usually not directly retryable by simply re-polling.

                if (showRetry && retryCount < maxRetries &&
                    (retryableStkFailures.includes(data.status) || data.status.startsWith('failed_stk_cb_'))) {
                    retryBtn.classList.remove('hidden');
                    retryBtn.textContent = 'Retry Payment';
                    retryBtn.onclick = () => {
                        retryCount++;
                        modal.classList.add('hidden'); document.body.classList.remove('popup-active');
                        // For STK, retrying means showing the PayHero modal again.
                        // We need product details and original KES price.
                        const originalKesPrice = localStorage.getItem(`payment_${product.item}_kesPrice`) || (product.price * (exchangeRate || settings.fallbackRate || 130)).toFixed(2);
                        showPayHeroModal(product, originalKesPrice);
                    };
                } else {
                    setTimeout(() => { modal.classList.add('hidden'); document.body.classList.remove('popup-active'); clearPaymentCookie(product.item); }, 7000); // Longer for failure messages
                }
            } else if (data.status === 'no payment' || data.status === 'partial payment') { // Manual Mpesa specific
              clearInterval(countdown);
              statusMessage.innerHTML = `${data.message || 'There was an issue with your manual payment.'} Please <a href="${WHATSAPP_REDIRECT}" class="text-green-600 underline">contact support</a>.`;
              setTimeout(() => { modal.classList.add('hidden'); document.body.classList.remove('popup-active'); clearPaymentCookie(product.item); }, 5000);
            } else {
              // Continue polling for pending_stk_push or other pending statuses
              // statusMessage is already set to data.message at the start of the loop
            }
          } catch (error) { // Catch for fetchWithTimeout error
            console.error('Error checking order status (fetch or JSON parse):', error.message);
            statusMessage.innerHTML = `Error checking status: ${error.message}. Please wait or <a href="${WHATSAPP_REDIRECT}" class="text-green-600 underline">contact support</a>.`;
            if (showRetry && retryCount < maxRetries) {
              retryBtn.classList.remove('hidden');
              retryBtn.textContent = 'Retry Check';
              retryBtn.onclick = () => {
                retryCount++;
                modal.classList.add('hidden'); document.body.classList.remove('popup-active');
                showStatusModal(product, refCode, 'Retrying status check...', showRetry);
              };
            } else {
                 setTimeout(() => { modal.classList.add('hidden'); document.body.classList.remove('popup-active'); clearPaymentCookie(product.item); }, 5000);
            }
          }
        }
        timeLeft--;
      }, 1000);
    }

    function clearPaymentCookie(item) {
      document.cookie = `payment_${item}=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/`;
      localStorage.removeItem(`payment_${item}_refCode`);
      localStorage.removeItem(`payment_${item}_kesPrice`);
      console.log(`Cleared payment state for item ${item}`);
    }

    async function downloadFile(downloadLink, fileNameBase) {
      const modal = document.getElementById('download-progress-modal');
      const progressText = document.getElementById('download-progress-text');
      const progressFill = document.getElementById('download-progress-fill');
      const errorText = document.getElementById('download-error');
      
      modal.style.display = 'flex';
      document.body.classList.add('popup-active');
      progressText.textContent = 'Starting download...';
      errorText.style.display = 'none';
      progressFill.style.width = '0%';

      return new Promise((resolve) => {
        const xhr = new XMLHttpRequest();
        xhr.open('GET', downloadLink, true);
        xhr.responseType = 'blob';
        xhr.withCredentials = true;

        xhr.onprogress = (event) => {
          if (event.lengthComputable) {
            const percentComplete = (event.loaded / event.total) * 100;
            progressFill.style.width = `${percentComplete}%`;
            progressText.textContent = `Downloading... ${Math.round(percentComplete)}%`;
          }
        };

        xhr.onload = () => {
          if (xhr.status === 200) {
            const contentDisposition = xhr.getResponseHeader('Content-Disposition');
            let fileName = fileNameBase;
            if (contentDisposition) {
              const fileNameMatch = contentDisposition.match(/filename="(.+)"/);
              if (fileNameMatch && fileNameMatch[1]) {
                fileName = fileNameMatch[1];
              }
            }

            const url = window.URL.createObjectURL(xhr.response);
            const a = document.createElement('a');
            a.href = url;
            a.download = fileName;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);

            progressText.textContent = 'Download complete!';
            setTimeout(() => {
              modal.style.display = 'none';
              document.body.classList.remove('popup-active');
            }, 1000);
            resolve(true);
          } else {
            progressText.textContent = 'Download failed.';
            errorText.textContent = `Error: ${xhr.statusText || 'Unknown error'}. Contact support.`;
            errorText.style.display = 'block';
            // Don't hide modal immediately on error, let user see the message
            // modal.style.display = 'none';
            // document.body.classList.remove('popup-active');
            resolve(false);
          }
        };

        xhr.onerror = () => {
          progressText.textContent = 'Download failed.';
          errorText.textContent = 'Network error occurred. Please try again or contact support.';
          errorText.style.display = 'block';
          // modal.style.display = 'none';
          // document.body.classList.remove('popup-active');
          resolve(false);
        };

        xhr.send();
      });
    }

    function updateFooter() {
      document.getElementById('support-email').href = `mailto:${settings.supportEmail}`;
      document.getElementById('support-email').textContent = settings.supportEmail;
      document.getElementById('copyright-text').innerHTML = settings.copyrightText.replace(/Â©/g, 'Â©');

      const socialLinks = document.getElementById('social-links');
      socialLinks.innerHTML = '';
      if (settings.socials) {
        Object.entries(settings.socials).forEach(([platform, url]) => {
          if (url) {
            const a = document.createElement('a');
            a.href = url;
            a.className = 'text-gray-500 hover:text-green-600';
            a.textContent = platform.charAt(0).toUpperCase() + platform.slice(1);
            socialLinks.appendChild(a);
          }
        });
      }

      const staticLinks = document.getElementById('static-links');
      staticLinks.innerHTML = '';
      staticPages
        .filter(page => page.slug !== '/payment-modal' && page.slug !== '/ref-code-modal')
        .forEach(page => {
          const a = document.createElement('a');
          a.href = '#';
          a.className = 'text-gray-500 hover:text-green-600';
          a.textContent = page.title;
          a.dataset.slug = page.slug;
          a.addEventListener('click', e => {
            e.preventDefault();
            const modal = document.getElementById('static-page-modal');
            document.getElementById('static-page-title').textContent = page.title;

            let cleanedContent = page.content
              .replace(/<span class="ql-ui"[^>]*><\/span>/g, '')
              .trim();

            const contentContainer = document.getElementById('static-page-content');
            contentContainer.innerHTML = cleanedContent || '<p>No content available.</p>';
            contentContainer.style.margin = '0';
            contentContainer.style.padding = '0';
            contentContainer.style.fontSize = '16px';

            const paragraphs = contentContainer.querySelectorAll('p');
            paragraphs.forEach(p => {
              p.style.wordBreak = 'break-word';
              p.style.margin = '0 0 1rem 0';
              p.style.lineHeight = '1.6';
            });

            const blankParagraphs = contentContainer.querySelectorAll('p:has(br)');
            blankParagraphs.forEach(p => {
              p.style.height = '1rem';
              p.style.margin = '0';
            });

            const headers = contentContainer.querySelectorAll('h1, h2, h3');
            headers.forEach(h => {
              h.style.fontWeight = '600';
              if (h.tagName.toLowerCase() === 'h1') {
                h.style.fontSize = '1.75rem';
              } else if (h.tagName.toLowerCase() === 'h2') {
                h.style.fontSize = '1.5rem';
              } else if (h.tagName.toLowerCase() === 'h3') {
                h.style.fontSize = '1.25rem';
              }
              h.style.margin = '1.5rem 0 1rem 0';
            });

            const unorderedLists = contentContainer.querySelectorAll('ul');
            unorderedLists.forEach(ul => {
              ul.style.paddingLeft = '1.5rem';
              ul.style.listStyleType = 'none';
              ul.style.margin = '1rem 0';
            });

            const orderedLists = contentContainer.querySelectorAll('ol');
            orderedLists.forEach(ol => {
              ol.style.paddingLeft = '1.5rem';
              if (!ol.style.listStyleType) {
                ol.style.listStyleType = ol.getAttribute('type') || 'decimal';
              }
              ol.style.margin = '1rem 0';
            });

            const listItems = contentContainer.querySelectorAll('li');
            listItems.forEach(li => {
              const indentLevel = li.className.match(/ql-indent-(\d+)/);
              if (indentLevel) {
                li.style.marginLeft = `${parseInt(indentLevel[1]) * 1.5}rem`;
              }
              li.style.position = 'relative';
              li.style.paddingLeft = '1.5rem';
              li.style.marginBottom = '0.5rem';

              if (li.parentNode.tagName.toLowerCase() === 'ul') {
                li.style.listStyleType = 'none';
                li.insertAdjacentHTML('beforebegin', '<span style="position: absolute; left: 0; color: #16a34a;">â€¢</span>');
              }
            });

            const boldText = contentContainer.querySelectorAll('strong, b');
            boldText.forEach(b => {
              b.style.fontWeight = 'bold';
            });

            const italicText = contentContainer.querySelectorAll('em, i');
            italicText.forEach(i => {
              i.style.fontStyle = 'italic';
            });

            const underlineText = contentContainer.querySelectorAll('u');
            underlineText.forEach(u => {
              u.style.textDecoration = 'underline';
            });

            const links = contentContainer.querySelectorAll('a');
            links.forEach(link => {
              link.style.color = 'blue';
              link.style.textDecoration = 'underline';
              link.setAttribute('target', '_blank');
            });

            const blockquotes = contentContainer.querySelectorAll('blockquote');
            blockquotes.forEach(bq => {
              bq.style.borderLeft = '4px solid #ccc';
              bq.style.paddingLeft = '1rem';
              bq.style.color = '#666';
              bq.style.margin = '1rem 0';
            });

            const codeElements = contentContainer.querySelectorAll('code');
            codeElements.forEach(code => {
              code.style.backgroundColor = '#f4f4f4';
              code.style.padding = '2px 4px';
              code.style.borderRadius = '4px';
              code.style.fontFamily = 'monospace';
            });

            const images = contentContainer.querySelectorAll('img');
            images.forEach(img => {
              img.style.maxWidth = '100%';
              img.style.height = 'auto';
              img.style.borderRadius = '8px';
              img.style.margin = '1rem 0';
            });

            modal.classList.remove('hidden');
            document.body.classList.add('popup-active');
          });
          staticLinks.appendChild(a);
        });

      document.getElementById('mobile-support-email').href = `mailto:${settings.supportEmail}`;
      document.getElementById('mobile-support-email').textContent = settings.supportEmail;
      document.getElementById('mobile-copyright-text').innerHTML = settings.copyrightText.replace(/Â©/g, 'Â©');

      const mobileSocialLinks = document.getElementById('mobile-social-links');
      mobileSocialLinks.innerHTML = '';
      if (settings.socials) {
        Object.entries(settings.socials).forEach(([platform, url]) => {
          if (url) {
            const a = document.createElement('a');
            a.href = url;
            a.className = 'text-gray-500 hover:text-green-600 text-sm';
            a.textContent = platform.charAt(0).toUpperCase() + platform.slice(1);
            mobileSocialLinks.appendChild(a);
          }
        });
      }

      const mobileStaticLinks = document.getElementById('mobile-static-links');
      mobileStaticLinks.innerHTML = '';
      staticPages
        .filter(page => page.slug !== '/payment-modal' && page.slug !== '/ref-code-modal')
        .forEach(page => {
          const a = document.createElement('a');
          a.href = '#';
          a.className = 'text-gray-500 hover:text-green-600 text-sm';
          a.textContent = page.title;
          a.dataset.slug = page.slug;
          a.addEventListener('click', e => {
            e.preventDefault();
            const modal = document.getElementById('static-page-modal');
            document.getElementById('static-page-title').textContent = page.title;

            let cleanedContent = page.content
              .replace(/<span class="ql-ui"[^>]*><\/span>/g, '')
              .trim();

            const contentContainer = document.getElementById('static-page-content');
            contentContainer.innerHTML = cleanedContent || '<p>No content available.</p>';
            contentContainer.style.margin = '0';
            contentContainer.style.padding = '0';
            contentContainer.style.fontSize = '16px';

            const paragraphs = contentContainer.querySelectorAll('p');
            paragraphs.forEach(p => {
              p.style.wordBreak = 'break-word';
              p.style.margin = '0 0 1rem 0';
              p.style.lineHeight = '1.6';
            });

            const blankParagraphs = contentContainer.querySelectorAll('p:has(br)');
            blankParagraphs.forEach(p => {
              p.style.height = '1rem';
              p.style.margin = '0';
            });

            const headers = contentContainer.querySelectorAll('h1, h2, h3');
            headers.forEach(h => {
              h.style.fontWeight = '600';
              if (h.tagName.toLowerCase() === 'h1') {
                h.style.fontSize = '1.75rem';
              } else if (h.tagName.toLowerCase() === 'h2') {
                h.style.fontSize = '1.5rem';
              } else if (h.tagName.toLowerCase() === 'h3') {
                h.style.fontSize = '1.25rem';
              }
              h.style.margin = '1.5rem 0 1rem 0';
            });

            const unorderedLists = contentContainer.querySelectorAll('ul');
            unorderedLists.forEach(ul => {
              ul.style.paddingLeft = '1.5rem';
              ul.style.listStyleType = 'none';
              ul.style.margin = '1rem 0';
            });

            const orderedLists = contentContainer.querySelectorAll('ol');
            orderedLists.forEach(ol => {
              ol.style.paddingLeft = '1.5rem';
              if (!ol.style.listStyleType) {
                ol.style.listStyleType = ol.getAttribute('type') || 'decimal';
              }
              ol.style.margin = '1rem 0';
            });

            const listItems = contentContainer.querySelectorAll('li');
            listItems.forEach(li => {
              const indentLevel = li.className.match(/ql-indent-(\d+)/);
              if (indentLevel) {
                li.style.marginLeft = `${parseInt(indentLevel[1]) * 1.5}rem`;
              }
              li.style.position = 'relative';
              li.style.paddingLeft = '1.5rem';
              li.style.marginBottom = '0.5rem';

              if (li.parentNode.tagName.toLowerCase() === 'ul') {
                li.style.listStyleType = 'none';
                li.insertAdjacentHTML('beforebegin', '<span style="position: absolute; left: 0; color: #16a34a;">â€¢</span>');
              }
            });

            const boldText = contentContainer.querySelectorAll('strong, b');
            boldText.forEach(b => {
              b.style.fontWeight = 'bold';
            });

            const italicText = contentContainer.querySelectorAll('em, i');
            italicText.forEach(i => {
              i.style.fontStyle = 'italic';
            });

            const underlineText = contentContainer.querySelectorAll('u');
            underlineText.forEach(u => {
              u.style.textDecoration = 'underline';
            });

            const links = contentContainer.querySelectorAll('a');
            links.forEach(link => {
              link.style.color = 'blue';
              link.style.textDecoration = 'underline';
              link.setAttribute('target', '_blank');
            });

            const blockquotes = contentContainer.querySelectorAll('blockquote');
            blockquotes.forEach(bq => {
              bq.style.borderLeft = '4px solid #ccc';
              bq.style.paddingLeft = '1rem';
              bq.style.color = '#666';
              bq.style.margin = '1rem 0';
            });

            const codeElements = contentContainer.querySelectorAll('code');
            codeElements.forEach(code => {
              code.style.backgroundColor = '#f4f4f4';
              code.style.padding = '2px 4px';
              code.style.borderRadius = '4px';
              code.style.fontFamily = 'monospace';
            });

            const images = contentContainer.querySelectorAll('img');
            images.forEach(img => {
              img.style.maxWidth = '100%';
              img.style.height = 'auto';
              img.style.borderRadius = '8px';
              img.style.margin = '1rem 0';
            });

            modal.classList.remove('hidden');
            document.body.classList.add('popup-active');
            document.getElementById('mobile-menu').classList.remove('open');
          });
          mobileStaticLinks.appendChild(a);
        });

      document.getElementById('static-page-close').onclick = () => {
        document.getElementById('static-page-modal').classList.add('hidden');
        document.body.classList.remove('popup-active');
      };
    }
    
    function showUrgentMessage() {
      const urgentMessage = document.getElementById('urgent-message');
      const urgentText = document.getElementById('urgent-text');
      if (settings.urgentMessage?.enabled && settings.urgentMessage?.text) {
        urgentText.innerHTML = settings.urgentMessage.text;
        urgentMessage.classList.remove('hidden');
      }
      document.getElementById('urgent-close').onclick = () => {
        urgentMessage.classList.add('hidden');
      };
    }
    async function checkPaymentCookie() {
      const cookies = document.cookie.split(';');
      const paymentCookie = cookies.find(cookie => cookie.trim().startsWith('payment_'));
      if (paymentCookie) {
        const [itemKey, status] = paymentCookie.split('=');
        const item = itemKey.replace('payment_', '');
        if (status === 'initiated') {
          const product = products.find(p => p.item === item);
          if (product) {
            const kesPrice = localStorage.getItem(`payment_${item}_kesPrice`);
            if (kesPrice) {
              showRefCodeModal(product, kesPrice);
            } else {
              const rate = await getExchangeRate();
              const newKesPrice = (product.price * rate).toFixed(2);
              localStorage.setItem(`payment_${item}_kesPrice`, newKesPrice);
              showRefCodeModal(product, newKesPrice);
            }
          }
        }
      }
    }

    function startPolling() {
      setInterval(async () => {
        const isUserActive = ['payment-modal', 'ref-code-modal', 'status-modal', 'download-progress-modal', 'payhero-modal', 'details-modal', 'payment-choice-modal']
          .some(modalId => {
            const modalElement = document.getElementById(modalId);
            return modalElement && (!modalElement.classList.contains('hidden') || modalElement.style.display === 'flex');
          });
        if (isUserActive) {
          console.log('Skipping polling: User is in an active modal');
          return;
        }
        const success = await fetchData();
        if (success) {
          renderNavLinks();
          renderProducts();
          updateFooter();
          showUrgentMessage();
        }
      }, 10 * 1000);
    }

    function isInAppBrowser() {
      const ua = navigator.userAgent.toLowerCase();
      console.log("User Agent:", navigator.userAgent);
      const inAppPatterns = [
        'tiktok', 'bytedancewebview',
        'twitter', 'twitterandroid', 'twitterios',
        'fbav', 'fb_iab', 'fban', 'fb4a',
        'instagram',
        'linkedin', 'linkedinapp',
        'snapchat',
        'line',
        'zalo',
        'pinterest',
        'messenger', 'fb_messenger',
        'kakaotalk',
        'dingtalk',
        'weixin', 'micromessenger',
        'reddit',
        'discord',
        'telegram',
        'whatsapp'
      ];
      const isAppBrowser = inAppPatterns.some(pattern => ua.includes(pattern));
      const isWebView = /wv|webview|version\/[\d.]+.*safari/i.test(ua) && !/safari|chrome|firefox|ucbrowser|opera/i.test(ua);
      const isRegularBrowser = /safari|chrome|firefox|edge|opera|ucbrowser/i.test(ua) && !/wv|webview/i.test(ua);
      const result = (isAppBrowser || isWebView) && !isRegularBrowser;
      console.log('Is In-App Browser:', result);
      return result;
    }

    function handleInAppBrowser() {
      if (isInAppBrowser()) {
        const popup = document.createElement("div");
        popup.className = "popup";
        popup.innerHTML = `
          <div class="popup-content">
            <h3>Open in Browser</h3>
            <p style="font-size: 1rem; color: #444; margin-bottom: 20px;">
              For a smoother experience, please open this page in your default browser (e.g., Chrome, Safari). Tap your app's menu (often a three-dot icon) and select "Open in Browser".
            </p>
            <button class="browser-popup-button cancel">Okay</button>
          </div>`;
        document.body.appendChild(popup);

        popup.querySelector(".cancel").addEventListener("click", () => {
          console.log('Okay button clicked');
          popup.remove();
          allowInAppBrowser = true;
          proceedWithInit();
        });
      } else {
        proceedWithInit();
      }
    }

    async function proceedWithInit() {
      const success = await fetchData();
      if (success) {
        renderNavLinks();
        renderProducts();
        updateFooter();
        showUrgentMessage();
        checkPaymentCookie();
        startPolling();
        await fetchModalContent(); // Ensure fetchModalContent is called
      }

      document.getElementById('mobile-menu-button').onclick = () => {
        document.getElementById('mobile-menu').classList.add('open');
      };

      document.getElementById('mobile-menu-close').onclick = () => {
        document.getElementById('mobile-menu').classList.remove('open');
      };

      const searchBars = [document.getElementById('search-bar'), document.getElementById('mobile-search-bar')];
      searchBars.forEach(searchBar => {
        searchBar.addEventListener('input', debounce(() => {
          const search = searchBar.value;
          const category = document.querySelector('.nav-link.border-green-500')?.dataset.category || 'all';
          renderProducts(category, search);
        }, 300));
      });
    }

    async function init() {
      handleInAppBrowser();
    }

    document.addEventListener('DOMContentLoaded', init);
  </script>
  <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9327d9e2c89e53c4',t:'MTc0NTAxNzk4OS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script>
  <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9328f5e1dc724527',t:'MTc0NTAyOTYyMi4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script>
  <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9329cd351aac53cd',t:'MTc0NTAzODQ0MS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script>
</body>
</html>
