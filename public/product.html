<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Dynamic meta tags will be added here by JavaScript -->
    <title>Product Details</title>
    <link rel="icon" type="image/png" href="/favicon.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked@4.0.12/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sanitize-html@2.7.0/dist/sanitize-html.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload@17.8.3/dist/lazyload.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <!-- Add any shared CSS files or styles from index.html if necessary -->
    <style>
        body { font-family: 'Inter', sans-serif; }
        .product-image {
            width: 100%;
            max-width: 1280px; /* Max width for the image */
            height: auto; /* Maintain aspect ratio */
            aspect-ratio: 16 / 9; /* Enforce 1280x720 aspect ratio */
            object-fit: cover; /* Cover the area, might crop */
            border-radius: 12px;
            box-shadow: 0 6px 12px rgba(0,0,0,0.1);
        }
        .embed-container {
            position: relative;
            padding-bottom: 56.25%; /* 16:9 */
            height: 0;
            overflow: hidden;
            max-width: 100%;
            background: #000;
            border-radius: 12px;
            margin: 1.5rem 0;
        }
        .embed-container iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: 0;
        }
        .share-buttons button, .action-buttons button {
            transition: all 0.3s ease;
        }
        .share-buttons button:hover, .action-buttons button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .dropdown {
            position: relative;
            display: inline-block;
        }
        .dropdown-content {
            display: none;
            position: absolute;
            background-color: #f9f9f9;
            min-width: 160px;
            box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
            z-index: 1;
            border-radius: 8px;
        }
        .dropdown-content a {
            color: black;
            padding: 12px 16px;
            text-decoration: none;
            display: block;
        }
        .dropdown-content a:hover {background-color: #f1f1f1}
        .dropdown:hover .dropdown-content {display: block;}

        /* Replicate necessary styles from index.html for modals, buttons etc. */
        body.popup-active { overflow: hidden; }
        #payment-modal, #ref-code-modal, #status-modal, #payment-choice-modal, #nowpayments-modal, #payhero-modal, #download-progress-modal {
            /* Styles for modals - ensure they are identical to index.html or extracted to a shared CSS */
            position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: flex;
            align-items: center; justify-content: center; z-index: 50;
        }
        .modal-content-area { /* General class for modal content styling */
            background: white; padding: 1.5rem; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.25);
            max-width: 500px; width: 90%;
        }
        /* Add styles for product grid (related products) */
        .product-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1.5rem;
        }
        .product-card {
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            overflow: hidden;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .product-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 16px rgba(0,0,0,0.1);
        }
        .product-card img {
            width: 100%;
            height: 180px;
            object-fit: cover;
        }
        .product-card-content {
            padding: 1rem;
        }
        .product-card-title {
            font-size: 1.125rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: #1a202c;
        }
        .product-card-price {
            font-size: 1rem;
            font-weight: bold;
            color: #16a34a;
            margin-bottom: 1rem;
        }
        .product-card-button {
            display: block;
            width: 100%;
            text-align: center;
            padding: 0.75rem;
            background-color: #16a34a;
            color: white;
            border-radius: 8px;
            text-decoration: none;
            transition: background-color 0.3s ease;
        }
        .product-card-button:hover {
            background-color: #14853d;
        }
    </style>
    <!-- Schema.org JSON-LD will be injected here by JavaScript -->
    <script type="application/ld+json" id="product-schema"></script>
</head>
<body class="bg-gray-100">
    <nav class="bg-white shadow-md sticky top-0 z-20">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <a href="/index.html" id="store-logo-nav" class="text-xl sm:text-2xl font-bold text-gray-800">Deriv Bot Store</a>
                </div>
                <div class="flex items-center space-x-4">
                    <a href="/index.html" class="text-gray-500 hover:text-green-600">Home</a>
                    <div class="dropdown">
                        <button class="text-gray-500 hover:text-green-600">Pages</button>
                        <div class="dropdown-content" id="static-pages-dropdown-nav">
                            <!-- Static pages will be populated here -->
                        </div>
                    </div>
                    <div class="dropdown">
                        <button class="text-gray-500 hover:text-green-600">Socials</button>
                        <div class="dropdown-content" id="social-links-dropdown-nav">
                            <!-- Social links will be populated here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <main class="max-w-4xl mx-auto px-4 py-8">
        <div id="loading-product" class="text-center py-10">Loading product details...</div>
        <div id="product-details-container" class="hidden bg-white p-6 rounded-lg shadow-lg">
            <img data-src="" src="placeholder-image.png" alt="Product Image" id="product-image" class="lazy product-image mb-6">
            <h1 id="product-name" class="text-3xl font-bold text-gray-900 mb-4"></h1>
            <div id="product-video-embed" class="embed-container mb-6" style="display:none;">
                <!-- Video iframe will be injected here -->
            </div>
            <div id="product-description" class="prose max-w-none text-gray-700 mb-6">
                <!-- Description will be populated here -->
            </div>

            <div class="action-buttons flex flex-col sm:flex-row gap-4 mb-6">
                <button id="buy-now-button" class="bg-green-600 text-white py-3 px-6 rounded-lg font-semibold text-lg flex-grow">Buy Now</button>
            </div>

            <div class="share-buttons mb-6">
                <h2 class="text-xl font-semibold text-gray-800 mb-2">Share this Product:</h2>
                <div class="flex space-x-2">
                    <button id="share-whatsapp" class="bg-green-500 text-white p-2 rounded-full">WhatsApp</button>
                    <button id="share-facebook" class="bg-blue-600 text-white p-2 rounded-full">Facebook</button>
                    <button id="share-twitter" class="bg-blue-400 text-white p-2 rounded-full">Twitter</button>
                    <button id="copy-link" class="bg-gray-500 text-white p-2 rounded-full">Copy Link</button>
                </div>
            </div>
        </div>

        <section id="related-products-section" class="mt-12 hidden">
            <h2 class="text-2xl font-bold text-gray-900 mb-6">Related Products</h2>
            <div id="related-products-grid" class="product-grid">
                <!-- Related products will be loaded here -->
            </div>
            <div id="loading-related" class="text-center py-5 hidden">Loading more products...</div>
        </section>
    </main>

    <footer class="bg-white shadow-inner mt-12 py-6">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 text-center">
            <p id="copyright-text-footer" class="text-gray-600"></p>
            <p class="text-gray-500 mt-2">Support: <a id="support-email-footer" class="underline"></a></p>
            <div id="social-links-footer" class="mt-4 flex justify-center space-x-4 flex-wrap"></div>
            <div id="static-links-footer" class="mt-4 flex justify-center space-x-4 flex-wrap"></div>
        </div>
    </footer>

    <!-- Modal Placeholders (copy structure from index.html or use a shared component approach if possible) -->
    <div id="payment-choice-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg p-6 w-full max-w-sm">
          <h3 class="text-xl font-bold text-gray-900 mb-4">Choose Payment Method</h3>
          <p id="payment-choice-product-name" class="text-gray-700 mb-1"></p>
          <p id="payment-choice-amount" class="text-green-600 font-bold mb-6"></p>
          <button id="manual-mpesa-choice" class="w-full bg-blue-600 text-white py-2 rounded-md hover:bg-blue-700 mb-3">Pay to Mpesa till</button>
          <button id="payhero-choice" class="w-full bg-green-600 text-white py-2 rounded-md hover:bg-green-700 mb-3">Pay with Mpesa</button>
          <button id="nowpayments-choice" class="w-full bg-yellow-500 text-white py-2 rounded-md hover:bg-yellow-600">Pay with crypto</button>
          <button id="payment-choice-cancel" class="mt-4 w-full bg-gray-600 text-white py-2 rounded-md hover:bg-gray-700">Cancel</button>
        </div>
    </div>
    <div id="nowpayments-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden px-4 py-6">
        <div class="bg-white rounded-lg p-5 sm:p-6 w-full max-w-md shadow-xl transform transition-all modal-content-area" style="max-height: 90vh; overflow-y: auto;">
          <h3 id="nowpayments-title" class="text-xl sm:text-2xl font-bold text-gray-800 mb-4 text-center">Pay with Cryptocurrency</h3>
          <p id="nowpayments-product-name" class="text-gray-600 text-sm mb-1 text-center"></p>
          <p id="nowpayments-amount-usd" class="text-green-600 font-semibold mb-5 text-center"></p>

          <div class="space-y-4">
            <div>
              <label for="nowpayments-email" class="block text-sm font-medium text-gray-700 mb-1">Your Email:</label>
              <input type="email" id="nowpayments-email" class="mt-1 block w-full p-2.5 border border-gray-300 rounded-lg shadow-sm focus:ring-green-500 focus:border-green-500 sm:text-sm" placeholder="you@example.com" required>
            </div>

            <div>
              <label for="nowpayments-currency-search" class="block text-sm font-medium text-gray-700 mb-1">Search Currency:</label>
              <input type="text" id="nowpayments-currency-search" class="mt-1 block w-full p-2.5 border border-gray-300 rounded-lg shadow-sm focus:ring-green-500 focus:border-green-500 sm:text-sm" placeholder="e.g., Bitcoin or BTC">
            </div>

            <div>
              <label for="nowpayments-currency" class="block text-sm font-medium text-gray-700 mb-1">Select Cryptocurrency:</label>
              <select id="nowpayments-currency" class="mt-1 block w-full p-2.5 border border-gray-300 rounded-lg shadow-sm focus:ring-green-500 focus:border-green-500 sm:text-sm bg-white">
                <option value="">Loading currencies...</option>
              </select>
            </div>
          </div>

          <button id="nowpayments-proceed" class="mt-6 w-full bg-yellow-500 text-white py-2.5 px-4 rounded-lg hover:bg-yellow-600 focus:ring-4 focus:ring-yellow-300 transition-all duration-150 ease-in-out font-medium flex items-center justify-center">
            Proceed to Payment
          </button>
          <button id="nowpayments-cancel" class="mt-2.5 w-full bg-gray-200 text-gray-700 py-2.5 px-4 rounded-lg hover:bg-gray-300 focus:ring-4 focus:ring-gray-100 transition-all duration-150 ease-in-out font-medium">Cancel</button>

          <p id="nowpayments-status-message" class="text-center text-sm mt-4 font-medium"></p>

          <div id="nowpayments-payment-info" class="mt-6 hidden bg-gray-50 p-4 rounded-lg">
            <div id="nowpayments-timer" class="text-center font-semibold text-blue-600 mb-3"></div>
            <div id="nowpayments-payment-details-content">
                <p class="text-gray-700 mb-2 text-sm">Please send exactly <strong id="nowpayments-pay-amount" class="text-gray-900"></strong> <strong id="nowpayments-pay-currency" class="text-gray-900"></strong> to the address below:</p>
                <div class="bg-gray-100 p-3 my-2 rounded-md border border-gray-200">
                  <p class="text-xs sm:text-sm font-mono break-all text-gray-800" id="nowpayments-pay-address"></p>
                </div>
                <button id="nowpayments-copy-address" class="w-full text-sm bg-green-500 hover:bg-green-600 text-white font-medium py-2 px-3 rounded-md transition-colors duration-150 ease-in-out flex items-center justify-center">
                  Copy Address
                </button>
                <p class="text-xs text-gray-500 mt-3">Ensure you send the exact amount and use the correct network. Underpayments or payments to the wrong network may be lost.</p>
            </div>
          </div>
        </div>
    </div>
    <div id="payment-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg p-6 w-full max-w-md modal-content-area">
          <div id="countdown-timer" class="mb-4">
            <p class="text-gray-600">Time remaining: <span id="timer-text">10:00</span></p>
            <div class="w-full h-2 bg-gray-200 rounded-full overflow-hidden">
              <div id="timer-bar" class="h-full bg-green-600 transition-all duration-1000" style="width: 100%;"></div>
            </div>
          </div>
          <h3 id="payment-title" class="text-xl font-bold text-gray-900 mb-4"></h3>
          <p class="text-gray-600 mb-4">Please send the payment via MPESA to:</p>
          <div class="flex items-center space-x-2">
            <p class="font-semibold text-gray-900">Till Number: <span id="mpesa-till-number">4933614</span></p>
            <button id="copy-till" class="text-sm text-green-600 hover:underline">Copy Till</button>
          </div>
          <p id="payment-amount" class="text-green-600 font-bold mt-2"></p>
          <button id="confirm-payment" class="mt-6 w-full bg-green-600 text-white py-2 rounded-md hover:bg-green-700">I Have Paid</button>
          <button id="payment-cancel" class="mt-2 w-full bg-gray-600 text-white py-2 rounded-md hover:bg-gray-700">Cancel</button>
        </div>
    </div>
    <div id="payhero-modal" class="payhero-modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden"> <!-- Added payhero-modal class for base styles -->
        <div class="payhero-modal-content modal-content-area"> <!-- Added modal-content-area for consistency if needed -->
          <div class="payhero-modal-header">
            <h3 class="payhero-modal-title">Pay with Pay Hero (Mpesa STK)</h3>
            <button id="payhero-close-button" class="payhero-close-button" aria-label="Close payment form">×</button>
          </div>
          <div class="payhero-form-container">
            <p class="amount-display">Amount: KES <span id="payhero-amount-display">0.00</span></p>
            <div>
              <label for="payhero-customer-name">Name (Optional):</label>
              <input type="text" id="payhero-customer-name" placeholder="Enter your name" class="mt-1 block w-full p-2.5 border border-gray-300 rounded-lg shadow-sm focus:ring-green-500 focus:border-green-500 sm:text-sm">
            </div>
            <div>
              <label for="payhero-phone-number">Mpesa Number:</label>
              <input type="tel" id="payhero-phone-number" placeholder="e.g., 0712345678 or 254712345678" class="mt-1 block w-full p-2.5 border border-gray-300 rounded-lg shadow-sm focus:ring-green-500 focus:border-green-500 sm:text-sm">
            </div>
            <div>
              <button id="payhero-proceed-button" class="w-full bg-green-600 text-white py-2.5 rounded-md hover:bg-green-700 transition-colors">Proceed to Pay via Mpesa</button>
            </div>
            <p id="payhero-status-message" class="text-center text-sm mt-2"></p>
          </div>
        </div>
    </div>
    <div id="ref-code-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg p-6 w-full max-w-md modal-content-area">
          <h3 class="text-xl font-bold text-gray-900 mb-4">Enter MPESA Ref Code</h3>
          <input id="ref-code-input" type="text" placeholder="e.g., QK12345678" class="w-full p-2 border rounded-md mb-4">
          <button id="submit-ref-code" class="w-full bg-green-600 text-white py-2 rounded-md hover:bg-green-700">Submit</button>
          <button id="ref-code-cancel" class="mt-2 w-full bg-gray-600 text-white py-2 rounded-md hover:bg-gray-700">Cancel</button>
        </div>
    </div>
    <div id="status-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg p-6 w-full max-w-md modal-content-area">
          <div id="status-countdown" class="mb-4">
            <p class="text-gray-600">Confirming payment... Time remaining: <span id="status-timer-text">5:00</span></p>
            <div class="w-full h-2 bg-gray-200 rounded-full overflow-hidden">
              <div id="status-timer-bar" class="h-full bg-green-600 transition-all duration-1000" style="width: 100%;"></div>
            </div>
          </div>
          <p id="status-message" class="text-gray-600 mb-4"></p>
          <button id="status-retry" class="mt-2 w-full bg-blue-600 text-white py-2 rounded-md hover:bg-blue-700 hidden">Retry</button>
        </div>
    </div>
    <div id="download-progress-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div id="download-progress-content" class="bg-white p-6 rounded-lg shadow-xl w-full max-w-md modal-content-area">
             <h3 class="text-xl font-bold text-gray-900 mb-4">Downloading File</h3>
             <p id="download-progress-text" class="text-gray-600 mb-4">Starting download...</p>
             <div id="download-progress-bar" class="w-full bg-gray-200 rounded-full h-4 mb-4 overflow-hidden">
                 <div id="download-progress-fill" class="bg-green-600 h-4 rounded-full" style="width: 0%"></div>
             </div>
             <p id="download-error" class="text-red-500 text-sm hidden"></p>
        </div>
    </div>

    <script>
        // --- START OF COPIED/ADAPTED CODE FROM INDEX.HTML ---
        const WHATSAPP_REDIRECT = 'https://wa.link/j8hx47'; // Make sure this is same as index.html
        const BASE_URL = 'https://bot-delivery-system-qlx4j.ondigitalocean.app'; // Ensure this is correct

        let currentProduct = null; // Specific to this product page
        let allProducts = [];    // For related products
        let settings = {};       // For footer, nav, payment options etc.
        let staticPages = [];    // For nav/footer links
        let exchangeRate = null;
        let allowInAppBrowser = false; // From index.html, might be needed if modals use it
        const TEST_MODE = new URLSearchParams(window.location.search).get('test') === 'true';


        // LazyLoad instance
        let lazyLoadInstance;

        // --- MODAL AND PAYMENT VARIABLES (from index.html) ---
        // These will be used by the ported modal functions
        let paymentTimerCountdown;
        let statusTimerCountdown;
        let currentPaymentItem = null; // To store product context for payment
        let currentPaymentRefCode = null;
        let currentPaymentKesPrice = null;
        let currentPaymentUsdPrice = null;

        // --- COPIED HELPER FUNCTIONS (from index.html) ---
        async function fetchWithTimeout(url, options = {}, timeout = 15000) {
          const controller = new AbortController();
          const id = setTimeout(() => controller.abort(), timeout);
          const headers = options.headers || {};
          if (options.method === 'GET') {
            delete headers['Content-Type'];
          }
          try {
            const response = await fetch(url, {
              ...options,
              signal: controller.signal,
              headers
            });
            clearTimeout(id);
            return response;
          } catch (error) {
            clearTimeout(id);
            throw error;
          }
        }

        async function getExchangeRate() {
            if (exchangeRate) return exchangeRate;
            try {
                const response = await fetchWithTimeout('https://api.exchangerate-api.com/v4/latest/USD', {}, 5000);
                const data = await response.json();
                exchangeRate = data.rates.KES || (settings && settings.fallbackRate) || 130;
            } catch (error) {
                console.error('Error fetching exchange rate:', error.message);
                exchangeRate = (settings && settings.fallbackRate) || 130;
            }
            return exchangeRate;
        }

        // Debounce function (copied from index.html - though not immediately used here, good to have if needed)
        function debounce(func, wait) {
          let timeout;
          return function (...args) {
            clearTimeout(timeout);
            timeout = setTimeout(() => func.apply(this, args), wait);
          };
        }

        // --- MAIN PRODUCT PAGE LOGIC ---
        document.addEventListener("DOMContentLoaded", () => {
            lazyLoadInstance = new LazyLoad({
                elements_selector: ".lazy",
            });
            initializeProductPage();
            // Attach event listeners for modals (copied/adapted from index.html)
            attachModalEventListeners();
        });

        async function fetchProductPageData(itemId) {
            try {
                // API endpoint /api/product/:item will be created in a later step.
                // For now, fetching all data and filtering, similar to index.html's initial load.
                // This also helps get settings and allProducts for related items.
                const response = await axios.get(`${BASE_URL}/api/data`);
                allProducts = response.data.products.filter(p => !p.isArchived);
                settings = response.data.settings;
                staticPages = response.data.staticPages;

                currentProduct = allProducts.find(p => p.item === itemId);

                if (!currentProduct) {
                    document.getElementById('loading-product').textContent = 'Product not found.';
                    document.getElementById('product-details-container').classList.add('hidden');
                    document.getElementById('related-products-section').classList.add('hidden');
                    return false;
                }
                return true;
            } catch (error) {
                console.error('Error fetching product page data:', error);
                document.getElementById('loading-product').textContent = 'Error loading product. Please try again.';
                document.getElementById('product-details-container').classList.add('hidden');
                document.getElementById('related-products-section').classList.add('hidden');
                return false;
            }
        }

        function populateProductData() {
            if (!currentProduct) return;

            // 1. Meta Tags
            document.title = currentProduct.name + " - " + (settings.storeName || "Deriv Bot Store");
            updateMetaTag("description", currentProduct.desc.substring(0, 160)); // Standard length for description
            updateMetaTag("keywords", `Deriv bot, ${currentProduct.name}, ${currentProduct.category}, trading automation, Deriv store`);
            updateMetaTag("og:title", currentProduct.name + " - " + (settings.storeName || "Deriv Bot Store"));
            updateMetaTag("og:description", currentProduct.desc.substring(0, 160));
            updateMetaTag("og:image", currentProduct.img); // Ensure this is an absolute URL if hosted elsewhere or use BASE_URL
            updateMetaTag("og:url", window.location.href);
            updateMetaTag("og:type", "product");
            updateMetaTag("product:price:amount", currentProduct.price.toFixed(2));
            updateMetaTag("product:price:currency", "USD");


            // 2. Schema.org Markup
            const schema = {
                "@context": "https://schema.org/",
                "@type": "Product",
                "name": currentProduct.name,
                "image": currentProduct.img, // Ensure this is an absolute URL
                "description": currentProduct.desc,
                "sku": currentProduct.item,
                "brand": {
                    "@type": "Brand",
                    "name": settings.storeName || "Deriv Bot Store"
                },
                "offers": {
                    "@type": "Offer",
                    "url": window.location.href,
                    "priceCurrency": "USD",
                    "price": currentProduct.price.toFixed(2),
                    "availability": "https://schema.org/InStock", // Or OutOfStock, PreOrder
                    "itemCondition": "https://schema.org/NewCondition"
                },
                // Optional: Add aggregateRating if you have reviews
                // "aggregateRating": {
                //   "@type": "AggregateRating",
                //   "ratingValue": "4.5", // Example
                //   "reviewCount": "120"  // Example
                // }
            };
            document.getElementById('product-schema').textContent = JSON.stringify(schema);

            // 3. Product Content
            document.getElementById('product-name').textContent = currentProduct.name;
            const productImage = document.getElementById('product-image');
            productImage.setAttribute('data-src', currentProduct.img);
            productImage.alt = currentProduct.name;
            if (lazyLoadInstance) lazyLoadInstance.load(productImage);


            if (currentProduct.embed) {
                const videoEmbedDiv = document.getElementById('product-video-embed');
                videoEmbedDiv.style.display = 'block';
                videoEmbedDiv.innerHTML = `<iframe data-src="${currentProduct.embed}" class="lazy" title="${currentProduct.name} Video" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>`;
                if (lazyLoadInstance) lazyLoadInstance.update();
            } else {
                document.getElementById('product-video-embed').style.display = 'none';
            }

            // Sanitize and parse description (similar to index.html's modal)
            let cleanedDesc = currentProduct.desc
                .replace(/<p>\s*<\/p>/g, '')
                .replace(/<p>\s*<br\s*\/?>\s*<\/p>/g, '')
                .replace(/<span class="ql-ui"[^>]*><\/span>/g, '')
                .trim();

            cleanedDesc = cleanedDesc.replace(/<h(\d)>/g, (match, level) => `<h${parseInt(level) + 1} style="font-size: ${20 - (level -1) * 2}px; margin-bottom: 0.75rem; font-weight: 600;">`) // Shift H1 to H2, H2 to H3 etc.
                                     .replace(/<\/h\d>/g, (match) => `</h${parseInt(match[3]) + 1}>`);


            const productDescriptionEl = document.getElementById('product-description');
            productDescriptionEl.innerHTML = sanitizeHtml(marked.parse(cleanedDesc), {
                 allowedTags: sanitizeHtml.defaults.allowedTags.concat(['img', 'iframe', 'video', 'h1', 'h2', 'h3', 'h4', 'h5', 'h6', 'span', 'div', 'section', 'article', 'aside', 'details', 'summary', 'figure', 'figcaption', 'source', 'track']),
                 allowedAttributes: {
                     ...sanitizeHtml.defaults.allowedAttributes,
                     '*': ['style', 'class', 'id', 'title', 'lang', 'dir', 'data-*'],
                     'iframe': ['src', 'frameborder', 'allow', 'allowfullscreen', 'width', 'height', 'title', 'loading'],
                     'img': ['src', 'alt', 'style', 'width', 'height', 'srcset', 'sizes', 'loading'],
                     'video': ['controls', 'width', 'height', 'poster', 'preload'],
                     'source': ['src', 'type'],
                     'track': ['kind', 'src', 'srclang', 'label']
                 },
                 allowedSchemes: ['http', 'https', 'ftp', 'mailto', 'tel'],
                 transformTags: {
                    'h1': 'h2', // Transform top-level h1 in description to h2
                    'h2': 'h3',
                    'h3': 'h4',
                     'img': (tagName, attribs) => {
                        return {
                            tagName: 'img',
                            attribs: {
                                ...attribs,
                                class: (attribs.class || '') + ' lazy my-4 rounded-md shadow-sm', // Add styling for embedded images
                                loading: 'lazy'
                            }
                        };
                    }
                  }
            });


            // 4. Buy Now Button
            const buyNowButton = document.getElementById('buy-now-button');
            buyNowButton.onclick = async () => {
                currentPaymentItem = currentProduct; // Set context for modals
                const rate = await getExchangeRate();
                currentPaymentKesPrice = (currentProduct.price * rate).toFixed(2);
                currentPaymentUsdPrice = currentProduct.price.toFixed(2);

                const activeOptions = (settings && typeof settings.activePaymentOptions === 'object')
                                  ? settings.activePaymentOptions
                                  : { mpesa_manual: true, mpesa_payhero: true, crypto_nowpayments: true };

                const availableMethods = [];
                if (activeOptions.mpesa_manual) availableMethods.push('mpesa_manual');
                if (activeOptions.mpesa_payhero) availableMethods.push('mpesa_payhero');
                if (activeOptions.crypto_nowpayments) availableMethods.push('crypto_nowpayments');

                if (availableMethods.length > 1) {
                  showPaymentChoiceModal(currentProduct, currentPaymentKesPrice);
                } else if (availableMethods.length === 1) {
                  const singleMethod = availableMethods[0];
                  if (singleMethod === 'mpesa_manual') {
                    showPaymentModal(currentProduct, currentPaymentKesPrice);
                  } else if (singleMethod === 'mpesa_payhero') {
                    showPayHeroModal(currentProduct, currentPaymentKesPrice);
                  } else if (singleMethod === 'crypto_nowpayments') {
                    showNowPaymentsModal(currentProduct, currentPaymentUsdPrice);
                  }
                } else {
                  alert("No payment methods are currently available. Please contact support.");
                }
            };

            // 5. Sharing Buttons
            const pageUrl = window.location.href;
            const shareText = `Check out this product: ${currentProduct.name}`;
            document.getElementById('share-whatsapp').onclick = () => window.open(`https://api.whatsapp.com/send?text=${encodeURIComponent(shareText + " " + pageUrl)}`, '_blank');
            document.getElementById('share-facebook').onclick = () => window.open(`https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(pageUrl)}`, '_blank');
            document.getElementById('share-twitter').onclick = () => window.open(`https://twitter.com/intent/tweet?url=${encodeURIComponent(pageUrl)}&text=${encodeURIComponent(shareText)}`, '_blank');
            const copyLinkBtn = document.getElementById('copy-link');
            copyLinkBtn.onclick = () => {
                navigator.clipboard.writeText(pageUrl).then(() => {
                    copyLinkBtn.textContent = 'Copied!';
                    setTimeout(() => copyLinkBtn.textContent = 'Copy Link', 2000);
                }, () => alert('Failed to copy link.'));
            };

            // 6. Related Products
            loadRelatedProducts();
        }

        function updateMetaTag(metaType, contentOrName, contentIfProperty) {
            let element;
            if (metaType === "name") {
                 element = document.querySelector(`meta[name="${contentOrName}"]`);
                 if (!element) {
                    element = document.createElement('meta');
                    element.setAttribute('name', contentOrName);
                    document.getElementsByTagName('head')[0].appendChild(element);
                }
                element.setAttribute('content', contentIfProperty);
            } else if (metaType === "property") { // For Open Graph
                element = document.querySelector(`meta[property="${contentOrName}"]`);
                if (!element) {
                    element = document.createElement('meta');
                    element.setAttribute('property', contentOrName);
                    document.getElementsByTagName('head')[0].appendChild(element);
                }
                element.setAttribute('content', contentIfProperty);
            }
        }
        // Simplified usage for the product page:
        function updateMetaTag(nameOrProperty, content) {
            const isOgTag = nameOrProperty.startsWith('og:') || nameOrProperty.startsWith('product:');
            let element = document.querySelector(`meta[${isOgTag ? 'property' : 'name'}="${nameOrProperty}"]`);
            if (!element) {
                element = document.createElement('meta');
                element.setAttribute(isOgTag ? 'property' : 'name', nameOrProperty);
                document.getElementsByTagName('head')[0].appendChild(element);
            }
            element.setAttribute('content', content);
        }


        function populateSharedElements() {
            // Footer
            document.getElementById('copyright-text-footer').innerHTML = settings.copyrightText || `© ${new Date().getFullYear()} ` + (settings.storeName || "Deriv Bot Store");
            const supportEmailFooter = document.getElementById('support-email-footer');
            supportEmailFooter.href = `mailto:${settings.supportEmail || ''}`;
            supportEmailFooter.textContent = settings.supportEmail || 'support@example.com';

            const socialLinksFooter = document.getElementById('social-links-footer');
            const socialLinksNav = document.getElementById('social-links-dropdown-nav');
            socialLinksFooter.innerHTML = '';
            socialLinksNav.innerHTML = '';
            if (settings.socials) {
                Object.entries(settings.socials).forEach(([platform, url]) => {
                    if (url) {
                        const platformName = platform.charAt(0).toUpperCase() + platform.slice(1);
                        const aFooter = `<a href="${url}" target="_blank" rel="noopener noreferrer" class="text-gray-500 hover:text-green-600 mx-2">${platformName}</a>`;
                        socialLinksFooter.innerHTML += aFooter;
                        const aNav = `<a href="${url}" target="_blank" rel="noopener noreferrer" class="hover:bg-gray-100">${platformName}</a>`;
                        socialLinksNav.innerHTML += aNav;
                    }
                });
            }

            // Static Pages in Footer & Nav
            const staticLinksFooter = document.getElementById('static-links-footer');
            const staticPagesNav = document.getElementById('static-pages-dropdown-nav');
            staticLinksFooter.innerHTML = '';
            staticPagesNav.innerHTML = '';
            if (staticPages) {
                staticPages.filter(page => page.slug !== '/payment-modal' && page.slug !== '/ref-code-modal').forEach(page => {
                    const pageUrl = `/page.html?slug=${page.slug.startsWith('/') ? page.slug.substring(1) : page.slug}`;
                    const aFooter = `<a href="${pageUrl}" class="text-gray-500 hover:text-green-600 mx-2">${page.title}</a>`;
                    staticLinksFooter.innerHTML += aFooter;
                    const aNav = `<a href="${pageUrl}" class="hover:bg-gray-100">${page.title}</a>`;
                    staticPagesNav.innerHTML += aNav;
                });
            }
             // Store Logo in Nav
            const storeLogoNav = document.getElementById('store-logo-nav');
            if (settings.logoUrl) {
                storeLogoNav.innerHTML = `<img src="${settings.logoUrl}" alt="${settings.storeName || 'Deriv Bot Store'} Logo" class="h-8 w-auto">`;
            } else {
                storeLogoNav.textContent = settings.storeName || 'Deriv Bot Store';
            }
        }

        let relatedOffset = 0;
        const relatedLimit = 3;

        async function loadRelatedProducts(loadMore = false) {
            if (!currentProduct || !allProducts.length) return;

            const relatedGrid = document.getElementById('related-products-grid');
            const loadingRelatedDiv = document.getElementById('loading-related');

            if (loadMore) {
                loadingRelatedDiv.classList.remove('hidden');
            } else {
                relatedGrid.innerHTML = '';
                relatedOffset = 0;
            }

            let related = allProducts.filter(p => p.item !== currentProduct.item);
            if (currentProduct.category) {
                related.sort((a, b) => {
                    const aIsSameCategory = a.category === currentProduct.category;
                    const bIsSameCategory = b.category === currentProduct.category;
                    if (aIsSameCategory && !bIsSameCategory) return -1;
                    if (!aIsSameCategory && bIsSameCategory) return 1;
                    return 0; // You could add secondary sort criteria here, e.g., by date or popularity
                });
            }

            const productsToLoad = related.slice(relatedOffset, relatedOffset + relatedLimit);

            if (productsToLoad.length === 0 && loadMore) {
                if (loadingRelatedDiv) loadingRelatedDiv.textContent = 'No more products.';
                setTimeout(() => { if (loadingRelatedDiv) loadingRelatedDiv.classList.add('hidden'); }, 2000);
                return;
            }

            productsToLoad.forEach(product => {
                const card = document.createElement('div');
                card.className = 'product-card'; // Ensure this class is styled
                // Using textContent for safety, then href for link
                const titleEl = document.createElement('h3');
                titleEl.className = 'product-card-title';
                titleEl.textContent = product.name;

                const priceEl = document.createElement('p');
                priceEl.className = 'product-card-price';
                priceEl.textContent = `${product.price.toFixed(2)} USD`;

                const linkEl = document.createElement('a');
                linkEl.href = `/product.html?item=${product.item}`;
                linkEl.className = 'product-card-button';
                linkEl.textContent = 'View Details';

                const imgLinkEl = document.createElement('a');
                imgLinkEl.href = `/product.html?item=${product.item}`;
                const imgEl = document.createElement('img');
                imgEl.setAttribute('data-src', product.img);
                // Fallback src to prevent broken image icon before lazy load kicks in for some browsers
                imgEl.src = "data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==";
                imgEl.alt = product.name;
                imgEl.className = 'lazy';
                imgLinkEl.appendChild(imgEl);

                const contentDiv = document.createElement('div');
                contentDiv.className = 'product-card-content';
                contentDiv.appendChild(titleEl);
                contentDiv.appendChild(priceEl);
                contentDiv.appendChild(linkEl);

                card.appendChild(imgLinkEl);
                card.appendChild(contentDiv);
                relatedGrid.appendChild(card);
            });

            if (lazyLoadInstance) lazyLoadInstance.update();

            relatedOffset += productsToLoad.length;
            if (loadMore && loadingRelatedDiv) loadingRelatedDiv.classList.add('hidden');

            if (productsToLoad.length < relatedLimit && loadingRelatedDiv) {
                loadingRelatedDiv.textContent = 'All related products loaded.';
                loadingRelatedDiv.classList.remove('hidden');
                 setTimeout(() => loadingRelatedDiv.classList.add('hidden'), 3000);
            }
        }

        const observer = new IntersectionObserver((entries) => {
            if (entries[0].isIntersecting && document.getElementById('related-products-section').classList.contains('hidden') === false) {
                if (relatedOffset < allProducts.filter(p => p.item !== (currentProduct ? currentProduct.item : null)).length) {
                     loadRelatedProducts(true);
                } else {
                    const loadingRelatedDiv = document.getElementById('loading-related');
                    if(loadingRelatedDiv && !loadingRelatedDiv.classList.contains('hidden') && loadingRelatedDiv.textContent.includes("Loading")){
                         loadingRelatedDiv.textContent = 'No more products to load.';
                         setTimeout(() => loadingRelatedDiv.classList.add('hidden'), 3000);
                    }
                }
            }
        }, { threshold: 0.8 });

        async function initializeProductPage() {
            const urlParams = new URLSearchParams(window.location.search);
            const itemId = urlParams.get('item');
            const loadingDiv = document.getElementById('loading-product');
            const productContainer = document.getElementById('product-details-container');
            const relatedSection = document.getElementById('related-products-section');

            loadingDiv.classList.remove('hidden'); // Ensure loading message is visible initially
            productContainer.classList.add('hidden');
            relatedSection.classList.add('hidden');


            if (!itemId) {
                loadingDiv.innerHTML = `No product item specified. Please <a href="/index.html" class="text-green-600 underline hover:text-green-700">visit our store</a> to select a product.`;
                // Attempt to load shared elements like footer/nav for context
                try {
                    const response = await axios.get(`${BASE_URL}/api/data`); // Fetch settings for shared elements
                    settings = response.data.settings || {};
                    allStaticPages = response.data.staticPages || [];
                    populateSharedElements();
                } catch (e) { console.error("Could not load shared elements for error page:", e); }
                return;
            }

            const dataFetchedSuccessfully = await fetchProductPageData(itemId); // This function now sets currentProduct, allProducts, settings, staticPages

            if (dataFetchedSuccessfully && currentProduct) {
                populateProductData(); // Populates main product content, meta tags, schema
                populateSharedElements(); // Populates nav, footer

                loadingDiv.classList.add('hidden');
                productContainer.classList.remove('hidden');
                relatedSection.classList.remove('hidden');

                if (lazyLoadInstance) lazyLoadInstance.update();

                const loadingRelatedDiv = document.getElementById('loading-related');
                if(loadingRelatedDiv && allProducts.filter(p => p.item !== currentProduct.item).length > 0) { // Only observe if there are related products
                    observer.observe(loadingRelatedDiv);
                } else if (loadingRelatedDiv) {
                    loadingRelatedDiv.classList.add('hidden'); // Hide if no related products
                }
            } else {
                // fetchProductPageData or the check for currentProduct already handled the error message in loadingDiv.
                // Ensure main content areas remain hidden.
                productContainer.classList.add('hidden');
                relatedSection.classList.add('hidden');
                loadingDiv.classList.remove('hidden'); // Ensure error message is visible
                 // Attempt to load shared elements even on error
                if (Object.keys(settings).length > 0 || allStaticPages.length > 0) { // If settings were fetched by fetchProductPageData
                     populateSharedElements();
                } else { // If fetchProductPageData failed very early
                     try {
                        const response = await axios.get(`${BASE_URL}/api/data`);
                        settings = response.data.settings || {};
                        allStaticPages = response.data.staticPages || [];
                        populateSharedElements();
                    } catch (e) { console.error("Could not load shared elements for error page:", e); }
                }
            }
        }

        // --- START OF PORTED MODAL/PAYMENT FUNCTIONS FROM INDEX.HTML ---
        // Note: These functions are extensive. They need to be carefully integrated
        // and might require further adaptation for the product page context.
        // Their dependencies (HTML structure for modals, other helper functions)
        // also need to be present on this page.

        function showPaymentChoiceModal(product, kesPrice) {
            currentPaymentItem = product; // Ensure context is set
            currentPaymentKesPrice = kesPrice;
            currentPaymentUsdPrice = product.price.toFixed(2);

            const choiceModal = document.getElementById('payment-choice-modal');
            const productNameEl = choiceModal.querySelector('#payment-choice-product-name'); // Assuming IDs within modal
            const amountEl = choiceModal.querySelector('#payment-choice-amount');

            if (productNameEl) productNameEl.textContent = `Product: ${product.name}`;
            if (amountEl) amountEl.textContent = `Amount: ${kesPrice} KES (USD ${product.price.toFixed(2)})`;

            const manualMpesaChoiceBtn = choiceModal.querySelector('#manual-mpesa-choice');
            const payheroChoiceBtn = choiceModal.querySelector('#payhero-choice');
            const nowPaymentsChoiceBtn = choiceModal.querySelector('#nowpayments-choice');
            const cancelBtn = choiceModal.querySelector('#payment-choice-cancel');

            // Reset button states
            if (manualMpesaChoiceBtn) manualMpesaChoiceBtn.disabled = false;
            if (payheroChoiceBtn) payheroChoiceBtn.disabled = false;
            if (nowPaymentsChoiceBtn) {
                nowPaymentsChoiceBtn.disabled = false;
                nowPaymentsChoiceBtn.innerHTML = 'Pay with crypto';
            }
            if (cancelBtn) cancelBtn.disabled = false;

            const activeOptions = (settings && typeof settings.activePaymentOptions === 'object')
                                  ? settings.activePaymentOptions
                                  : { mpesa_manual: true, mpesa_payhero: true, crypto_nowpayments: true }; // Default

            let visibleButtonCount = 0;

            if (manualMpesaChoiceBtn) {
                if (activeOptions.mpesa_manual) {
                    manualMpesaChoiceBtn.classList.remove('hidden');
                    manualMpesaChoiceBtn.onclick = () => {
                        choiceModal.classList.add('hidden');
                        document.body.classList.remove('popup-active');
                        showPaymentModal(product, kesPrice);
                    };
                    visibleButtonCount++;
                } else {
                    manualMpesaChoiceBtn.classList.add('hidden');
                }
            }

            if (payheroChoiceBtn) {
                if (activeOptions.mpesa_payhero) {
                    payheroChoiceBtn.classList.remove('hidden');
                    payheroChoiceBtn.onclick = () => {
                        choiceModal.classList.add('hidden');
                        document.body.classList.remove('popup-active');
                        showPayHeroModal(product, kesPrice);
                    };
                    visibleButtonCount++;
                } else {
                    payheroChoiceBtn.classList.add('hidden');
                }
            }

            if (nowPaymentsChoiceBtn) {
                if (activeOptions.crypto_nowpayments) {
                    nowPaymentsChoiceBtn.classList.remove('hidden');
                    nowPaymentsChoiceBtn.innerHTML = 'Pay with crypto';
                    nowPaymentsChoiceBtn.onclick = async () => {
                        const originalButtonText = 'Pay with crypto';
                        nowPaymentsChoiceBtn.innerHTML = '<svg class="animate-spin h-5 w-5 mr-2 inline-block" viewBox="0 0 24 24" fill="none" stroke="currentColor"><circle cx="12" cy="12" r="10" stroke-width="4" class="opacity-25"></circle><path d="M4 12a8 8 0 018-8" stroke-width="4" class="opacity-75"></path></svg>Loading...';
                        nowPaymentsChoiceBtn.disabled = true;
                        if(manualMpesaChoiceBtn && activeOptions.mpesa_manual) manualMpesaChoiceBtn.disabled = true;
                        if(payheroChoiceBtn && activeOptions.mpesa_payhero) payheroChoiceBtn.disabled = true;
                        if(cancelBtn) cancelBtn.disabled = true;

                        try {
                            await showNowPaymentsModal(product, product.price);
                            choiceModal.classList.add('hidden');
                        } catch (error) {
                            console.error("Error preparing NOWPayments modal:", error);
                            alert("Could not load cryptocurrency payment option. Please try again or select another method.");
                            nowPaymentsChoiceBtn.innerHTML = originalButtonText;
                            nowPaymentsChoiceBtn.disabled = false;
                            if(manualMpesaChoiceBtn && activeOptions.mpesa_manual) manualMpesaChoiceBtn.disabled = false;
                            if(payheroChoiceBtn && activeOptions.mpesa_payhero) payheroChoiceBtn.disabled = false;
                            if(cancelBtn) cancelBtn.disabled = false;
                        }
                    };
                    visibleButtonCount++;
                } else {
                    nowPaymentsChoiceBtn.classList.add('hidden');
                }
            }

            if (visibleButtonCount === 0) {
                choiceModal.classList.add('hidden');
                document.body.classList.remove('popup-active');
                alert("No payment methods are currently available. Please contact support.");
                return;
            }

            choiceModal.classList.remove('hidden');
            document.body.classList.add('popup-active');

            if(cancelBtn) {
                cancelBtn.onclick = () => {
                    choiceModal.classList.add('hidden');
                    document.body.classList.remove('popup-active');
                };
            }
        }

        async function showPaymentModal(product, kesPrice) {
            currentPaymentItem = product;
            currentPaymentKesPrice = kesPrice;
            const modal = document.getElementById('payment-modal');

            const titleEl = modal.querySelector('#payment-title');
            const tillEl = modal.querySelector('#mpesa-till-number');
            const amountEl = modal.querySelector('#payment-amount');
            const confirmBtn = modal.querySelector('#confirm-payment');
            const cancelBtn = modal.querySelector('#payment-cancel');
            const copyTillBtn = modal.querySelector('#copy-till');
            const timerTextEl = modal.querySelector('#timer-text');
            const timerBarEl = modal.querySelector('#timer-bar');

            if(titleEl) titleEl.textContent = `Pay for ${product.name}`;
            if(tillEl) tillEl.textContent = settings.mpesaTill || '4933614';
            if(amountEl) amountEl.textContent = `Amount: ${kesPrice} KES`;

            modal.classList.remove('hidden');
            document.body.classList.add('popup-active');

            let timeLeft = 10 * 60;
            if (paymentTimerCountdown) clearInterval(paymentTimerCountdown);
            paymentTimerCountdown = setInterval(() => {
                if (timeLeft <= 0) {
                    clearInterval(paymentTimerCountdown);
                    modal.classList.add('hidden');
                    document.body.classList.remove('popup-active');
                    window.location.href = WHATSAPP_REDIRECT;
                    return;
                }
                const minutes = Math.floor(timeLeft / 60);
                const seconds = timeLeft % 60;
                if(timerTextEl) timerTextEl.textContent = `${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
                if(timerBarEl) {
                    const percentage = (timeLeft / (10 * 60)) * 100;
                    timerBarEl.style.width = `${percentage}%`;
                }
                timeLeft--;
            }, 1000);

            if(copyTillBtn) {
                copyTillBtn.onclick = () => {
                    const tillNumber = (settings.mpesaTill || '4933614');
                    navigator.clipboard.writeText(tillNumber).then(() => {
                        copyTillBtn.textContent = 'Copied';
                        setTimeout(() => { copyTillBtn.textContent = 'Copy Till'; }, 2000);
                    }).catch(err => console.error('Failed to copy till:', err));
                };
            }

            if(confirmBtn) {
                confirmBtn.onclick = () => {
                    clearInterval(paymentTimerCountdown);
                    const expiry = new Date(Date.now() + 5 * 60 * 1000).toUTCString();
                    document.cookie = `payment_${product.item}=initiated; expires=${expiry}; path=/; SameSite=Lax; Secure`;
                    localStorage.setItem(`payment_${product.item}_kesPrice`, kesPrice);
                    modal.classList.add('hidden');
                    document.body.classList.remove('popup-active');
                    showRefCodeModal(product, kesPrice);
                };
            }

            if(cancelBtn) {
                cancelBtn.onclick = () => {
                    clearInterval(paymentTimerCountdown);
                    modal.classList.add('hidden');
                    document.body.classList.remove('popup-active');
                };
            }
        }

        async function showPayHeroModal(product, kesPrice) {
            currentPaymentItem = product;
            currentPaymentKesPrice = kesPrice;
            const modal = document.getElementById('payhero-modal');
            const amountDisplay = modal.querySelector('#payhero-amount-display');
            const customerNameInput = modal.querySelector('#payhero-customer-name');
            const phoneNumberInput = modal.querySelector('#payhero-phone-number');
            const payheroStatusMessage = modal.querySelector('#payhero-status-message');
            const closeButton = modal.querySelector('#payhero-close-button');
            const proceedButton = modal.querySelector('#payhero-proceed-button');

            const roundedAmount = Math.round(parseFloat(kesPrice));
            if(amountDisplay) amountDisplay.textContent = roundedAmount.toFixed(2);
            if(payheroStatusMessage) payheroStatusMessage.textContent = '';
            if(proceedButton) proceedButton.disabled = false;
            if(customerNameInput) customerNameInput.value = '';
            if(phoneNumberInput) phoneNumberInput.value = '';

            modal.style.display = 'flex'; // Assuming index.html uses flex for this
            document.body.classList.add('popup-active');

            if(closeButton) {
                closeButton.onclick = () => {
                    modal.style.display = 'none';
                    document.body.classList.remove('popup-active');
                };
            }

            if(proceedButton) {
                proceedButton.onclick = async () => {
                    const phone = phoneNumberInput.value.trim();
                    const customerName = customerNameInput.value.trim() || "Valued Customer";

                    if (!phone) {
                        if(payheroStatusMessage) payheroStatusMessage.textContent = 'Please enter your Mpesa phone number.';
                        return;
                    }
                     if (!/^(01|07|2541|2547)\d{8}$/.test(phone.replace(/^\+/, ''))) {
                        if(payheroStatusMessage) payheroStatusMessage.textContent = 'Invalid Mpesa phone number format.';
                        return;
                    }

                    proceedButton.disabled = true;
                    if(payheroStatusMessage) payheroStatusMessage.textContent = 'Initiating payment...';

                    try {
                        const response = await fetchWithTimeout(`${BASE_URL}/api/initiate-server-stk-push`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                item: product.item,
                                amount_kes: roundedAmount,
                                phone: phone,
                                customerName: customerName,
                                used_exchange_rate: await getExchangeRate()
                            }),
                            credentials: 'include'
                        }, 20000);
                        const data = await response.json();
                        if (response.ok && data.success) {
                            if(payheroStatusMessage) payheroStatusMessage.textContent = data.message || 'STK Push initiated. Check your phone.';
                            setTimeout(() => {
                                modal.style.display = 'none';
                                if (data.serverReference) {
                                    showStatusModal(product, data.serverReference, 'Waiting for Mpesa payment confirmation via STK push...', true);
                                } else {
                                   if(payheroStatusMessage) payheroStatusMessage.textContent = 'Error: Missing transaction reference.';
                                   proceedButton.disabled = false; // Re-enable
                                }
                            }, 2500);
                        } else {
                            if(payheroStatusMessage) payheroStatusMessage.textContent = `Error: ${data.error || 'Failed to initiate payment.'}`;
                            proceedButton.disabled = false;
                        }
                    } catch (error) {
                        if(payheroStatusMessage) payheroStatusMessage.textContent = `Network error: ${error.message}.`;
                        proceedButton.disabled = false;
                    }
                };
            }
        }

        async function showNowPaymentsModal(product, usdPrice) {
            currentPaymentItem = product;
            currentPaymentUsdPrice = usdPrice;
            const modal = document.getElementById('nowpayments-modal');

            const titleEl = modal.querySelector('#nowpayments-title');
            const productNameEl = modal.querySelector('#nowpayments-product-name');
            const amountUsdEl = modal.querySelector('#nowpayments-amount-usd');
            const emailInput = modal.querySelector('#nowpayments-email');
            const currencySelect = modal.querySelector('#nowpayments-currency');
            const currencySearchInput = modal.querySelector('#nowpayments-currency-search');
            const proceedBtn = modal.querySelector('#nowpayments-proceed');
            const cancelBtn = modal.querySelector('#nowpayments-cancel');
            const paymentInfoSection = modal.querySelector('#nowpayments-payment-info');
            const statusMessageEl = modal.querySelector('#nowpayments-status-message');
            const timerDisplay = modal.querySelector('#nowpayments-timer');

            if(titleEl) titleEl.textContent = `Pay for ${product.name}`;
            if(productNameEl) productNameEl.textContent = `Product: ${product.name}`;
            if(amountUsdEl) amountUsdEl.textContent = `Amount: ${usdPrice.toFixed(2)} USD`;

            if(emailInput) emailInput.value = '';
            if(paymentInfoSection) paymentInfoSection.classList.add('hidden');
            if(statusMessageEl) statusMessageEl.textContent = '';
            if(proceedBtn) {
                 proceedBtn.disabled = true; // Disable until currencies load
                 proceedBtn.innerHTML = 'Loading Currencies...';
            }
            if(currencySearchInput) currencySearchInput.value = '';
            if(timerDisplay) timerDisplay.textContent = '';
            if (window.nowPaymentsTimerIntervalId) clearInterval(window.nowPaymentsTimerIntervalId);

            modal.classList.remove('hidden');
            document.body.classList.add('popup-active');

            try {
                const response = await fetchWithTimeout(`${BASE_URL}/api/nowpayments/currencies`, {}, 20000);
                if (!response.ok) throw new Error('Failed to load currencies.');
                const data = await response.json();
                if (data.success && data.currencies) {
                    populateCurrencyDropdown(data.currencies, currencySelect); // Pass currencySelect
                    if(proceedBtn) {
                        proceedBtn.disabled = false;
                        proceedBtn.innerHTML = 'Proceed to Payment';
                    }
                } else {
                    if(currencySelect) currencySelect.innerHTML = '<option value="">Error loading currencies.</option>';
                    if(statusMessageEl) statusMessageEl.textContent = data.error || 'Error loading currencies.';
                }
            } catch (error) {
                console.error('Error fetching NOWPayments currencies:', error);
                if(currencySelect) currencySelect.innerHTML = '<option value="">Error. Please try again.</option>';
                if(statusMessageEl) statusMessageEl.textContent = `Error: ${error.message}.`;
            }

            if(currencySearchInput && currencySelect) {
                currencySearchInput.oninput = () => {
                    const searchTerm = currencySearchInput.value.toLowerCase();
                    const options = currencySelect.options;
                    for (let i = 0; i < options.length; i++) {
                        if (options[i].value === "") continue;
                        options[i].style.display = options[i].text.toLowerCase().includes(searchTerm) ? '' : 'none';
                    }
                };
            }

            if(proceedBtn && emailInput && currencySelect) {
                proceedBtn.onclick = async () => {
                    const email = emailInput.value.trim();
                    const selectedCurrency = currencySelect.value;
                    if (!email || !/^\S+@\S+\.\S+$/.test(email)) {
                        if(statusMessageEl) statusMessageEl.textContent = 'Invalid email.'; return;
                    }
                    if (!selectedCurrency) {
                        if(statusMessageEl) statusMessageEl.textContent = 'Select a currency.'; return;
                    }
                    proceedBtn.disabled = true;
                    proceedBtn.innerHTML = 'Creating Payment...';
                    if(statusMessageEl) statusMessageEl.textContent = 'Please wait...';
                    try {
                        await initiateNowPaymentsPayment(product, email, selectedCurrency); // This function needs to be ported
                    } catch (error) {
                        if(statusMessageEl) statusMessageEl.textContent = `Error: ${error.message}`;
                        proceedBtn.disabled = false; proceedBtn.innerHTML = 'Proceed to Payment';
                    }
                };
            }
            if(cancelBtn) {
                cancelBtn.onclick = () => {
                    // Similar cancel logic as index.html
                    modal.classList.add('hidden');
                    document.body.classList.remove('popup-active');
                    if (window.nowPaymentsPollIntervalId) clearInterval(window.nowPaymentsPollIntervalId);
                    if (window.nowPaymentsTimerIntervalId) clearInterval(window.nowPaymentsTimerIntervalId);
                };
            }
        }

        function populateCurrencyDropdown(currencies, selectElement) { // Added selectElement param
            if (!selectElement) return;
            selectElement.innerHTML = '<option value="">Select a currency</option>';
            currencies.sort((a, b) => (a.name || "").localeCompare(b.name || "")).forEach(currency => {
                const option = document.createElement('option');
                option.value = currency.code;
                let displayText = `${currency.name} (${currency.code.toUpperCase()})`;
                if (currency.min_payment_amount) {
                     displayText += ` - Min: ${parseFloat(currency.min_payment_amount).toFixed(8)} ${currency.code.toUpperCase()}`;
                }
                option.textContent = displayText;
                selectElement.appendChild(option);
            });
        }

        async function initiateNowPaymentsPayment(product, email, currency) {
            // This function is one of the more complex ones from index.html.
            // It involves:
            // 1. Calling /api/nowpayments/create-payment
            // 2. Displaying payment address, amount, QR (if generated)
            // 3. Starting a timer
            // 4. Starting polling for payment status (handleNowPaymentsStatus)
            // It needs its dependent elements from the #nowpayments-modal to be correctly selected.
            const modal = document.getElementById('nowpayments-modal');
            const paymentInfoSection = modal.querySelector('#nowpayments-payment-info');
            const statusMessageEl = modal.querySelector('#nowpayments-status-message');
            const proceedBtn = modal.querySelector('#nowpayments-proceed');
            const timerDisplay = modal.querySelector('#nowpayments-timer');
            const payAmountEl = modal.querySelector('#nowpayments-pay-amount');
            const payCurrencyEl = modal.querySelector('#nowpayments-pay-currency');
            const payAddressEl = modal.querySelector('#nowpayments-pay-address');
            const copyAddressBtn = modal.querySelector('#nowpayments-copy-address');

            proceedBtn.innerHTML = 'Processing...'; // Update button state

            try {
                const response = await fetchWithTimeout(`${BASE_URL}/api/nowpayments/create-payment`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        item: product.item,
                        price_amount: currentPaymentUsdPrice, // Use stored USD price
                        price_currency: 'usd',
                        pay_currency: currency,
                        email: email,
                        order_description: product.name,
                    }),
                    credentials: 'include'
                });
                const data = await response.json();

                if (!response.ok || !data.success) {
                    let errorMessage = data.error || 'Failed to create NOWPayments payment.';
                    if (data.type === 'min_amount_error') { // Check for specific error type from backend
                         errorMessage = `Amount for ${product.name} (${currentPaymentUsdPrice} USD) is too low for ${data.currency}. Minimum: ${data.min_amount} ${data.currency}. Your order's equivalent: ~${data.estimated_amount} ${data.currency}.`;
                    }
                    throw new Error(errorMessage);
                }

                if(payAmountEl) payAmountEl.textContent = data.payment.pay_amount;
                if(payCurrencyEl) payCurrencyEl.textContent = data.payment.pay_currency.toUpperCase();
                if(payAddressEl) payAddressEl.textContent = data.payment.pay_address;

                if(copyAddressBtn) {
                    copyAddressBtn.onclick = () => {
                        navigator.clipboard.writeText(data.payment.pay_address).then(() => {
                            copyAddressBtn.innerHTML = 'Copied!';
                            setTimeout(() => copyAddressBtn.innerHTML = 'Copy Address', 2000);
                        }).catch(err => console.error('Failed to copy address', err));
                    };
                }

                if(paymentInfoSection) paymentInfoSection.classList.remove('hidden');
                if(statusMessageEl) statusMessageEl.textContent = 'Waiting for payment. Send funds to the address shown.';
                proceedBtn.innerHTML = 'Payment Initiated'; // Keep disabled

                let timeLeft = 20 * 60; // 20 minutes
                if (window.nowPaymentsTimerIntervalId) clearInterval(window.nowPaymentsTimerIntervalId);
                window.nowPaymentsTimerIntervalId = setInterval(() => {
                    if (timeLeft <= 0) {
                        clearInterval(window.nowPaymentsTimerIntervalId);
                        if(timerDisplay) timerDisplay.textContent = 'Expired';
                        if(statusMessageEl) statusMessageEl.textContent = 'Payment window expired. Try again.';
                        // Re-enable form elements
                        proceedBtn.disabled = false; proceedBtn.innerHTML = 'Proceed to Payment';
                        modal.querySelector('#nowpayments-email').disabled = false;
                        modal.querySelector('#nowpayments-currency').disabled = false;
                        modal.querySelector('#nowpayments-currency-search').disabled = false;
                        if(paymentInfoSection) paymentInfoSection.classList.add('hidden');
                        if(window.nowPaymentsPollIntervalId) clearInterval(window.nowPaymentsPollIntervalId);
                        return;
                    }
                    const minutes = Math.floor(timeLeft / 60);
                    const seconds = timeLeft % 60;
                    if(timerDisplay) timerDisplay.textContent = `Time left: ${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
                    timeLeft--;
                }, 1000);

                handleNowPaymentsStatus(data.orderId, product); // Start polling

            } catch (error) {
                 if(statusMessageEl) statusMessageEl.textContent = `Error: ${error.message}`;
                 proceedBtn.disabled = false; proceedBtn.innerHTML = 'Proceed to Payment';
                 modal.querySelector('#nowpayments-email').disabled = false;
                 modal.querySelector('#nowpayments-currency').disabled = false;
                 modal.querySelector('#nowpayments-currency-search').disabled = false;
            }
        }

        function handleNowPaymentsStatus(orderId, product) {
            // Ported from index.html - polls /api/nowpayments/payment-status/:orderId
            // Updates #nowpayments-status-message and handles download on success
            const modal = document.getElementById('nowpayments-modal');
            const statusMessageEl = modal.querySelector('#nowpayments-status-message');

            if (window.nowPaymentsPollIntervalId) clearInterval(window.nowPaymentsPollIntervalId);

            let pollCount = 0;
            const maxPolls = (20 * 60) / 5;

            window.nowPaymentsPollIntervalId = setInterval(async () => {
                pollCount++;
                 if (pollCount > maxPolls && window.nowPaymentsTimerIntervalId) {
                    return; // Let timer handle expiration
                }
                if (!window.nowPaymentsTimerIntervalId && !(statusMessageEl.textContent.toLowerCase().includes('finished') || statusMessageEl.textContent.toLowerCase().includes('confirmed'))) {
                    clearInterval(window.nowPaymentsPollIntervalId); return;
                }

                try {
                    const response = await fetchWithTimeout(`${BASE_URL}/api/nowpayments/payment-status/${orderId}`, {credentials: 'include'});
                    const data = await response.json();

                    if (!response.ok) {
                        if(statusMessageEl) statusMessageEl.textContent = `Error checking status: ${data.error || 'Unknown'}`;
                        return;
                    }
                    if(statusMessageEl) statusMessageEl.textContent = `Status: ${data.payment_status}. ${data.message || ''}`;

                    if (data.payment_status === 'finished' || data.current_local_status === 'confirmed_nowpayments') {
                        if(window.nowPaymentsTimerIntervalId) clearInterval(window.nowPaymentsTimerIntervalId);
                        if(modal.querySelector('#nowpayments-timer')) modal.querySelector('#nowpayments-timer').textContent = 'Payment Complete!';
                        clearInterval(window.nowPaymentsPollIntervalId);
                        if(statusMessageEl) statusMessageEl.textContent = 'Payment successful! Preparing download...';
                        if (data.downloadLink) {
                            await downloadFile(data.downloadLink, product.name); // downloadFile needs to be ported
                            setTimeout(() => {
                                modal.classList.add('hidden');
                                document.body.classList.remove('popup-active');
                            }, 2000);
                        } else {
                             if(statusMessageEl) statusMessageEl.textContent = 'Payment confirmed, but download link missing.';
                        }
                    } else if (['failed', 'refunded', 'expired'].includes(data.payment_status) || (data.current_local_status && data.current_local_status.startsWith('failed_nowpayments_'))) {
                        if(window.nowPaymentsTimerIntervalId) clearInterval(window.nowPaymentsTimerIntervalId);
                        if(modal.querySelector('#nowpayments-timer')) modal.querySelector('#nowpayments-timer').textContent = `Status: ${data.payment_status}`;
                        clearInterval(window.nowPaymentsPollIntervalId);
                        if(statusMessageEl) statusMessageEl.textContent = `Payment ${data.payment_status}. Try again.`;
                        // Re-enable form
                        modal.querySelector('#nowpayments-proceed').disabled = false;
                        modal.querySelector('#nowpayments-proceed').innerHTML = 'Proceed to Payment';
                        modal.querySelector('#nowpayments-email').disabled = false;
                        modal.querySelector('#nowpayments-currency').disabled = false;
                        modal.querySelector('#nowpayments-currency-search').disabled = false;
                        if(modal.querySelector('#nowpayments-payment-info')) modal.querySelector('#nowpayments-payment-info').classList.add('hidden');
                    }
                } catch (error) {
                    console.error('Error polling NOWPayments status:', error);
                    if(statusMessageEl) statusMessageEl.textContent = 'Error checking status.';
                }
            }, 5000);
        }

        function showRefCodeModal(product, kesPrice) {
            currentPaymentItem = product;
            currentPaymentKesPrice = kesPrice;
            const modal = document.getElementById('ref-code-modal');
            const refCodeInput = modal.querySelector('#ref-code-input');
            const submitBtn = modal.querySelector('#submit-ref-code');
            const cancelBtn = modal.querySelector('#ref-code-cancel');

            if(refCodeInput) refCodeInput.value = localStorage.getItem(`payment_${product.item}_refCode`) || '';
            modal.classList.remove('hidden');
            document.body.classList.add('popup-active');

            if(submitBtn && refCodeInput) {
                submitBtn.onclick = async () => {
                    const refCode = refCodeInput.value.trim();
                    if (!refCode.match(/^[A-Z0-9]{8,12}$/)) {
                        alert('Invalid MPESA ref code.'); return;
                    }
                    try {
                        const response = await fetchWithTimeout(`${BASE_URL}/api/submit-ref`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ item: product.item, refCode, amount: kesPrice, timestamp: new Date().toISOString() }),
                            credentials: 'include'
                        }, 15000);
                        const data = await response.json();
                        if (response.ok && data.success) {
                            localStorage.setItem(`payment_${product.item}_refCode`, refCode);
                            modal.classList.add('hidden');
                            document.body.classList.remove('popup-active');
                            showStatusModal(product, refCode); // showStatusModal needs porting
                        } else { throw new Error(data.error || 'Failed to submit ref code.'); }
                    } catch (error) {
                        alert(`Error: ${error.message}`);
                    }
                };
            }
            if(cancelBtn) {
                cancelBtn.onclick = () => {
                    modal.classList.add('hidden');
                    document.body.classList.remove('popup-active');
                };
            }
        }

        async function showStatusModal(product, refCode, initialMessage = 'Confirming payment...', showRetry = true) {
            currentPaymentItem = product;
            currentPaymentRefCode = refCode;
            const modal = document.getElementById('status-modal');
            const statusMessageEl = modal.querySelector('#status-message');
            const timerTextEl = modal.querySelector('#status-timer-text');
            const timerBarEl = modal.querySelector('#status-timer-bar');
            const retryBtn = modal.querySelector('#status-retry');

            if(statusMessageEl) statusMessageEl.innerHTML = initialMessage;
            modal.classList.remove('hidden');
            document.body.classList.add('popup-active');
            if(retryBtn) retryBtn.classList.add('hidden');

            let timeLeft = 5 * 60;
            let pollIntervalTime = 3;
            let elapsedSinceLastPoll = 0;
            let retryCount = 0;
            const maxRetries = 3;

            if (statusTimerCountdown) clearInterval(statusTimerCountdown);
            statusTimerCountdown = setInterval(async () => {
                if (timeLeft <= 0) {
                    clearInterval(statusTimerCountdown);
                    if(statusMessageEl) statusMessageEl.innerHTML = `Confirmation timed out. <a href="${WHATSAPP_REDIRECT}" class="text-green-600 underline">Contact support.</a>`;
                    if (showRetry && retryCount < maxRetries && retryBtn) {
                        retryBtn.classList.remove('hidden');
                        retryBtn.onclick = () => { /* ... retry logic ... */ };
                    } else {
                        setTimeout(() => { modal.classList.add('hidden'); document.body.classList.remove('popup-active'); clearPaymentCookie(product.item); window.location.href = WHATSAPP_REDIRECT; }, 3000);
                    }
                    return;
                }
                if(timerTextEl) timerTextEl.textContent = `${Math.floor(timeLeft/60)}:${(timeLeft%60)<10?'0':''}${timeLeft%60}`;
                if(timerBarEl) timerBarEl.style.width = `${(timeLeft / (5 * 60)) * 100}%`;

                elapsedSinceLastPoll++;
                if (refCode && elapsedSinceLastPoll >= pollIntervalTime) {
                    elapsedSinceLastPoll = 0;
                    try {
                        const statusRes = await fetchWithTimeout(`${BASE_URL}/api/order-status/${product.item}/${refCode}`, { credentials: 'include' }, 10000);
                        const data = await statusRes.json();
                        // ... (rest of status checking logic from index.html, adapted for elements within this modal) ...
                        if(statusMessageEl) statusMessageEl.innerHTML = data.message || `Polling status... (${data.status || 'Unknown'})`;

                        if (data.status === 'confirmed' || data.status === 'confirmed_server_stk') {
                            if (data.downloadLink) {
                                clearInterval(statusTimerCountdown);
                                if(statusMessageEl) statusMessageEl.textContent = data.message || 'Payment successful! Downloading...';
                                const downloadSuccess = await downloadFile(data.downloadLink, product.name);
                                if (downloadSuccess) {
                                    setTimeout(() => { modal.classList.add('hidden'); document.body.classList.remove('popup-active'); clearPaymentCookie(product.item);}, 2000);
                                } else { /* handle download init error */ }
                            } else { /* handle missing download link */ }
                        } else if (data.status && data.status.startsWith('failed_')) {
                             clearInterval(statusTimerCountdown);
                             // ... (failure logic from index.html) ...
                        }

                    } catch (error) { /* ... error handling ...*/ }
                }
                timeLeft--;
            }, 1000);
        }

        function clearPaymentCookie(item) {
          document.cookie = `payment_${item}=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/; SameSite=Lax; Secure`;
          localStorage.removeItem(`payment_${item}_refCode`);
          localStorage.removeItem(`payment_${item}_kesPrice`);
        }

        async function downloadFile(downloadLink, fileNameBase) {
            const modal = document.getElementById('download-progress-modal');
            const progressText = modal.querySelector('#download-progress-text');
            const progressFill = modal.querySelector('#download-progress-fill');
            const errorText = modal.querySelector('#download-error');

            modal.style.display = 'flex';
            document.body.classList.add('popup-active');
            if(progressText) progressText.textContent = 'Starting download...';
            if(errorText) errorText.style.display = 'none';
            if(progressFill) progressFill.style.width = '0%';

            return new Promise((resolve) => {
                const xhr = new XMLHttpRequest();
                xhr.open('GET', downloadLink, true);
                xhr.responseType = 'blob';
                xhr.withCredentials = true; // Important for signed URLs if they rely on cookies/session

                xhr.onprogress = (event) => { /* ... progress update ... */ };
                xhr.onload = () => {
                    if (xhr.status === 200) {
                        // ... (file download logic from index.html) ...
                        const contentDisposition = xhr.getResponseHeader('Content-Disposition');
                        let fileName = fileNameBase;
                        if (contentDisposition) {
                            const fileNameMatch = contentDisposition.match(/filename="?(.+)"?/i); // More robust regex
                            if (fileNameMatch && fileNameMatch[1]) fileName = fileNameMatch[1].replace(/"/g, '');
                        }
                        const url = window.URL.createObjectURL(xhr.response);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = fileName;
                        document.body.appendChild(a); a.click();
                        window.URL.revokeObjectURL(url); document.body.removeChild(a);
                        if(progressText) progressText.textContent = 'Download complete!';
                        setTimeout(() => { modal.style.display = 'none'; document.body.classList.remove('popup-active'); }, 1000);
                        resolve(true);
                    } else { /* ... error handling ... */ resolve(false); }
                };
                xhr.onerror = () => { /* ... error handling ... */ resolve(false);};
                xhr.send();
            });
        }

        function attachModalEventListeners() {
            // Payment Choice Modal
            const pcModal = document.getElementById('payment-choice-modal');
            if (pcModal) {
                const pcCancelBtn = pcModal.querySelector('#payment-choice-cancel');
                if (pcCancelBtn) pcCancelBtn.onclick = () => { pcModal.classList.add('hidden'); document.body.classList.remove('popup-active'); };
            }

            // NOWPayments Modal
            const npModal = document.getElementById('nowpayments-modal');
            if (npModal) {
                const npCancelBtn = npModal.querySelector('#nowpayments-cancel');
                 if (npCancelBtn) npCancelBtn.onclick = () => {
                    // Add confirm logic if payment is active, similar to index.html
                    npModal.classList.add('hidden'); document.body.classList.remove('popup-active');
                    if (window.nowPaymentsPollIntervalId) clearInterval(window.nowPaymentsPollIntervalId);
                    if (window.nowPaymentsTimerIntervalId) clearInterval(window.nowPaymentsTimerIntervalId);
                };
            }

            // Manual Mpesa Payment Modal
            const mpesaModal = document.getElementById('payment-modal');
            if (mpesaModal) {
                const mpesaCancelBtn = mpesaModal.querySelector('#payment-cancel');
                if (mpesaCancelBtn) mpesaCancelBtn.onclick = () => {
                    if(paymentTimerCountdown) clearInterval(paymentTimerCountdown);
                    mpesaModal.classList.add('hidden'); document.body.classList.remove('popup-active');
                };
            }

            // PayHero Modal
            const phModal = document.getElementById('payhero-modal');
            if (phModal) {
                const phCloseBtn = phModal.querySelector('#payhero-close-button');
                if (phCloseBtn) phCloseBtn.onclick = () => { phModal.style.display = 'none'; document.body.classList.remove('popup-active');};
            }

            // Ref Code Modal
            const rcModal = document.getElementById('ref-code-modal');
            if (rcModal) {
                const rcCancelBtn = rcModal.querySelector('#ref-code-cancel');
                if (rcCancelBtn) rcCancelBtn.onclick = () => { rcModal.classList.add('hidden'); document.body.classList.remove('popup-active'); };
            }

            // Status Modal: No explicit cancel, usually closes on timeout or success/failure action.
            // Download Progress Modal: Also closes programmatically.
        }

        // Make sure the HTML for modals in product.html is identical to index.html for these functions to work.
        // The placeholders in product.html need to be filled with the actual modal content from index.html.
        // --- END OF PORTED MODAL/PAYMENT FUNCTIONS ---

    </script>
</body>
</html>
