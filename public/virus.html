<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="BotBlitz Store Admin: Manage bots, orders, and settings for your trading bot marketplace.">
  <meta name="robots" content="noindex, nofollow"> <!-- Admin panel not for SEO -->
  <title>Admin Panel - BotBlitz Store</title>
  <link rel="icon" type="image/png" href="/favicon.png">
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.quilljs.com/1.3.7/quill.snow.css" rel="stylesheet">
  <script src="https://cdn.quilljs.com/1.3.7/quill.min.js"></script>
  <style>
    /* Prevent background scrolling when modals are active */
    body.modal-active {
      overflow: hidden;
    }
    /* Modal blur effect */
    body:has(#edit-modal:not(.hidden)) > *:not(#edit-modal) {
      filter: blur(5px);
    }
    /* Navigation styling */
    nav {
      background: linear-gradient(145deg, #ffffff, #f0f4f8);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
    .nav-link {
      transition: all 0.3s ease;
    }
    .nav-link:hover {
      color: #16a34a !important;
      transform: translateY(-2px);
    }
    .nav-link.border-green-500 {
      color: #16a34a !important;
    }
    /* Section styling */
    .section {
      background: linear-gradient(145deg, #ffffff, #f0f4f8);
      border-radius: 16px;
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
      transition: all 0.3s ease;
    }
    .section:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
    }
    /* Form inputs and labels */
    input, select {
      transition: all 0.3s ease;
      border-color: #d1d5db;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }
    input:focus, select:focus {
      border-color: #16a34a;
      box-shadow: 0 0 0 3px rgba(22, 163, 74, 0.1);
      outline: none;
    }
    label {
      font-weight: 500;
      color: #374151;
    }
    /* Buttons */
    button {
      transition: all 0.3s ease;
    }
    button.bg-green-600 {
      background: linear-gradient(90deg, #16a34a, #22c55e);
    }
    button.bg-green-600:hover {
      background: linear-gradient(90deg, #15803d, #16a34a);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(22, 163, 74, 0.3);
    }
    button.bg-blue-600 {
      background: linear-gradient(90deg, #2563eb, #3b82f6);
    }
    button.bg-blue-600:hover {
      background: linear-gradient(90deg, #1d4ed8, #2563eb);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
    }
    button.bg-red-600 {
      background: linear-gradient(90deg, #ef4444, #f87171);
    }
    button.bg-red-600:hover {
      background: linear-gradient(90deg, #dc2626, #ef4444);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
    }
    button.bg-gray-600 {
      background: linear-gradient(90deg, #6b7280, #9ca3af);
    }
    button.bg-gray-600:hover {
      background: linear-gradient(90deg, #4b5563, #6b7280);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(107, 114, 128, 0.3);
    }
    /* Upload progress bar */
    .upload-progress {
      width: 100%;
      height: 10px;
      background: #e5e7eb;
      border-radius: 8px;
      overflow: hidden;
      margin-top: 12px;
    }
    .upload-progress-bar {
      height: 100%;
      background: linear-gradient(90deg, #16a34a, #22c55e);
      width: 0;
      transition: width 0.3s ease;
    }
    /* List items */
    #bot-list li, #page-list li, #category-list li {
      background: #f9fafb;
      border-radius: 12px;
      transition: all 0.3s ease;
    }
    #bot-list li:hover, #page-list li:hover, #category-list li:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 15px rgba(0, 0, 0, 0.1);
    }
    /* Orders table */
    #orders-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1.5rem;
      background: #fff;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    }
    #orders-table th, #orders-table td {
      border: 1px solid #e5e7eb;
      padding: 1rem;
      text-align: left;
      font-size: 0.95rem;
      color: #374151;
    }
    #orders-table th {
      background: linear-gradient(90deg, #f3f3f3, #e5e7eb);
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: #1f2937;
    }
    #orders-table tr {
      transition: all 0.3s ease;
    }
    #orders-table tr:nth-child(even) {
      background: #f9fafb;
    }
    #orders-table tr:hover {
      background: #f0f4f8;
      transform: scale(1.01);
    }
    .status-select {
      background: #fff;
      border-radius: 8px;
      padding: 0.5rem;
      border: 1px solid #d1d5db;
      transition: all 0.3s ease;
    }
    .status-select:hover, .status-select:focus {
      border-color: #16a34a;
      box-shadow: 0 0 0 3px rgba(22, 163, 74, 0.1);
    }
    /* Modals */
    #edit-modal {
      background: rgba(0, 0, 0, 0.7);
      animation: fadeIn 0.3s ease-out;
    }
    #edit-modal > div {
      background: linear-gradient(145deg, #ffffff, #f0f4f8);
      border-radius: 16px;
      box-shadow: 0 8px 30px rgba(0, 0, 0, 0.15);
      transform: translateY(20px) scale(0.9);
      animation: popupFadeIn 0.5s ease-out forwards;
      max-width: 90%;
      width: 600px;
    }
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    @keyframes popupFadeIn {
      from { transform: translateY(20px) scale(0.9); opacity: 0; }
      to { transform: translateY(0) scale(1); opacity: 1; }
    }
    /* Close button */
    .close-modal {
      position: absolute;
      top: 1rem;
      right: 1rem;
      font-size: 1.5rem;
      color: #6b7280;
      cursor: pointer;
      transition: color 0.3s ease;
    }
    .close-modal:hover {
      color: #ef4444;
    }
    /* Quill editor */
    .ql-container {
      min-height: 150px;
      border-radius: 0 0 8px 8px;
      border: 1px solid #d1d5db;
    }
    .ql-toolbar {
      border-radius: 8px 8px 0 0;
      border: 1px solid #d1d5db;
      background: #f9fafb;
    }
    /* Dark mode */
    [data-theme="dark"] {
      background: #1f2937;
      color: #e5e7eb;
    }
    [data-theme="dark"] nav {
      background: linear-gradient(145deg, #1f2937, #374151);
    }
    [data-theme="dark"] .section {
      background: linear-gradient(145deg, #374151, #4b5563);
    }
    [data-theme="dark"] input, [data-theme="dark"] select, [data-theme="dark"] .ql-container, [data-theme="dark"] .ql-toolbar {
      background: #4b5563;
      color: #e5e7eb;
      border-color: #6b7280;
    }
    [data-theme="dark"] #orders-table {
      background: #374151;
    }
    [data-theme="dark"] #orders-table th {
      background: linear-gradient(90deg, #4b5563, #6b7280);
    }
    [data-theme="dark"] #orders-table tr:nth-child(even) {
      background: #4b5563;
    }
    [data-theme="dark"] #orders-table tr:hover {
      background: #6b7280;
    }
    [data-theme="dark"] .status-select {
      background: #4b5563;
      color: #e5e7eb;
    }
    /* Responsive */
    @media (max-width: 640px) {
      .section {
        padding: 1rem;
      }
      #orders-table {
        display: block;
        overflow-x: auto;
        white-space: nowrap;
      }
      #product-form, #edit-form {
        grid-template-columns: 1fr;
      }
      #edit-modal > div {
        width: 90%;
        padding: 1.5rem;
      }
    }
  </style>
</head>
<body class="bg-gray-100" data-theme="light">
  <!-- Navigation Bar (hidden on login page) -->
  <nav id="admin-nav" class="bg-white shadow-md sticky top-0 z-20 hidden">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex justify-between h-16">
        <div class="flex items-center">
          <h1 class="text-xl font-bold text-gray-800">BotBlitz Store Admin</h1>
          <div class="ml-6 flex space-x-4 sm:space-x-8">
            <a href="#add-bot" class="nav-link text-gray-500 hover:text-gray-900 px-1 pt-1 text-sm font-medium border-b-2 border-green-500">Add Bot</a>
            <a href="#manage-bots" class="nav-link text-gray-500 hover:text-gray-900 px-1 pt-1 text-sm font-medium">Manage Bots</a>
            <a href="#settings" class="nav-link text-gray-500 hover:text-gray-900 px-1 pt-1 text-sm font-medium">Settings</a>
            <a href="#static-pages" class="nav-link text-gray-500 hover:text-gray-900 px-1 pt-1 text-sm font-medium">Static Pages</a>
            <a href="#orders" class="nav-link text-gray-500 hover:text-gray-900 px-1 pt-1 text-sm font-medium">Orders</a>
          </div>
        </div>
        <div class="flex items-center">
          <button id="theme-toggle" class="text-gray-500 hover:text-gray-900 p-2">
            <svg id="theme-icon" class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path>
            </svg>
          </button>
          <button id="logout" class="text-gray-500 hover:text-gray-900 p-2 ml-2">Logout</button>
        </div>
      </div>
    </div>
  </nav>

  <!-- Login Page -->
  <div id="login-page" class="min-h-screen flex items-center justify-center">
    <div class="bg-white rounded-lg p-6 max-w-sm w-full shadow-md">
      <h3 class="text-xl font-bold text-gray-900 mb-4 text-center">BotBlitz Store Admin Login</h3>
      <div class="mb-4">
        <label for="login-email" class="block text-sm font-medium text-gray-700">Email</label>
        <input type="email" id="login-email" class="mt-1 w-full p-2 border rounded-md" required>
      </div>
      <div class="mb-4 relative">
        <label for="login-password" class="block text-sm font-medium text-gray-700">Password</label>
        <input type="password" id="login-password" class="mt-1 w-full p-2 border rounded-md" required>
        <button type="button" id="toggle-password" class="absolute right-2 top-9 text-gray-500 hover:text-green-600">Show</button>
      </div>
      <button id="login-submit" class="w-full bg-green-600 text-white py-2 rounded-md hover:bg-green-700">Login</button>
    </div>
  </div>

  <!-- Admin Panel (hidden on login) -->
  <main id="admin-panel" class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12 hidden">
    <!-- Add Bot Section -->
    <section id="add-bot" class="section bg-white rounded-lg shadow-md p-6 mb-8">
      <h2 class="text-xl font-semibold text-gray-900 mb-4">Add New Bot</h2>
      <form id="product-form" enctype="multipart/form-data">
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
          <div class="sm:col-span-2">
            <label for="name" class="block text-sm font-medium text-gray-700">Name (max 100 characters)</label>
            <input type="text" id="name" maxlength="100" required class="mt-1 w-full p-2 border rounded-md">
            <span id="name-counter" class="text-sm text-gray-500">100 characters remaining</span>
          </div>
          <div>
            <label for="price" class="block text-sm font-medium text-gray-700">Price (KES)</label>
            <input type="number" id="price" step="0.01" required class="mt-1 w-full p-2 border rounded-md">
          </div>
          <div>
            <label for="category" class="block text-sm font-medium text-gray-700">Category</label>
            <select id="category" required class="mt-1 w-full p-2 border rounded-md"></select>
          </div>
          <div class="sm:col-span-2">
            <label for="desc" class="block text-sm font-medium text-gray-700">Description</label>
            <div class="mt-1">
              <div id="desc-toolbar">
                <span class="ql-formats">
                  <button class="ql-bold"></button>
                  <button class="ql-italic"></button>
                  <button class="ql-underline"></button>
                  <button class="ql-link"></button>
                </span>
                <span class="ql-formats">
                  <button class="ql-list" value="ordered"></button>
                  <button class="ql-list" value="bullet"></button>
                </span>
                <button id="desc-code-toggle" class="ql-code-block">Code View</button>
              </div>
              <div id="desc-editor" class="border rounded-md"></div>
            </div>
          </div>
          <div class="sm:col-span-2">
            <label for="embed" class="block text-sm font-medium text-gray-700">Embed Link (Optional, e.g., YouTube)</label>
            <input type="url" id="embed" class="mt-1 w-full p-2 border rounded-md" placeholder="https://www.youtube.com/embed/VIDEO_ID">
          </div>
          <div class="sm:col-span-2">
            <label for="thumbnail" class="block text-sm font-medium text-gray-700">Thumbnail (1280x720)</label>
            <input type="file" id="thumbnail" accept="image/*" required class="mt-1 w-full p-2 border rounded-md">
            <div id="thumbnail-progress" class="upload-progress hidden">
              <div id="thumbnail-progress-bar" class="upload-progress-bar"></div>
            </div>
          </div>
          <div class="sm:col-span-2">
            <label for="bot-file" class="block text-sm font-medium text-gray-700">Bot File</label>
            <input type="file" id="bot-file" required class="mt-1 w-full p-2 border rounded-md">
            <div id="bot-file-progress" class="upload-progress hidden">
              <div id="bot-file-progress-bar" class="upload-progress-bar"></div>
            </div>
          </div>
          <div>
            <label class="flex items-center">
              <input type="checkbox" id="is-active" class="mr-2" checked>
              <span class="text-sm font-medium text-gray-700">Active</span>
            </label>
          </div>
        </div>
        <button type="submit" class="mt-6 w-full bg-green-600 text-white py-2 rounded-md hover:bg-green-700">Add Bot</button>
      </form>
    </section>

    <!-- Manage Bots Section -->
    <section id="manage-bots" class="section bg-white rounded-lg shadow-md p-6 mb-8 hidden">
      <h2 class="text-xl font-semibold text-gray-900 mb-4">Manage Bots</h2>
      <ul id="bot-list" class="space-y-4"></ul>
    </section>

    <!-- Settings Section -->
    <section id="settings" class="section bg-white rounded-lg shadow-md p-6 mb-8 hidden">
      <h2 class="text-xl font-semibold text-gray-900 mb-4">Settings</h2>
      <div class="mb-6">
        <h3 class="text-lg font-semibold text-gray-900 mb-2">Manage Categories</h3>
        <div class="flex gap-4 mb-4">
          <input type="text" id="new-category" class="w-full p-2 border rounded-md" placeholder="e.g., Volatility Bots">
          <button id="add-category" class="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700">Add Category</button>
        </div>
        <ul id="category-list" class="space-y-2"></ul>
      </div>
      <div class="mb-6">
        <label class="flex items-center">
          <input type="checkbox" id="urgent-toggle" class="mr-2">
          <span class="text-sm font-medium text-gray-700">Show Urgent Message (Pop-up on Front End)</span>
        </label>
        <div class="mt-2">
          <div id="urgent-toolbar">
            <span class="ql-formats">
              <button class="ql-bold"></button>
              <button class="ql-italic"></button>
              <button class="ql-underline"></button>
              <button class="ql-link"></button>
            </span>
            <span class="ql-formats">
              <button class="ql-list" value="ordered"></button>
              <button class="ql-list" value="bullet"></button>
            </span>
          </div>
          <div id="urgent-editor" class="border rounded-md"></div>
        </div>
        <button id="save-urgent" class="mt-2 bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700">Save Message</button>
      </div>
      <div class="mb-6">
        <label for="support-email" class="block text-sm font-medium text-gray-700">Support Email</label>
        <input type="email" id="support-email" class="mt-1 w-full p-2 border rounded-md">
        <button id="save-email" class="mt-2 bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700">Save Email</button>
      </div>
      <div class="mb-6">
        <label for="copyright-text" class="block text-sm font-medium text-gray-700">Footer Copyright Text</label>
        <input type="text" id="copyright-text" class="mt-1 w-full p-2 border rounded-md">
        <button id="save-copyright" class="mt-2 bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700">Save Copyright</button>
      </div>
      <div class="mb-6">
        <label for="logo-file" class="block text-sm font-medium text-gray-700">Logo</label>
        <input type="file" id="logo-file" accept="image/*" class="mt-1 w-full p-2 border rounded-md">
        <div id="logo-preview" class="mt-2"></div>
        <button id="save-logo" class="mt-2 bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700">Save Logo</button>
      </div>
      <div class="mb-6">
        <label for="mpesa-till" class="block text-sm font-medium text-gray-700">MPESA Till Number</label>
        <input type="text" id="mpesa-till" class="mt-1 w-full p-2 border rounded-md">
        <button id="save-mpesa-till" class="mt-2 bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700">Save Till Number</button>
      </div>
      <div class="mb-6">
        <h3 class="text-lg font-semibold text-gray-900 mb-2">Social Media Links</h3>
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
          <div>
            <label for="tiktok" class="block text-sm font-medium text-gray-700">TikTok URL</label>
            <input type="url" id="tiktok" class="mt-1 w-full p-2 border rounded-md">
            <label for="tiktok-logo" class="block text-sm font-medium text-gray-700 mt-2">TikTok Logo</label>
            <input type="file" id="tiktok-logo" accept="image/*" class="mt-1 w-full p-2 border rounded-md">
            <div id="tiktok-logo-preview" class="mt-2"></div>
            <button class="delete-social-logo mt-2 text-red-600 hover:text-red-700" data-platform="tiktok">Delete Logo</button>
          </div>
          <div>
            <label for="instagram" class="block text-sm font-medium text-gray-700">Instagram URL</label>
            <input type="url" id="instagram" class="mt-1 w-full p-2 border rounded-md">
            <label for="instagram-logo" class="block text-sm font-medium text-gray-700 mt-2">Instagram Logo</label>
            <input type="file" id="instagram-logo" accept="image/*" class="mt-1 w-full p-2 border rounded-md">
            <div id="instagram-logo-preview" class="mt-2"></div>
            <button class="delete-social-logo mt-2 text-red-600 hover:text-red-700" data-platform="instagram">Delete Logo</button>
          </div>
          <div>
            <label for="x" class="block text-sm font-medium text-gray-700">X URL</label>
            <input type="url" id="x" class="mt-1 w-full p-2 border rounded-md">
            <label for="x-logo" class="block text-sm font-medium text-gray-700 mt-2">X Logo</label>
            <input type="file" id="x-logo" accept="image/*" class="mt-1 w-full p-2 border rounded-md">
            <div id="x-logo-preview" class="mt-2"></div>
            <button class="delete-social-logo mt-2 text-red-600 hover:text-red-700" data-platform="x">Delete Logo</button>
          </div>
          <div>
            <label for="facebook" class="block text-sm font-medium text-gray-700">Facebook URL</label>
            <input type="url" id="facebook" class="mt-1 w-full p-2 border rounded-md">
            <label for="facebook-logo" class="block text-sm font-medium text-gray-700 mt-2">Facebook Logo</label>
            <input type="file" id="facebook-logo" accept="image/*" class="mt-1 w-full p-2 border rounded-md">
            <div id="facebook-logo-preview" class="mt-2"></div>
            <button class="delete-social-logo mt-2 text-red-600 hover:text-red-700" data-platform="facebook">Delete Logo</button>
          </div>
          <div>
            <label for="youtube" class="block text-sm font-medium text-gray-700">YouTube URL</label>
            <input type="url" id="youtube" class="mt-1 w-full p-2 border rounded-md">
            <label for="youtube-logo" class="block text-sm font-medium text-gray-700 mt-2">YouTube Logo</label>
            <input type="file" id="youtube-logo" accept="image/*" class="mt-1 w-full p-2 border rounded-md">
            <div id="youtube-logo-preview" class="mt-2"></div>
            <button class="delete-social-logo mt-2 text-red-600 hover:text-red-700" data-platform="youtube">Delete Logo</button>
          </div>
        </div>
        <button id="save-socials" class="mt-4 bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700">Save Socials</button>
      </div>
      <div class="mb-6">
        <label for="payment-method" class="block text-sm font-medium text-gray-700">Payment Method</label>
        <select id="payment-method" class="mt-1 w-full p-2 border rounded-md">
          <option value="payhero">PayHero</option>
          <option value="manual">Manual (MPESA Till)</option>
        </select>
        <button id="save-payment-method" class="mt-2 bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700">Save Payment Method</button>
      </div>
      <div class="mb-6">
        <label for="fallback-rate" class="block text-sm font-medium text-gray-700">Fallback Exchange Rate (KES/USD)</label>
        <input type="number" id="fallback-rate" step="0.01" class="mt-1 w-full p-2 border rounded-md">
        <button id="save-fallback-rate" class="mt-2 bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700">Save Rate</button>
      </div>
      <div>
        <h3 class="text-lg font-semibold text-gray-900 mb-2">Change Admin Credentials</h3>
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
          <div>
            <label for="new-email" class="block text-sm font-medium text-gray-700">New Email</label>
            <input type="email" id="new-email" class="mt-1 w-full p-2 border rounded-md">
          </div>
          <div>
            <label for="new-password" class="block text-sm font-medium text-gray-700">New Password</label>
            <input type="password" id="new-password" class="mt-1 w-full p-2 border rounded-md">
          </div>
          <div>
            <label for="confirm-password" class="block text-sm font-medium text-gray-700">Confirm Password</label>
            <input type="password" id="confirm-password" class="mt-1 w-full p-2 border rounded-md">
          </div>
        </div>
        <button id="change-credentials" class="mt-4 bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700">Change Credentials</button>
      </div>
    </section>

    <!-- Static Pages Section -->
    <section id="static-pages" class="section bg-white rounded-lg shadow-md p-6 hidden">
      <h2 class="text-xl font-semibold text-gray-900 mb-4">Manage Static Pages</h2>
      <p class="text-sm text-gray-600 mb-4">Use slugs like <code>/payment-modal</code> or <code>/ref-code-modal</code> for modals. Content supports HTML.</p>
      <div class="mb-6">
        <h3 class="text-lg font-semibold text-gray-900 mb-2">Add/Edit Page</h3>
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
          <div>
            <label for="page-title" class="block text-sm font-medium text-gray-700">Page Title</label>
            <input type="text" id="page-title" class="mt-1 w-full p-2 border rounded-md">
          </div>
          <div>
            <label for="page-slug" class="block text-sm font-medium text-gray-700">Slug (e.g., /my-page)</label>
            <input type="text" id="page-slug" class="mt-1 w-full p-2 border rounded-md" placeholder="/my-page">
          </div>
          <div>
            <label for="page-meta" class="block text-sm font-medium text-gray-700">Meta Description (max 140 characters)</label>
            <input type="text" id="page-meta" maxlength="140" class="mt-1 w-full p-2 border rounded-md">
            <span id="meta-counter" class="text-sm text-gray-500">140 characters remaining</span>
          </div>
          <div class="sm:col-span-2">
            <label for="page-content" class="block text-sm font-medium text-gray-700">Content</label>
            <div class="mt-1">
              <div id="page-toolbar">
                <span class="ql-formats">
                  <button class="ql-bold"></button>
                  <button class="ql-italic"></button>
                  <button class="ql-underline"></button>
                  <button class="ql-link"></button>
                </span>
                <span class="ql-formats">
                  <button class="ql-list" value="ordered"></button>
                  <button class="ql-list" value="bullet"></button>
                </span>
                <button id="page-code-toggle" class="ql-code-block">Code View</button>
              </div>
              <div id="page-editor" class="border rounded-md"></div>
            </div>
          </div>
        </div>
        <button id="add-page" class="mt-4 bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700">Add Page</button>
      </div>
      <ul id="page-list" class="space-y-4"></ul>
    </section>

    <!-- Orders Section -->
    <section id="orders" class="section bg-white rounded-lg shadow-md p-6 hidden">
      <h2 class="text-xl font-semibold text-gray-900 mb-4">Manage Orders</h2>
      <table id="orders-table">
        <thead>
          <tr>
            <th>Product</th>
            <th>Ref Code</th>
            <th>Amount (KES)</th>
            <th>Timestamp</th>
            <th>Status</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="order-list"></tbody>
      </table>
    </section>

    <!-- Edit Bot Modal -->
    <div id="edit-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
      <div class="bg-white rounded-lg p-6 max-w-lg w-full relative">
        <button class="close-modal" onclick="closeEditModal()">×</button>
        <h3 class="text-xl font-bold text-gray-900 mb-4">Edit Bot</h3>
        <form id="edit-form">
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
            <div class="sm:col-span-2">
              <label for="edit-name" class="block text-sm font-medium text-gray-700">Name (max 100 characters)</label>
              <input type="text" id="edit-name" maxlength="100" required class="mt-1 w-full p-2 border rounded-md">
              <span id="edit-name-counter" class="text-sm text-gray-500">100 characters remaining</span>
            </div>
            <div>
              <label for="edit-price" class="block text-sm font-medium text-gray-700">Price (KES)</label>
              <input type="number" id="edit-price" step="0.01" required class="mt-1 w-full p-2 border rounded-md">
            </div>
            <div>
              <label for="edit-category" class="block text-sm font-medium text-gray-700">Category</label>
              <select id="edit-category" required class="mt-1 w-full p-2 border rounded-md"></select>
            </div>
            <div class="sm:col-span-2">
              <label for="edit-desc" class="block text-sm font-medium text-gray-700">Description</label>
              <div class="mt-1">
                <div id="edit-desc-toolbar">
                  <span class="ql-formats">
                    <button class="ql-bold"></button>
                    <button class="ql-italic"></button>
                    <button class="ql-underline"></button>
                    <button class="ql-link"></button>
                  </span>
                  <span class="ql-formats">
                    <button class="ql-list" value="ordered"></button>
                    <button class="ql-list" value="bullet"></button>
                  </span>
                  <button id="edit-desc-code-toggle" class="ql-code-block">Code View</button>
                </div>
                <div id="edit-desc-editor" class="border rounded-md"></div>
              </div>
            </div>
            <div class="sm:col-span-2">
              <label for="edit-embed" class="block text-sm font-medium text-gray-700">Embed Link (Optional, e.g., YouTube)</label>
              <input type="url" id="edit-embed" class="mt-1 w-full p-2 border rounded-md" placeholder="https://www.youtube.com/embed/VIDEO_ID">
            </div>
            <div class="sm:col-span-2">
              <label for="edit-thumbnail" class="block text-sm font-medium text-gray-700">Thumbnail (1280x720)</label>
              <input type="file" id="edit-thumbnail" accept="image/*" class="mt-1 w-full p-2 border rounded-md">
              <div id="edit-thumbnail-preview" class="mt-2"></div>
            </div>
            <div class="sm:col-span-2">
              <label for="edit-bot-file" class="block text-sm font-medium text-gray-700">Bot File</label>
              <input type="file" id="edit-bot-file" class="mt-1 w-full p-2 border rounded-md">
              <div id="edit-bot-file-preview" class="mt-2"></div>
            </div>
            <div>
              <label class="flex items-center">
                <input type="checkbox" id="edit-is-active" class="mr-2">
                <span class="text-sm font-medium text-gray-700">Active</span>
              </label>
            </div>
          </div>
          <button type="submit" class="mt-6 w-full bg-green-600 text-white py-2 rounded-md hover:bg-green-700">Save Changes</button>
          <button type="button" id="edit-cancel" class="mt-2 w-full bg-gray-600 text-white py-2 rounded-md hover:bg-gray-700">Cancel</button>
        </form>
      </div>
    </div>

  <script>
    // Initialize Quill editors
    const descQuill = new Quill('#desc-editor', {
      theme: 'snow',
      modules: { toolbar: '#desc-toolbar' }
    });
    const editDescQuill = new Quill('#edit-desc-editor', {
      theme: 'snow',
      modules: { toolbar: '#edit-desc-toolbar' }
    });
    const urgentQuill = new Quill('#urgent-editor', {
      theme: 'snow',
      modules: { toolbar: '#urgent-toolbar' }
    });
    const pageQuill = new Quill('#page-editor', {
      theme: 'snow',
      modules: { toolbar: '#page-toolbar' }
    });

    // Code view toggles
    function setupCodeToggle(quill, toggleBtnId, editorId) {
      const toggleBtn = document.getElementById(toggleBtnId);
      const editor = document.querySelector(`#${editorId}`);
      let isCodeView = false;
      toggleBtn.addEventListener('click', () => {
        isCodeView = !isCodeView;
        if (isCodeView) {
          editor.style.display = 'none';
          const textarea = document.createElement('textarea');
          textarea.id = `${editorId}-code`;
          textarea.className = 'w-full p-2 border rounded-md';
          textarea.value = quill.root.innerHTML;
          editor.parentNode.appendChild(textarea);
          toggleBtn.textContent = 'Rich Text View';
        } else {
          const textarea = document.getElementById(`${editorId}-code`);
          quill.root.innerHTML = textarea.value;
          textarea.remove();
          editor.style.display = 'block';
          toggleBtn.textContent = 'Code View';
        }
      });
    }
    setupCodeToggle(descQuill, 'desc-code-toggle', 'desc-editor');
    setupCodeToggle(editDescQuill, 'edit-desc-code-toggle', 'edit-desc-editor');
    setupCodeToggle(pageQuill, 'page-code-toggle', 'page-editor');

    // Theme toggle
    function setTheme(theme) {
      document.body.setAttribute('data-theme', theme);
      localStorage.setItem('theme', theme);
      const icon = document.getElementById('theme-icon');
      icon.innerHTML = theme === 'dark' ?
        '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path>' :
        '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path>';
    }
    const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
    const savedTheme = localStorage.getItem('theme') || (prefersDark ? 'dark' : 'light');
    setTheme(savedTheme);
    document.getElementById('theme-toggle').addEventListener('click', () => {
      const currentTheme = document.body.getAttribute('data-theme');
      setTheme(currentTheme === 'light' ? 'dark' : 'light');
    });

    // Helper function for button feedback
    function showButtonFeedback(btn, actionText, originalText, duration = 2000) {
      btn.disabled = true;
      btn.textContent = actionText;
      setTimeout(() => {
        btn.disabled = false;
        btn.textContent = originalText;
      }, duration);
    }

    // Image compression
    async function compressImage(file, maxWidth = 1280, maxHeight = 720, quality = 0.8) {
      return new Promise((resolve, reject) => {
        const img = new Image();
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        img.src = URL.createObjectURL(file);
        img.onload = () => {
          let width = img.width;
          let height = img.height;
          if (width > maxWidth || height > maxHeight) {
            const ratio = Math.min(maxWidth / width, maxHeight / height);
            width *= ratio;
            height *= ratio;
          }
          canvas.width = width;
          canvas.height = height;
          ctx.drawImage(img, 0, 0, width, height);
          canvas.toBlob(blob => {
            resolve(new File([blob], file.name, { type: 'image/jpeg' }));
          }, 'image/jpeg', quality);
          URL.revokeObjectURL(img.src);
        };
        img.onerror = reject;
      });
    }

    // Check session
    async function checkSession() {
      try {
        const response = await fetch('/api/check-session', { credentials: 'include' });
        const result = await response.json();
        return result.isAuthenticated;
      } catch (error) {
        console.error('Error checking session:', error);
        return false;
      }
    }

    // Login handling
    document.getElementById('toggle-password').addEventListener('click', () => {
      const passwordInput = document.getElementById('login-password');
      const toggleBtn = document.getElementById('toggle-password');
      if (passwordInput.type === 'password') {
        passwordInput.type = 'text';
        toggleBtn.textContent = 'Hide';
      } else {
        passwordInput.type = 'password';
        toggleBtn.textContent = 'Show';
      }
    });

    document.getElementById('login-submit').addEventListener('click', async () => {
      const email = document.getElementById('login-email').value.trim();
      const password = document.getElementById('login-password').value.trim();
      const btn = document.getElementById('login-submit');
      showButtonFeedback(btn, 'Logging in...', 'Login');

      try {
        const response = await fetch('/api/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, password }),
          credentials: 'include'
        });
        const result = await response.json();
        if (result.success) {
          document.getElementById('login-page').classList.add('hidden');
          document.getElementById('admin-panel').classList.remove('hidden');
          document.getElementById('admin-nav').classList.remove('hidden');
          initialize();
        } else {
          alert('Invalid credentials. Please try again.');
        }
      } catch (error) {
        console.error('Error logging in:', error);
        alert('Failed to login. Please try again.');
      }
    });

    // Logout
    document.getElementById('logout').addEventListener('click', async () => {
      try {
        await fetch('/api/logout', { method: 'POST', credentials: 'include' });
        document.getElementById('admin-panel').classList.add('hidden');
        document.getElementById('admin-nav').classList.add('hidden');
        document.getElementById('login-page').classList.remove('hidden');
        document.getElementById('login-email').value = '';
        document.getElementById('login-password').value = '';
      } catch (error) {
        console.error('Error logging out:', error);
        alert('Failed to logout. Please try again.');
      }
    });

    // Navigation
    document.querySelectorAll('.nav-link').forEach(link => {
      link.addEventListener('click', e => {
        e.preventDefault();
        document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('border-b-2', 'border-green-500'));
        link.classList.add('border-b-2', 'border-green-500');
        document.querySelectorAll('.section').forEach(s => s.classList.add('hidden'));
        document.getElementById(link.getAttribute('href').slice(1)).classList.remove('hidden');
        if (link.getAttribute('href') === '#orders') {
          fetchOrders();
        }
      });
    });

    // Fetch orders
    async function fetchOrders() {
      try {
        const response = await fetch('/api/orders', { credentials: 'include' });
        if (!response.ok) throw new Error('Failed to fetch orders');
        const result = await response.json();
        if (result.success) {
          orders = result.orders;
          renderOrders();
        } else {
          throw new Error(result.error || 'Failed to fetch orders');
        }
      } catch (error) {
        console.error('Error fetching orders:', error);
        alert('Failed to load orders. Please try again.');
      }
    }

    // Render orders
    let orders = [];
    function renderOrders() {
      const orderList = document.getElementById('order-list');
      orderList.innerHTML = '';
      orders.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
      orders.forEach(order => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${order.product_name}</td>
          <td>${order.ref_code}</td>
          <td>${order.amount_kes}</td>
          <td>${new Date(order.created_at).toLocaleString()}</td>
          <td>${order.status}</td>
          <td>
            <select class="status-select border rounded-md p-1" data-id="${order.id}">
              <option value="" selected disabled>Update Status</option>
              <option value="confirmed">Confirmed</option>
              <option value="no payment">No Payment</option>
              <option value="partial payment">Partial Payment</option>
            </select>
          </td>
        `;
        orderList.appendChild(row);
      });

      document.querySelectorAll('.status-select').forEach(select => {
        select.addEventListener('change', async () => {
          const id = select.dataset.id;
          const status = select.value;
          const originalText = select.value;
          showButtonFeedback(select, 'Updating...', originalText);

          try {
            const response = await fetch('/api/update-order-status', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ id, status }),
              credentials: 'include'
            });
            const result = await response.json();
            if (result.success) {
              await fetchOrders();
              alert(`Order status updated to "${status}"!`);
            } else {
              throw new Error(result.error || 'Failed to update order status');
            }
          } catch (error) {
            console.error('Error updating order status:', error);
            alert('Failed to update order status. Please try again.');
          }
        });
      });
    }

    // Orders polling
    function startOrdersPolling() {
      setInterval(async () => {
        const ordersSection = document.getElementById('orders');
        const isOrdersActive = !ordersSection.classList.contains('hidden');
        const isModalOpen = !document.getElementById('edit-modal').classList.contains('hidden');
        if (isOrdersActive && !isModalOpen) {
          await fetchOrders();
        }
      }, 5000);
    }

    // Add bot
    document.getElementById('product-form').addEventListener('submit', async e => {
      e.preventDefault();
      const btn = e.submitter;
      showButtonFeedback(btn, 'Uploading...', 'Add Bot');

      const name = document.getElementById('name').value.trim();
      const price = parseFloat(document.getElementById('price').value);
      const category = document.getElementById('category').value;
      const description = descQuill.root.innerHTML;
      const embed = document.getElementById('embed').value.trim();
      const thumbnail = document.getElementById('thumbnail').files[0];
      const botFile = document.getElementById('bot-file').files[0];
      const isActive = document.getElementById('is-active').checked;

      if (!name || !price || !category || !description || !thumbnail || !botFile) {
        alert('Please fill in all required fields.');
        return;
      }

      const compressedThumbnail = await compressImage(thumbnail);
      const formData = new FormData();
      formData.append('name', name);
      formData.append('price', price);
      formData.append('category_id', category);
      formData.append('description', description);
      formData.append('embed_link', embed);
      formData.append('thumbnail', compressedThumbnail);
      formData.append('bot_file', botFile);
      formData.append('is_active', isActive);

      const thumbnailProgress = document.getElementById('thumbnail-progress-bar');
      const botFileProgress = document.getElementById('bot-file-progress-bar');
      const thumbnailContainer = document.getElementById('thumbnail-progress');
      const botFileContainer = document.getElementById('bot-file-progress');
      thumbnailContainer.classList.remove('hidden');
      botFileContainer.classList.remove('hidden');
      thumbnailProgress.style.width = '0%';
      botFileProgress.style.width = '0%';

      const xhr = new XMLHttpRequest();
      xhr.open('POST', '/api/add-bot', true);

      xhr.upload.onprogress = event => {
        if (event.lengthComputable) {
          const percent = (event.loaded / event.total) * 100;
          thumbnailProgress.style.width = `${percent}%`;
          botFileProgress.style.width = `${percent}%`;
        }
      };

      xhr.onload = async () => {
        thumbnailContainer.classList.add('hidden');
        botFileContainer.classList.add('hidden');
        if (xhr.status === 200) {
          const result = JSON.parse(xhr.responseText);
          if (result.success) {
            document.getElementById('product-form').reset();
            descQuill.setContents([]);
            await fetchData();
            renderBots();
            alert('Bot added successfully!');
          } else {
            throw new Error(result.error || 'Failed to add bot');
          }
        } else {
          throw new Error('Upload failed');
        }
      };

      xhr.onerror = () => {
        thumbnailContainer.classList.add('hidden');
        botFileContainer.classList.add('hidden');
        alert('Error uploading bot. Please try again.');
      };

      xhr.send(formData);
    });

    // Fetch data
    let data = { products: [], categories: [], settings: {}, social_links: [], static_pages: [] };
    async function fetchData() {
      try {
        const response = await fetch('/api/data', { credentials: 'include' });
        if (!response.ok) throw new Error('Failed to fetch data');
        data = await response.json();
        return true;
      } catch (error) {
        console.error('Error fetching data:', error);
        alert('Failed to load data. Please try again.');
        return false;
      }
    }

    // Render bots
    function renderBots() {
      const botList = document.getElementById('bot-list');
      botList.innerHTML = '';
      data.products.forEach(product => {
        const li = document.createElement('li');
        li.className = 'bg-gray-50 p-4 rounded-md flex justify-between items-center';
        li.innerHTML = `
          <div>
            <h3 class="text-lg font-medium text-gray-900">${product.name}</h3>
            <p class="text-sm text-gray-600">ID: ${product.id} | Price: KES ${product.price_kes} | Active: ${product.is_active ? 'Yes' : 'No'}</p>
          </div>
          <div class="space-x-2">
            <button class="edit-bot bg-blue-600 text-white px-3 py-1 rounded-md hover:bg-blue-700" data-id="${product.id}">Edit</button>
            <button class="delete-bot bg-red-600 text-white px-3 py-1 rounded-md hover:bg-red-700" data-id="${product.id}">Delete</button>
          </div>
        `;
        botList.appendChild(li);
      });

      document.querySelectorAll('.edit-bot').forEach(btn => {
        btn.addEventListener('click', () => {
          const id = btn.dataset.id;
          const product = data.products.find(p => p.id === id);
          if (!product) {
            alert('Bot not found. Please refresh and try again.');
            return;
          }
          document.getElementById('edit-name').value = product.name;
          document.getElementById('edit-price').value = product.price_kes;
          editDescQuill.root.innerHTML = product.description;
          document.getElementById('edit-embed').value = product.embed_link || '';
          document.getElementById('edit-category').value = product.category_id;
          document.getElementById('edit-is-active').checked = product.is_active;
          document.getElementById('edit-thumbnail-preview').innerHTML = `<img src="${product.thumbnail_url}" alt="Thumbnail" class="w-32 h-auto rounded-md">`;
          document.getElementById('edit-bot-file-preview').innerHTML = `<span>Current: ${product.file_url.split('/').pop()}</span>`;
          document.getElementById('edit-form').dataset.id = id;
          document.getElementById('edit-modal').classList.remove('hidden');
          document.body.classList.add('modal-active');
        });
      });

      document.querySelectorAll('.delete-bot').forEach(btn => {
        btn.addEventListener('click', async () => {
          if (!confirm('Are you sure you want to delete this bot?')) return;
          showButtonFeedback(btn, 'Deleting...', 'Delete');
          const id = btn.dataset.id;
          try {
            const response = await fetch('/api/delete-bot', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ id }),
              credentials: 'include'
            });
            const result = await response.json();
            if (result.success) {
              await fetchData();
              renderBots();
              alert('Bot deleted successfully!');
            } else {
              throw new Error(result.error || 'Failed to delete bot');
            }
          } catch (error) {
            console.error('Error deleting bot:', error);
            alert('Failed to delete bot. Please try again.');
          }
        });
      });
    }

    // Edit bot
    document.getElementById('edit-form').addEventListener('submit', async e => {
      e.preventDefault();
      const btn = e.submitter;
      showButtonFeedback(btn, 'Saving...', 'Save Changes');

      const id = document.getElementById('edit-form').dataset.id;
      const name = document.getElementById('edit-name').value.trim();
      const price = parseFloat(document.getElementById('edit-price').value);
      const category = document.getElementById('edit-category').value;
      const description = editDescQuill.root.innerHTML;
      const embed = document.getElementById('edit-embed').value.trim();
      const thumbnail = document.getElementById('edit-thumbnail').files[0];
      const botFile = document.getElementById('edit-bot-file').files[0];
      const isActive = document.getElementById('edit-is-active').checked;

      const formData = new FormData();
      formData.append('id', id);
      formData.append('name', name);
      formData.append('price', price);
      formData.append('category_id', category);
      formData.append('description', description);
      formData.append('embed_link', embed);
      formData.append('is_active', isActive);
      if (thumbnail) formData.append('thumbnail', await compressImage(thumbnail));
      if (botFile) formData.append('bot_file', botFile);

      try {
        const response = await fetch('/api/update-bot', {
          method: 'POST',
          body: formData,
          credentials: 'include'
        });
        const result = await response.json();
        if (result.success) {
          await fetchData();
          renderBots();
          closeEditModal();
          alert('Bot updated successfully!');
        } else {
          throw new Error(result.error || 'Failed to update bot');
        }
      } catch (error) {
        console.error('Error updating bot:', error);
        alert('Failed to update bot. Please try again.');
      }
    });

    function closeEditModal() {
      document.getElementById('edit-modal').classList.add('hidden');
      document.body.classList.remove('modal-active');
      document.getElementById('edit-form').reset();
      editDescQuill.setContents([]);
      document.getElementById('edit-thumbnail-preview').innerHTML = '';
      document.getElementById('edit-bot-file-preview').innerHTML = '';
    }
    document.getElementById('edit-cancel').addEventListener('click', closeEditModal);

    // Categories
    function renderCategories() {
      const categoryList = document.getElementById('category-list');
      const categorySelect = document.getElementById('category');
      const editCategorySelect = document.getElementById('edit-category');
      categoryList.innerHTML = '';
      categorySelect.innerHTML = '<option value="" disabled selected>Select a category</option>';
      editCategorySelect.innerHTML = '<option value="" disabled selected>Select a category</option>';
      data.categories.forEach(cat => {
        const li = document.createElement('li');
        li.className = 'flex justify-between items-center bg-gray-50 p-2 rounded-md';
        li.innerHTML = `
          <span>${cat.name}</span>
          <button class="delete-category bg-red-600 text-white px-2 py-1 rounded-md hover:bg-red-700" data-id="${cat.id}">Delete</button>
        `;
        categoryList.appendChild(li);
        categorySelect.innerHTML += `<option value="${cat.id}">${cat.name}</option>`;
        editCategorySelect.innerHTML += `<option value="${cat.id}">${cat.name}</option>`;
      });

      document.querySelectorAll('.delete-category').forEach(btn => {
        btn.addEventListener('click', async () => {
          if (!confirm('Are you sure you want to delete this category?')) return;
          showButtonFeedback(btn, 'Deleting...', 'Delete');
          const id = btn.dataset.id;
          try {
            const response = await fetch('/api/delete-category', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ id }),
              credentials: 'include'
            });
            const result = await response.json();
            if (result.success) {
              await fetchData();
              renderCategories();
              renderBots();
              alert('Category deleted successfully!');
            } else {
              throw new Error(result.error || 'Failed to delete category');
            }
          } catch (error) {
            console.error('Error deleting category:', error);
            alert('Failed to delete category. Please try again.');
          }
        });
      });
    }

    document.getElementById('add-category').addEventListener('click', async () => {
      const btn = document.getElementById('add-category');
      showButtonFeedback(btn, 'Adding...', 'Add Category');
      const name = document.getElementById('new-category').value.trim();
      if (!name) {
        alert('Category name is required.');
        return;
      }
      try {
        const response = await fetch('/api/add-category', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name }),
          credentials: 'include'
        });
        const result = await response.json();
        if (result.success) {
          await fetchData();
          renderCategories();
          document.getElementById('new-category').value = '';
          alert('Category added successfully!');
        } else {
          throw new Error(result.error || 'Failed to add category');
        }
      } catch (error) {
        console.error('Error adding category:', error);
        alert('Failed to add category. Please try again.');
      }
    });

    // Settings
    document.getElementById('urgent-toggle').addEventListener('change', () => {
      urgentQuill.enable(document.getElementById('urgent-toggle').checked);
    });

    document.getElementById('save-urgent').addEventListener('click', async () => {
      const btn = document.getElementById('save-urgent');
      showButtonFeedback(btn, 'Saving...', 'Save Message');
      try {
        const response = await fetch('/api/update-settings', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            urgent_message: {
              enabled: document.getElementById('urgent-toggle').checked,
              text: urgentQuill.root.innerHTML
            }
          }),
          credentials: 'include'
        });
        const result = await response.json();
        if (result.success) {
          await fetchData();
          alert('Urgent message saved!');
        } else {
          throw new Error(result.error || 'Failed to save urgent message');
        }
      } catch (error) {
        console.error('Error saving urgent message:', error);
        alert('Failed to save urgent message. Please try again.');
      }
    });

    document.getElementById('save-email').addEventListener('click', async () => {
      const btn = document.getElementById('save-email');
      showButtonFeedback(btn, 'Saving...', 'Save Email');
      try {
        const response = await fetch('/api/update-settings', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            support_email: document.getElementById('support-email').value.trim()
          }),
          credentials: 'include'
        });
        const result = await response.json();
        if (result.success) {
          await fetchData();
          alert('Support email saved!');
        } else {
          throw new Error(result.error || 'Failed to save email');
        }
      } catch (error) {
        console.error('Error saving email:', error);
        alert('Failed to save email. Please try again.');
      }
    });

    document.getElementById('save-copyright').addEventListener('click', async () => {
      const btn = document.getElementById('save-copyright');
      showButtonFeedback(btn, 'Saving...', 'Save Copyright');
      try {
        const response = await fetch('/api/update-settings', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            footer_copyright: document.getElementById('copyright-text').value.trim()
          }),
          credentials: 'include'
        });
        const result = await response.json();
        if (result.success) {
          await fetchData();
          alert('Copyright text saved!');
        } else {
          throw new Error(result.error || 'Failed to save copyright');
        }
      } catch (error) {
        console.error('Error saving copyright:', error);
        alert('Failed to save copyright. Please try again.');
      }
    });

    document.getElementById('save-logo').addEventListener('click', async () => {
      const btn = document.getElementById('save-logo');
      showButtonFeedback(btn, 'Saving...', 'Save Logo');
      const file = document.getElementById('logo-file').files[0];
      if (!file) {
        alert('Please select a logo file.');
        return;
      }
      const formData = new FormData();
      formData.append('logo', await compressImage(file));
      try {
        const response = await fetch('/api/update-logo', {
          method: 'POST',
          body: formData,
          credentials: 'include'
        });
        const result = await response.json();
        if (result.success) {
          await fetchData();
          document.getElementById('logo-preview').innerHTML = `<img src="${result.logo_url}" alt="Logo" class="w-32 h-auto rounded-md">`;
          alert('Logo saved!');
        } else {
          throw new Error(result.error || 'Failed to save logo');
        }
      } catch (error) {
        console.error('Error saving logo:', error);
        alert('Failed to save logo. Please try again.');
      }
    });

    document.getElementById('save-mpesa-till').addEventListener('click', async () => {
      const btn = document.getElementById('save-mpesa-till');
      showButtonFeedback(btn, 'Saving...', 'Save Till Number');
      try {
        const response = await fetch('/api/update-settings', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            mpesa_till_number: document.getElementById('mpesa-till').value.trim()
          }),
          credentials: 'include'
        });
        const result = await response.json();
        if (result.success) {
          await fetchData();
          alert('MPESA Till Number saved!');
        } else {
          throw new Error(result.error || 'Failed to save till number');
        }
      } catch (error) {
        console.error('Error saving till number:', error);
        alert('Failed to save till number. Please try again.');
      }
    });

    document.getElementById('save-socials').addEventListener('click', async () => {
      const btn = document.getElementById('save-socials');
      showButtonFeedback(btn, 'Saving...', 'Save Socials');
      const socials = {
        tiktok: { url: document.getElementById('tiktok').value.trim() },
        instagram: { url: document.getElementById('instagram').value.trim() },
        x: { url: document.getElementById('x').value.trim() },
        facebook: { url: document.getElementById('facebook').value.trim() },
        youtube: { url: document.getElementById('youtube').value.trim() }
      };
      ['tiktok', 'instagram', 'x', 'facebook', 'youtube'].forEach(platform => {
        const file = document.getElementById(`${platform}-logo`).files[0];
        if (file) socials[platform].logo = file;
      });

      const formData = new FormData();
      Object.keys(socials).forEach(platform => {
        formData.append(`${platform}_url`, socials[platform].url);
        if (socials[platform].logo) formData.append(`${platform}_logo`, socials[platform].logo);
      });

      try {
const response = await fetch('/api/update-socials', {
method: 'POST',
body: formData,
credentials: 'include'
});
const result = await response.json();
if (result.success) {
await fetchData();
['tiktok', 'instagram', 'x', 'facebook', 'youtube'].forEach(platform => {
const url = data.social_links.find(link => link.platform === platform)?.url;
const logo_url = data.social_links.find(link => link.platform === platform)?.logo_url;
document.getElementById(platform).value = url || '';
document.getElementById(${platform}-logo-preview).innerHTML = logo_url ? <img src="${logo_url}" alt="${platform} logo" class="w-16 h-16 rounded-md"> : '';
});
alert('Social links saved!');
} else {
throw new Error(result.error || 'Failed to save social links');
}
} catch (error) {
console.error('Error saving social links:', error);
alert('Failed to save social links. Please try again.');
}
});

document.querySelectorAll('.delete-social-logo').forEach(btn => {
btn.addEventListener('click', async () => {
const platform = btn.dataset.platform;
if (!confirm(Are you sure you want to delete the ${platform} logo?)) return;
showButtonFeedback(btn, 'Deleting...', 'Delete Logo');
try {
const response = await fetch('/api/delete-social-logo', {
method: 'POST',
headers: { 'Content-Type': 'application/json' },
body: JSON.stringify({ platform }),
credentials: 'include'
});
const result = await response.json();
if (result.success) {
await fetchData();
document.getElementById(${platform}-logo-preview).innerHTML = '';
alert(${platform} logo deleted successfully!);
} else {
throw new Error(result.error || Failed to delete ${platform} logo);
}
} catch (error) {
console.error(Error deleting ${platform} logo:, error);
alert(Failed to delete ${platform} logo. Please try again.);
}
});
});

document.getElementById('save-payment-method').addEventListener('click', async () => {
const btn = document.getElementById('save-payment-method');
showButtonFeedback(btn, 'Saving...', 'Save Payment Method');
try {
const response = await fetch('/api/update-settings', {
method: 'POST',
headers: { 'Content-Type': 'application/json' },
body: JSON.stringify({
payment_method: document.getElementById('payment-method').value
}),
credentials: 'include'
});
const result = await response.json();
if (result.success) {
await fetchData();
alert('Payment method saved!');
} else {
throw new Error(result.error || 'Failed to save payment method');
}
} catch (error) {
console.error('Error saving payment method:', error);
alert('Failed to save payment method. Please try again.');
}
});

document.getElementById('save-fallback-rate').addEventListener('click', async () => {
const btn = document.getElementById('save-fallback-rate');
showButtonFeedback(btn, 'Saving...', 'Save Rate');
try {
const response = await fetch('/api/update-settings', {
method: 'POST',
headers: { 'Content-Type': 'application/json' },
body: JSON.stringify({
fallback_exchange_rate: parseFloat(document.getElementById('fallback-rate').value)
}),
credentials: 'include'
});
const result = await response.json();
if (result.success) {
await fetchData();
alert('Fallback rate saved!');
} else {
throw new Error(result.error || 'Failed to save fallback rate');
}
} catch (error) {
console.error('Error saving fallback rate:', error);
alert('Failed to save fallback rate. Please try again.');
}
});

document.getElementById('change-credentials').addEventListener('click', async () => {
const btn = document.getElementById('change-credentials');
showButtonFeedback(btn, 'Saving...', 'Change Credentials');
const email = document.getElementById('new-email').value.trim();
const password = document.getElementById('new-password').value.trim();
const confirmPassword = document.getElementById('confirm-password').value.trim();
if (!email || !password || !confirmPassword) {
alert('Please fill in all fields.');
return;
}
if (password !== confirmPassword) {
alert('Passwords do not match.');
return;
}
try {
const response = await fetch('/api/change-credentials', {
method: 'POST',
headers: { 'Content-Type': 'application/json' },
body: JSON.stringify({ email, password }),
credentials: 'include'
});
const result = await response.json();
if (result.success) {
document.getElementById('new-email').value = '';
document.getElementById('new-password').value = '';
document.getElementById('confirm-password').value = '';
alert('Credentials updated successfully!');
} else {
throw new Error(result.error || 'Failed to update credentials');
}
} catch (error) {
console.error('Error updating credentials:', error);
alert('Failed to update credentials. Please try again.');
}
});

// Static Pages
function renderPages() {
const pageList = document.getElementById('page-list');
pageList.innerHTML = '';
data.static_pages.forEach(page => {
const li = document.createElement('li');
li.className = 'bg-gray-50 p-4 rounded-md flex justify-between items-center';
li.innerHTML = `

${page.title}
Slug: ${page.slug}

<button class="edit-page bg-blue-600 text-white px-3 py-1 rounded-md hover:bg-blue-700" data-id="${page.id}">Edit</button> <button class="delete-page bg-red-600 text-white px-3 py-1 rounded-md hover:bg-red-700" data-id="${page.id}">Delete</button>
`; pageList.appendChild(li); });
document.querySelectorAll('.edit-page').forEach(btn => {
btn.addEventListener('click', () => {
const id = btn.dataset.id;
const page = data.static_pages.find(p => p.id === id);
if (!page) {
alert('Page not found. Please refresh and try again.');
return;
}
document.getElementById('page-title').value = page.title;
document.getElementById('page-slug').value = page.slug;
document.getElementById('page-meta').value = page.meta_description || '';
pageQuill.root.innerHTML = page.content;
document.getElementById('meta-counter').textContent = ${140 - (page.meta_description || '').length} characters remaining;
document.getElementById('add-page').textContent = 'Update Page';
document.getElementById('add-page').dataset.id = id;
});
});

document.querySelectorAll('.delete-page').forEach(btn => {
btn.addEventListener('click', async () => {
if (!confirm('Are you sure you want to delete this page?')) return;
showButtonFeedback(btn, 'Deleting...', 'Delete');
const id = btn.dataset.id;
try {
const response = await fetch('/api/delete-page', {
method: 'POST',
headers: { 'Content-Type': 'application/json' },
body: JSON.stringify({ id }),
credentials: 'include'
});
const result = await response.json();
if (result.success) {
await fetchData();
renderPages();
alert('Page deleted successfully!');
} else {
throw new Error(result.error || 'Failed to delete page');
}
} catch (error) {
console.error('Error deleting page:', error);
alert('Failed to delete page. Please try again.');
}
});
});
}

document.getElementById('add-page').addEventListener('click', async () => {
const btn = document.getElementById('add-page');
const isUpdate = btn.textContent === 'Update Page';
showButtonFeedback(btn, isUpdate ? 'Updating...' : 'Adding...', isUpdate ? 'Update Page' : 'Add Page');
const title = document.getElementById('page-title').value.trim();
const slug = document.getElementById('page-slug').value.trim();
const metaDescription = document.getElementById('page-meta').value.trim();
const content = pageQuill.root.innerHTML;
if (!title || !slug || !content) {
alert('Please fill in all required fields.');
return;
}
try {
const endpoint = isUpdate ? '/api/update-page' : '/api/add-page';
const body = isUpdate
? { id: btn.dataset.id, title, slug, meta_description: metaDescription, content }
: { title, slug, meta_description: metaDescription, content };
const response = await fetch(endpoint, {
method: 'POST',
headers: { 'Content-Type': 'application/json' },
body: JSON.stringify(body),
credentials: 'include'
});
const result = await response.json();
if (result.success) {
await fetchData();
renderPages();
document.getElementById('page-title').value = '';
document.getElementById('page-slug').value = '';
document.getElementById('page-meta').value = '';
pageQuill.setContents([]);
btn.textContent = 'Add Page';
delete btn.dataset.id;
alert(Page ${isUpdate ? 'updated' : 'added'} successfully!);
} else {
throw new Error(result.error || Failed to ${isUpdate ? 'update' : 'add'} page);
}
} catch (error) {
console.error(Error ${isUpdate ? 'updating' : 'adding'} page:, error);
alert(Failed to ${isUpdate ? 'update' : 'add'} page. Please try again.);
}
});

// Character counters
document.getElementById('name').addEventListener('input', () => {
const counter = document.getElementById('name-counter');
const remaining = 100 - document.getElementById('name').value.length;
counter.textContent = ${remaining} characters remaining;
});

document.getElementById('edit-name').addEventListener('input', () => {
const counter = document.getElementById('edit-name-counter');
const remaining = 100 - document.getElementById('edit-name').value.length;
counter.textContent = ${remaining} characters remaining;
});

document.getElementById('page-meta').addEventListener('input', () => {
const counter = document.getElementById('meta-counter');
const remaining = 140 - document.getElementById('page-meta').value.length;
counter.textContent = ${remaining} characters remaining;
});

// Initialize
async function initialize() {
const isAuthenticated = await checkSession();
if (!isAuthenticated) {
document.getElementById('login-page').classList.remove('hidden');
document.getElementById('admin-panel').classList.add('hidden');
document.getElementById('admin-nav').classList.add('hidden');
return;
}
document.getElementById('login-page').classList.add('hidden');
document.getElementById('admin-panel').classList.remove('hidden');
document.getElementById('admin-nav').classList.remove('hidden');
const success = await fetchData();
if (success) {
renderBots();
renderCategories();
renderPages();
document.getElementById('support-email').value = data.settings.support_email || '';
document.getElementById('copyright-text').value = data.settings.footer_copyright || '';
document.getElementById('mpesa-till').value = data.settings.mpesa_till_number || '';
document.getElementById('payment-method').value = data.settings.payment_method || 'payhero';
document.getElementById('fallback-rate').value = data.settings.fallback_exchange_rate || '';
document.getElementById('urgent-toggle').checked = data.settings.urgent_message?.enabled || false;
urgentQuill.root.innerHTML = data.settings.urgent_message?.text || '';
urgentQuill.enable(data.settings.urgent_message?.enabled || false);
document.getElementById('logo-preview').innerHTML = data.settings.logo_url ? <img src="${data.settings.logo_url}" alt="Logo" class="w-32 h-auto rounded-md"> : '';
['tiktok', 'instagram', 'x', 'facebook', 'youtube'].forEach(platform => {
const link = data.social_links.find(l => l.platform === platform);
document.getElementById(platform).value = link?.url || '';
document.getElementById(${platform}-logo-preview).innerHTML = link?.logo_url ? <img src="${link.logo_url}" alt="${platform} logo" class="w-16 h-16 rounded-md"> : '';
});
startOrdersPolling();
}
}

initialize();
</script>
