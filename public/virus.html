<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Panel - Deriv Bot Store</title>
  <link rel="icon" type="image/png" href="/favicon.png">
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/quill@2.0.2/dist/quill.snow.css" rel="stylesheet">
  <script defer src="https://cdn.jsdelivr.net/npm/quill@2.0.2/dist/quill.js"></script>
  <style>
   
    #add-page, #cancel-page-edit {
  display: inline-block;
}
    /* Prevent background scrolling when modals are active */
    body.modal-active {
      overflow: hidden;
    }
    /* Navigation styling */
    nav {
      background: linear-gradient(145deg, #ffffff, #f0f4f8);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
    .nav-link {
      transition: all 0.3s ease;
    }
    .nav-link:hover {
      color: #16a34a !important;
      transform: translateY(-2px);
    }
    .nav-link.border-green-500 {
      color: #16a34a !important;
    }
    /* Section styling */
    .section {
      background: linear-gradient(145deg, #ffffff, #f0f4f8);
      border-radius: 16px;
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
      transition: all 0.3s ease;
    }
    .section:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
    }
    /* Form inputs and labels */
    input, textarea, select {
      transition: all 0.3s ease;
      border-color: #d1d5db;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }
    input:focus, textarea:focus, select:focus {
      border-color: #16a34a;
      box-shadow: 0 0 0 3px rgba(22, 163, 74, 0.1);
      outline: none;
    }
    label {
      font-weight: 500;
      color: #374151;
    }
    /* Buttons */
    button {
      transition: all 0.3s ease;
    }
    button.bg-green-600 {
      background: linear-gradient(90deg, #16a34a, #22c55e);
    }
    button.bg-green-600:hover {
      background: linear-gradient(90deg, #15803d, #16a34a);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(22, 163, 74, 0.3);
    }
    button.bg-blue-600 {
      background: linear-gradient(90deg, #2563eb, #3b82f6);
    }
    button.bg-blue-600:hover {
      background: linear-gradient(90deg, #1d4ed8, #2563eb);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
    }
    button.bg-red-600 {
      background: linear-gradient(90deg, #ef4444, #f87171);
    }
    button.bg-red-600:hover {
      background: linear-gradient(90deg, #dc2626, #ef4444);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
    }
    button.bg-gray-600 {
      background: linear-gradient(90deg, #6b7280, #9ca3af);
    }
    button.bg-gray-600:hover {
      background: linear-gradient(90deg, #4b5563, #6b7280);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(107, 114, 128, 0.3);
    }
    /* Upload progress bar styling */
    #upload-progress {
      width: 100%;
      height: 10px;
      background: #e5e7eb;
      border-radius: 8px;
      overflow: hidden;
      margin-top: 12px;
    }
    #upload-progress-bar {
      height: 100%;
      background: linear-gradient(90deg, #16a34a, #22c55e);
      width: 0;
      transition: width 0.3s ease;
    }
    /* Bot list and page list items */
    #bot-list li, #page-list li {
      background: #f9fafb;
      border-radius: 12px;
      transition: all 0.3s ease;
    }
    #bot-list li:hover, #page-list li:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 15px rgba(0, 0, 0, 0.1);
    }
    /* Category list items */
    #category-list li {
      background: #f9fafb;
      border-radius: 8px;
      transition: all 0.3s ease;
    }
    #category-list li:hover {
      transform:translateY(-3px);
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
    }
    /* Orders table styling */
    #orders-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1.5rem;
      background: #fff;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    }
    #orders-table th, #orders-table td {
      border: 1px solid #e5e7eb;
      padding: 1rem;
      text-align: left;
      font-size: 0.95rem;
      color: #374151;
    }
    #orders-table th {
      background: linear-gradient(90deg, #f3f3f3, #e5e7eb);
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: #1f2937;
    }
    #orders-table tr {
      transition: all 0.3s ease;
    }
    #orders-table tr:nth-child(even) {
      background: #f9fafb;
    }
    #orders-table tr:hover {
      background: #f0f4f8;
      transform: scale(1.01);
    }
    .status-select {
      background: #fff;
      border-radius: 8px;
      padding: 0.5rem;
      border: 1px solid #d1d5db;
      transition: all 0.3s ease;
    }
    .status-select:hover, .status-select:focus {
      border-color: #16a34a;
      box-shadow: 0 0 0 3px rgba(22, 163, 74, 0.1);
    }
    /* Close button for modals */
    .close-modal {
      position: absolute;
      top: 1rem;
      right: 1rem;
      font-size: 1.5rem;
      color: #6b7280;
      cursor: pointer;
      transition: color 0.3s ease;
    }
    .close-modal:hover {
      color: #ef4444;
    }

    /* Full-screen login page */
#login-page {
  height: 100vh;
  width: 100vw;
  background-color: #f3f4f6; /* Matches bg-gray-100 */
}

/* Ensure the admin panel takes full width when visible */
#admin-panel {
  width: 100%;
}

/* Optional: Improve the look of the login form */
#login-page .bg-white {
  box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
}

/* Hide scrollbars on login page but keep functionality */
#login-page {
  overflow: hidden;
}

/* Adjust toggle password button positioning */
#toggle-password {
  top: 2.25rem; /* Adjusted to align with the input field */
}
    
    /* Responsive adjustments */
    @media (max-width: 640px) {
      .section {
        padding: 1rem;
      }
      #orders-table th, #orders-table td {
        padding: 0.75rem;
        font-size: 0.85rem;
      }
      #orders-table {
        display: block;
        overflow-x: auto;
        white-space: nowrap;
      }
      #product-form, #edit-form {
        grid-template-columns: 1fr;
      }
      #login-modal > div, #edit-modal > div {
        width: 90%;
        padding: 1.5rem;
      }
    }

    /* Quill Editor Styling */
.ql-editor-container {
  position: relative;
  z-index: 5; /* Lower than toolbar and dropdown */
}
.ql-container {
  min-height: 120px;
  border-radius: 0 0 0.375rem 0.375rem;
  border: 1px solid #d1d5db;
  background: #fff;
  z-index: 10;
  position: relative;
}
.ql-toolbar .ql-picker-options {
  z-index: 30; /* Increased to ensure it stays above all elements */
  position: absolute;
  background: #fff;
  border: 1px solid #d1d5db;
  border-radius: 0.375rem;
  box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
  top: 100%; /* Position below the toolbar */
  left: 0;
  width: auto;
  min-width: 100px;
  max-height: 200px;
  overflow-y: auto;
}

/* Ensure the toolbar itself doesn't clip the dropdown */
.ql-toolbar {
  border-radius: 0.375rem 0.375rem 0 0;
  border: 1px solid #d1d5db;
  border-bottom: none;
  background: #f9fafb;
  z-index: 15; /* Slightly higher than the container but lower than dropdown */
  position: relative;
  overflow: visible; /* Ensure dropdowns are not clipped */
}
    .ql-container:focus-within {
  border-color: #16a34a;
  box-shadow: 0 0 0 3px rgba(22, 163, 74, 0.1);
}
    
  </style>
</head>
<body class="bg-gray-100">
  <!-- Login Page -->
  <div id="login-page" class="flex items-center justify-center min-h-screen">
    <div class="bg-white rounded-lg shadow-md p-8 max-w-sm w-full">
      <h2 class="text-2xl font-semibold text-gray-900 mb-6 text-center">Admin Login</h2>
      <div class="mb-4">
        <label for="login-email" class="block text-sm font-medium text-gray-700">Email</label>
        <input type="email" id="login-email" class="mt-1 w-full p-2 border rounded-md" required>
      </div>
      <div class="mb-6 relative">
        <label for="login-password" class="block text-sm font-medium text-gray-700">Password</label>
        <input type="password" id="login-password" class="mt-1 w-full p-2 border rounded-md" required>
        <button type="button" id="toggle-password" class="absolute right-2 top-9 text-gray-500">Show</button>
      </div>
      <button id="login-submit" class="w-full bg-green-600 text-white py-2 rounded-md hover:bg-green-700">Login</button>
    </div>
  </div>

  <!-- Main Admin Panel (Hidden Initially) -->
  <div id="admin-panel" class="hidden">
    <!-- Navigation Bar -->
    <nav class="bg-white shadow-md sticky top-0 z-20">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex justify-between h-16">
          <div class="flex items-center">
            <h1 class="text-xl font-bold text-gray-800">Admin Panel</h1>
            <div class="ml-6 flex space-x-4 sm:space-x-8">
              <a href="#add-bot" class="nav-link text-gray-500 hover:text-gray-900 px-1 pt-1 text-sm font-medium border-b-2 border-green-500">Add Bot</a>
              <a href="#manage-bots" class="nav-link text-gray-500 hover:text-gray-900 px-1 pt-1 text-sm font-medium">Manage Bots</a>
              <a href="#settings" class="nav-link text-gray-500 hover:text-gray-900 px-1 pt-1 text-sm font-medium">Settings</a>
              <a href="#static-pages" class="nav-link text-gray-500 hover:text-gray-900 px-1 pt-1 text-sm font-medium">Static Pages</a>
              <a href="#orders" class="nav-link text-gray-500 hover:text-gray-900 px-1 pt-1 text-sm font-medium">Orders</a>
            </div>
          </div>
        </div>
      </div>
    </nav>

    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
      <!-- Add Bot Section -->
      <section id="add-bot" class="section bg-white rounded-lg shadow-md p-6 mb-8 hidden">
        <h2 class="text-xl font-semibold text-gray-900 mb-4">Add New Bot</h2>
        <form id="product-form">
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
            <div>
              <label for="name" class="block text-sm font-medium text-gray-700">Name</label>
              <input type="text" id="name" required class="mt-1 w-full p-2 border rounded-md">
            </div>
            <div>
              <label for="price" class="block text-sm font-medium text-gray-700">Price ($)</label>
              <input type="number" id="price" step="0.01" required class="mt-1 w-full p-2 border rounded-md">
            </div>
            <div class="sm:col-span-2">
              <label for="desc" class="block text-sm font-medium text-gray-700">Description</label>
              <div class="ql-editor-container">
  <div id="desc-editor" class="mt-1 w-full border rounded-md"></div>
</div>
              <input type="hidden" id="desc" name="desc">
            </div>
            <div class="sm:col-span-2">
              <label for="embed" class="block text-sm font-medium text-gray-700">Embed Link (Optional, e.g., YouTube)</label>
              <input type="url" id="embed" class="mt-1 w-full p-2 border rounded-md" placeholder="https://www.youtube.com/embed/VIDEO_ID">
            </div>
            <div>
              <label for="category" class="block text-sm font-medium text-gray-700">Category</label>
              <select id="category" required class="mt-1 w-full p-2 border rounded-md"></select>
            </div>
            <div>
              <label for="item" class="block text-sm font-medium text-gray-700">Item Number</label>
              <input type="text" id="item" required class="mt-1 w-full p-2 border rounded-md">
            </div>
            <div class="sm:col-span-2">
              <label for="img" class="block text-sm font-medium text-gray-700">Image URL</label>
              <input type="url" id="img" required class="mt-1 w-full p-2 border rounded-md">
            </div>
            <div class="sm:col-span-2">
              <label class="flex items-center">
                <input type="checkbox" id="isNew" class="mr-2">
                <span class="text-sm font-medium text-gray-700">Mark as New</span>
              </label>
            </div>
            <div class="sm:col-span-2">
              <label for="file" class="block text-sm font-medium text-gray-700">Bot File</label>
              <input type="file" id="file" required class="mt-1 w-full p-2 border rounded-md">
              <div id="upload-progress" class="hidden">
                <div id="upload-progress-bar"></div>
              </div>
            </div>
          </div>
          <button type="submit" class="mt-6 w-full bg-green-600 text-white py-2 rounded-md hover:bg-green-700">Add Bot</button>
        </form>
      </section>

      <!-- Manage Bots Section -->
      <section id="manage-bots" class="section bg-white rounded-lg shadow-md p-6 mb-8 hidden">
        <h2 class="text-xl font-semibold text-gray-900 mb-4">Manage Bots</h2>
        <ul id="bot-list" class="space-y-4"></ul>
      </section>

      <!-- Settings Section -->
      <section id="settings" class="section bg-white rounded-lg shadow-md p-6 mb-8 hidden">
        <h2 class="text-xl font-semibold text-gray-900 mb-4">Settings</h2>
        <div class="mb-6">
          <h3 class="text-lg font-semibold text-gray-900 mb-2">Manage Categories</h3>
          <div class="flex gap-4 mb-4">
            <input type="text" id="new-category" class="w-full p-2 border rounded-md" placeholder="e.g., Volatility Bots">
            <button id="add-category" class="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700">Add Category</button>
          </div>
          <ul id="category-list" class="space-y-2"></ul>
        </div>
        <div class="mb-6">
          <label class="flex items-center">
            <input type="checkbox" id="urgent-toggle" class="mr-2">
            <span class="text-sm font-medium text-gray-700">Show Urgent Message (Pop-up on Front End)</span>
          </label>
          <div class="ql-editor-container">
  <div id="urgent-message-editor" class="mt-2 w-full border rounded-md"></div>
</div>
          <input type="hidden" id="urgent-message" name="urgent-message">
          <button id="save-urgent" class="mt-2 bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700">Save Message</button>
        </div>
        <div class="mb-6">
          <label for="support-email" class="block text-sm font-medium text-gray-700">Support Email</label>
          <input type="email" id="support-email" class="mt-1 w-full p-2 border rounded-md">
          <button id="save-email" class="mt-2 bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700">Save Email</button>
        </div>
        <div class="mb-6">
          <label for="copyright-text" class="block text-sm font-medium text-gray-700">Footer Copyright Text</label>
          <input type="text" id="copyright-text" class="mt-1 w-full p-2 border rounded-md">
          <button id="save-copyright" class="mt-2 bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700">Save Copyright</button>
        </div>
        <div class="mb-6">
          <label for="logo-url" class="block text-sm font-medium text-gray-700">Logo URL</label>
          <input type="url" id="logo-url" class="mt-1 w-full p-2 border rounded-md">
          <button id="save-logo" class="mt-2 bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700">Save Logo</button>
        </div>
        <div class="mb-6">
          <label for="mpesa-till" class="block text-sm font-medium text-gray-700">MPESA Till Number</label>
          <input type="text" id="mpesa-till" class="mt-1 w-full p-2 border rounded-md">
          <button id="save-mpesa-till" class="mt-2 bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700">Save Till Number</button>
        </div>
        <div class="mb-6">
          <h3 class="text-lg font-semibold text-gray-900 mb-2">Social Media Links</h3>
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
            <div><label for="tiktok" class="block text-sm font-medium text-gray-700">TikTok</label><input type="url" id="tiktok" class="mt-1 w-full p-2 border rounded-md"></div>
            <div><label for="whatsapp" class="block text-sm font-medium text-gray-700">WhatsApp</label><input type="url" id="whatsapp" class="mt-1 w-full p-2 border rounded-md"></div>
            <div><label for="call" class="block text-sm font-medium text-gray-700">Call</label><input type="tel" id="call" class="mt-1 w-full p-2 border rounded-md"></div>
            <div><label for="instagram" class="block text-sm font-medium text-gray-700">Instagram</label><input type="url" id="instagram" class="mt-1 w-full p-2 border rounded-md"></div>
            <div><label for="x" class="block text-sm font-medium text-gray-700">X</label><input type="url" id="x" class="mt-1 w-full p-2 border rounded-md"></div>
            <div><label for="facebook" class="block text-sm font-medium text-gray-700">Facebook</label><input type="url" id="facebook" class="mt-1 w-full p-2 border rounded-md"></div>
            <div><label for="youtube" class="block text-sm font-medium text-gray-700">YouTube</label><input type="url" id="youtube" class="mt-1 w-full p-2 border rounded-md"></div>
          </div>
          <button id="save-socials" class="mt-4 bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700">Save Socials</button>
        </div>
        <div class="mb-6">
          <label for="fallback-rate" class="block text-sm font-medium text-gray-700">Fallback Exchange Rate (KES/USD)</label>
          <input type="number" id="fallback-rate" step="0.01" class="mt-1 w-full p-2 border rounded-md">
          <button id="save-fallback-rate" class="mt-2 bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700">Save Rate</button>
        </div>
        <div>
          <div class="mb-6">
  <label for="payhero-channel-id" class="block text-sm font-medium text-gray-700">Pay Hero Channel ID</label>
  <input type="text" id="payhero-channel-id" class="mt-1 w-full p-2 border rounded-md">
  <button id="save-payhero-channel-id" class="mt-2 bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700">Save Channel ID</button>
</div>
<div class="mb-6">
  <label for="payhero-payment-url" class="block text-sm font-medium text-gray-700">Pay Hero Payment URL</label>
  <input type="url" id="payhero-payment-url" class="mt-1 w-full p-2 border rounded-md">
  <button id="save-payhero-payment-url" class="mt-2 bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700">Save Payment URL</button>
</div>
<div class="mb-6">
  <label for="payhero-auth-token" class="block text-sm font-medium text-gray-700">Pay Hero Auth Token</label>
  <input type="text" id="payhero-auth-token" class="mt-1 w-full p-2 border rounded-md">
  <button id="save-payhero-auth-token" class="mt-2 bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700">Save Auth Token</button>
</div>
          <h3 class="text-lg font-semibold text-gray-900 mb-2">Change Admin Credentials</h3>
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
            <div>
              <label for="new-email" class="block text-sm font-medium text-gray-700">New Email</label>
              <input type="email" id="new-email" class="mt-1 w-full p-2 border rounded-md">
            </div>
            <div>
              <label for="new-password" class="block text-sm font-medium text-gray-700">New Password</label>
              <input type="password" id="new-password" class="mt-1 w-full p-2 border rounded-md">
            </div>
            <div>
              <label for="confirm-password" class="block text-sm font-medium text-gray-700">Confirm Password</label>
              <input type="password" id="confirm-password" class="mt-1 w-full p-2 border rounded-md">
            </div>
          </div>
          <button id="change-credentials" class="mt-4 bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700">Change Credentials</button>
        </div>
      </section>

      <!-- Static Pages Section -->
      <section id="static-pages" class="section bg-white rounded-lg shadow-md p-6 hidden">
        <h2 class="text-xl font-semibold text-gray-900 mb-4">Manage Static Pages</h2>
        <p class="text-sm text-gray-600 mb-4">To edit the Payment Modal, create a page with slug <code>/payment-modal</code>. For the Ref Code Modal, use <code>/ref-code-modal</code>. Use HTML in the content field.</p>
        <div class="mb-6">
          <h3 class="text-lg font-semibold text-gray-900 mb-2">Add New Page</h3>
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
            <div>
              <label for="page-title" class="block text-sm font-medium text-gray-700">Page Title</label>
              <input type="text" id="page-title" class="mt-1 w-full p-2 border rounded-md">
            </div>
            <div>
              <label for="page-slug" class="block text-sm font-medium text-gray-700">Slug (e.g., /my-page)</label>
              <input type="text" id="page-slug" class="mt-1 w-full p-2 border rounded-md" placeholder="/my-page">
            </div>
            <div class="sm:col-span-2">
              <label for="page-content" class="block text-sm font-medium text-gray-700">Content (Markdown or HTML)</label>
              <div class="ql-editor-container">
  <div id="page-content-editor" class="mt-1 w-full border rounded-md"></div>
</div>
              <input type="hidden" id="page-content" name="page-content">
            </div>
          </div>
          <div class="mt-4 flex space-x-2">
        <button id="add-page" class="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700">Add Page</button>
        <button id="cancel-page-edit" class="hidden bg-gray-600 text-white px-4 py-2 rounded-md hover:bg-gray-700">Cancel</button>
      </div>
        </div>
        <ul id="page-list" class="space-y-4"></ul>
      </section>

      <!-- Orders Section -->
      <section id="orders" class="section bg-white rounded-lg shadow-md p-6 hidden">
        <h2 class="text-xl font-semibold text-gray-900 mb-4">Manage Orders</h2>
        <table id="orders-table" class="w-full border-collapse">
  <thead>
    <tr>
      <th class="border p-2">Item</th>
      <th class="border p-2">Ref Code</th>
      <th class="border p-2">Amount</th>
      <th class="border p-2">Timestamp</th>
      <th class="border p-2">Status</th>
      <th class="border p-2">Downloaded</th>
      <th class="border p-2">Payment Method</th>
      <th class="border p-2">Actions</th>
    </tr>
  </thead>
  <tbody id="order-list"></tbody>
</table>
      </section>
    </main>

    <!-- Edit Bot Modal -->
    <div id="edit-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
      <div class="bg-white rounded-lg p-6 max-w-lg w-full relative overflow-y-auto max-h-[85vh]">
        <button class="close-modal" onclick="closeEditModal()">Ã—</button>
        <h3 class="text-xl font-bold text-gray-900 mb-4">Edit Bot</h3>
        <form id="edit-form">
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
            <div>
              <label for="edit-name" class="block text-sm font-medium text-gray-700">Name</label>
              <input type="text" id="edit-name" required class="mt-1 w-full p-2 border rounded-md">
            </div>
            <div>
              <label for="edit-price" class="block text-sm font-medium text-gray-700">Price ($)</label>
              <input type="number" id="edit-price" step="0.01" required class="mt-1 w-full p-2 border rounded-md">
            </div>
            <div class="sm:col-span-2">
              <label for="edit-desc" class="block text-sm font-medium text-gray-700">Description</label>
              <div class="ql-editor-container">
  <div id="edit-desc-editor" class="mt-1 w-full border rounded-md"></div>
</div>
              <input type="hidden" id="edit-desc" name="edit-desc">
            </div>
            <div class="sm:col-span-2">
              <label for="edit-embed" class="block text-sm font-medium text-gray-700">Embed Link (Optional, e.g., YouTube)</label>
              <input type="url" id="edit-embed" class="mt-1 w-full p-2 border rounded-md" placeholder="https://www.youtube.com/embed/VIDEO_ID">
            </div>
            <div>
              <label for="edit-category" class="block text-sm font-medium text-gray-700">Category</label>
              <select id="edit-category" required class="mt-1 w-full p-2 border rounded-md"></select>
            </div>
            <div>
              <label for="edit-item" class="block text-sm font-medium text-gray-700">Item Number</label>
              <input type="text" id="edit-item" required class="mt-1 w-full p-2 border rounded-md">
            </div>
            <div class="sm:col-span-2">
              <label for="edit-img" class="block text-sm font-medium text-gray-700">Image URL</label>
              <input type="url" id="edit-img" required class="mt-1 w-full p-2 border rounded-md">
            </div>
            <div class="sm:col-span-2">
              <label class="flex items-center">
                <input type="checkbox" id="edit-isNew" class="mr-2">
                <span class="text-sm font-medium text-gray-700">Mark as New</span>
              </label>
            </div>
            <div class="sm:col-span-2">
              <label class="flex items-center">
                <input type="checkbox" id="edit-isArchived" class="mr-2">
                <span class="text-sm font-medium text-gray-700">Archive Bot</span>
              </label>
            </div>
          </div>
          <button type="submit" class="mt-6 w-full bg-green-600 text-white py-2 rounded-md hover:bg-green-700">Save Changes</button>
          <button type="button" id="edit-cancel" class="mt-2 w-full bg-gray-600 text-white py-2 rounded-md hover:bg-gray-700">Cancel</button>
        </form>
      </div>
    </div>
  </div>

  <script>
  // Helper function to show button feedback
  function showButtonFeedback(btn, actionText, originalText, duration = 2000) {
    btn.disabled = true;
    btn.textContent = actionText;
    setTimeout(() => {
      btn.disabled = false;
      btn.textContent = originalText;
    }, duration);
  }

  let data = {
    products: [],
    categories: [],
    settings: {
      urgentMessage: { enabled: false, text: '' },
      payheroChannelId: '',
      payheroPaymentUrl: '',
      payheroAuthToken: ''
    },
    staticPages: []
  };
  let orders = [];

  // Fetch data from server
  async function fetchData() {
    try {
      const response = await fetch('/api/data', { credentials: 'include' });
      if (!response.ok) throw new Error('Failed to fetch data');
      data = await response.json();
      return true;
    } catch (error) {
      console.error('Error fetching data:', error);
      alert('Failed to load data. Please try again.');
      return false;
    }
  }

  // Save data to server
  async function saveData(payload = data) { // Default to global 'data' if no payload
    try {
      const response = await fetch('/api/save-data', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload),
        credentials: 'include'
      });
      if (!response.ok) {
        const errorResult = await response.json().catch(() => ({ error: 'Failed to save data and parse error response.' }));
        throw new Error(errorResult.error || 'Failed to save data');
      }
      return true;
    } catch (error) {
      console.error('Error saving data:', error);
      alert(`Failed to save data: ${error.message}. Please try again.`);
      return false;
    }
  }

  // Fetch orders
  async function fetchOrders() {
    try {
      const response = await fetch('/api/orders', { credentials: 'include' });
      if (!response.ok) throw new Error('Failed to fetch orders');
      const result = await response.json();
      if (result.success) {
        orders = result.orders;
        renderOrders();
      } else {
        throw new Error(result.error || 'Failed to fetch orders');
      }
    } catch (error) {
      console.error('Error fetching orders:', error);
      alert('Failed to load orders. Please try again.');
    }
  }

  // Render orders with status dropdown
  function renderOrders() {
    const orderList = document.getElementById('order-list');
    orderList.innerHTML = '';
    orders.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
    orders.forEach(order => {
      const row = document.createElement('tr');
      row.innerHTML = `
        <td class="border p-2">${order.item}</td>
        <td class="border p-2">${order.ref_code}</td>
        <td class="border p-2">${order.amount}</td>
        <td class="border p-2">${new Date(order.timestamp).toLocaleString()}</td>
        <td class="border p-2">${order.status || 'pending'}</td>
        <td class="border p-2">${order.downloaded ? 'Yes' : 'No'}</td>
        <td class="border p-2">${order.payment_method || 'mpesa_till'}</td>
        <td class="border p-2">
          <select class="status-select border rounded-md p-1" data-item="${order.item}" data-refcode="${order.ref_code}">
            <option value="" selected disabled>Update Status</option>
            <option value="confirmed">Confirmed</option>
            <option value="no payment">No Payment</option>
            <option value="partial payment">Partial Payment</option>
          </select>
        </td>
      `;
      orderList.appendChild(row);
    });

    document.querySelectorAll('.status-select').forEach(select => {
      select.addEventListener('change', async () => {
        const item = select.dataset.item;
        const refCode = select.dataset.refcode;
        const status = select.value;
        const originalText = select.value;
        showButtonFeedback(select, 'Updating...', originalText);

        try {
          const response = await fetch('/api/update-order-status', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ item, refCode, status }),
            credentials: 'include'
          });
          const result = await response.json();
          if (result.success) {
            await fetchOrders();
            alert(`Order status updated to "${status}"!`);
          } else {
            throw new Error(result.error || 'Failed to update order status');
          }
        } catch (error) {
          console.error('Error updating order status:', error);
          alert('Failed to update order status. Please try again.');
        }
      });
    });
  }

  // Start polling for orders every 5 seconds when Orders section is active
  function startOrdersPolling() {
    setInterval(async () => {
      const ordersSection = document.getElementById('orders');
      const isOrdersActive = !ordersSection.classList.contains('hidden');
      const isEditModalOpen = !document.getElementById('edit-modal').classList.contains('hidden');
      if (isOrdersActive && !isEditModalOpen) {
        console.log('Polling for new orders...');
        await fetchOrders();
      } else {
        console.log('Polling skipped: Orders section not active or edit modal is open');
      }
    }, 5 * 1000);
  }

  // Navigation
  document.querySelectorAll('.nav-link').forEach(link => {
    link.addEventListener('click', e => {
      e.preventDefault();
      document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('border-b-2', 'border-green-500'));
      link.classList.add('border-b-2', 'border-green-500');
      document.querySelectorAll('.section').forEach(s => s.classList.add('hidden'));
      document.getElementById(link.getAttribute('href').slice(1)).classList.remove('hidden');
      if (link.getAttribute('href') === '#orders') {
        fetchOrders();
      }
    });
  });

  // Login handling
  async function checkSession() {
    try {
      const response = await fetch('/api/check-session', { credentials: 'include' });
      const result = await response.json();
      return result.isAuthenticated;
    } catch (error) {
      console.error('Error checking session:', error);
      return false;
    }
  }

  document.getElementById('toggle-password').addEventListener('click', () => {
    const passwordInput = document.getElementById('login-password');
    const toggleBtn = document.getElementById('toggle-password');
    if (passwordInput.type === 'password') {
      passwordInput.type = 'text';
      toggleBtn.textContent = 'Hide';
    } else {
      passwordInput.type = 'password';
      toggleBtn.textContent = 'Show';
    }
  });

  document.getElementById('login-submit').addEventListener('click', async () => {
    const email = document.getElementById('login-email').value.trim();
    const password = document.getElementById('login-password').value.trim();
    const btn = document.getElementById('login-submit');
    showButtonFeedback(btn, 'Logging in...', 'Login');

    try {
      const response = await fetch('/api/login', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email, password }),
        credentials: 'include'
      });
      const result = await response.json();
      if (result.success) {
        document.getElementById('login-page').classList.add('hidden');
        document.getElementById('admin-panel').classList.remove('hidden');
        document.getElementById('add-bot').classList.remove('hidden');
        document.querySelector('.nav-link[href="#add-bot"]').classList.add('border-b-2', 'border-green-500');
        initialize();
      } else {
        alert('Invalid credentials. Please try again.');
      }
    } catch (error) {
      console.error('Error logging in:', error);
      alert('Failed to login. Please try again.');
    }
  });

  // Add bot with progress bar
  document.getElementById('product-form').addEventListener('submit', async e => {
    e.preventDefault();
    const formData = new FormData();
    formData.append('item', document.getElementById('item').value.trim());
    formData.append('name', document.getElementById('name').value.trim());
    formData.append('price', document.getElementById('price').value);
    formData.append('desc', document.getElementById('desc').value);
    formData.append('embed', document.getElementById('embed').value.trim());
    formData.append('category', document.getElementById('category').value);
    formData.append('img', document.getElementById('img').value.trim());
    formData.append('isNew', document.getElementById('isNew').checked);
    formData.append('file', document.getElementById('file').files[0]);

    const progressBar = document.getElementById('upload-progress-bar');
    const progressContainer = document.getElementById('upload-progress');
    progressContainer.classList.remove('hidden');
    progressBar.style.width = '0%';

    const xhr = new XMLHttpRequest();
    xhr.open('POST', '/api/add-bot', true);

    xhr.upload.onprogress = event => {
      if (event.lengthComputable) {
        const percent = (event.loaded / event.total) * 100;
        progressBar.style.width = `${percent}%`;
      }
    };

    xhr.onload = async () => {
      if (xhr.status === 200) {
        const result = JSON.parse(xhr.responseText);
        if (result.success && result.product) {
          // Server successfully added the bot and returned the new product data (reflecting DB state)
          // Update client-side 'data.products' with the authoritative version from server
          const existingProductIndex = data.products.findIndex(p => p.item === result.product.item);
          if (existingProductIndex > -1) {
            data.products[existingProductIndex] = result.product; // Update if somehow item number was reused (should not happen for new)
          } else {
            data.products.push(result.product);
          }
          // No need for an additional global saveData() here as /api/add-bot already updated DB and server cache.
          renderBots();
          document.getElementById('product-form').reset();
          if (window.descQuill) {
            window.descQuill.setText(''); // Clear Quill editor
          }
          progressContainer.classList.add('hidden');
          alert('Bot added successfully!');
        } else {
          // Error from server after upload (e.g., DB insert issue not caught by server's orphan file cleanup)
          alert(`Failed to finalize bot addition: ${result.error || 'Unknown error'}`);
          progressContainer.classList.add('hidden');
        }
      } else { // xhr.status !== 200
        alert(`Upload failed. Server responded with ${xhr.status}: ${xhr.statusText}`);
        progressContainer.classList.add('hidden');
      }
    };

    xhr.onerror = () => {
      progressContainer.classList.add('hidden');
      alert('Error uploading bot. Please try again.');
    };

    xhr.send(formData);
  });

  // Render bots
  function renderBots() {
    const botList = document.getElementById('bot-list');
    botList.innerHTML = '';
    data.products.forEach(product => {
      const li = document.createElement('li');
      li.className = 'bg-gray-50 p-4 rounded-md flex justify-between items-center';
      li.innerHTML = `
        <div>
          <h3 class="text-lg font-medium text-gray-900">${product.name}</h3>
          <p class="text-sm text-gray-600">Item: ${product.item} | Price: $${product.price}</p>
        </div>
        <div class="space-x-2">
          <button class="edit-bot bg-blue-600 text-white px-3 py-1 rounded-md hover:bg-blue-700" data-item="${product.item}">Edit</button>
          <button class="delete-bot bg-red-600 text-white px-3 py-1 rounded-md hover:bg-red-700" data-item="${product.item}">Delete</button>
        </div>
      `;
      botList.appendChild(li);
    });

    document.querySelectorAll('.edit-bot').forEach(btn => {
      btn.addEventListener('click', () => {
        const item = btn.dataset.item;
        const product = data.products.find(p => p.item === item);
        if (!product) {
          alert('Bot not found. Please refresh and try again.');
          return;
        }
        document.getElementById('edit-item').value = product.item;
        document.getElementById('edit-item').dataset.originalItem = product.item;
        document.getElementById('edit-name').value = product.name;
        document.getElementById('edit-price').value = product.price;
        window.editDescQuill.root.innerHTML = product.desc || '<p></p>';
        document.getElementById('edit-embed').value = product.embed || '';
        document.getElementById('edit-img').value = product.img;
        document.getElementById('edit-isNew').checked = product.isNew;
        document.getElementById('edit-isArchived').checked = product.isArchived || false;
        const categorySelect = document.getElementById('edit-category');
        categorySelect.innerHTML = data.categories.map(cat => `<option value="${cat}">${cat}</option>`).join('');
        categorySelect.value = product.category;
        document.getElementById('edit-modal').classList.remove('hidden');
        document.body.classList.add('modal-active');
      });
    });

    document.querySelectorAll('.delete-bot').forEach(btn => {
      btn.addEventListener('click', async () => {
        const confirmation = confirm('Are you sure you want to delete this bot?');
        if (!confirmation) return;
        
        showButtonFeedback(btn, 'Deleting...', 'Delete');
        const item = btn.dataset.item;
        try {
          const response = await fetch('/api/delete-bot', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ item }),
            credentials: 'include'
          });
          const result = await response.json();
          if (result.success) {
            // Server confirmed deletion and updated its cache.
            // Client updates its local 'data.products' and re-renders.
            data.products = data.products.filter(p => p.item !== item);
            // No need for an additional global saveData() here.
            renderBots();
            alert('Bot deleted successfully!');
          } else {
            // Server indicated failure to delete.
            alert(`Failed to delete bot: ${result.error || 'Unknown error'}`);
          }
        } catch (error) { // Network error or JSON parsing error
          console.error('Error deleting bot:', error);
          alert(`Failed to delete bot: ${error.message}. Please try again.`);
        }
      });
    });
  }

  // Function to close the Edit Bot modal
  function closeEditModal() {
    document.getElementById('edit-modal').classList.add('hidden');
    document.body.classList.remove('modal-active');
    document.getElementById('edit-form').reset();
  }

  document.getElementById('edit-form').addEventListener('submit', async e => {
    e.preventDefault();
    const btn = e.submitter;
    showButtonFeedback(btn, 'Saving...', 'Save Changes');

    const originalItem = document.getElementById('edit-item').dataset.originalItem;
    const newItem = document.getElementById('edit-item').value.trim();

    if (newItem !== originalItem && data.products.some(p => p.item === newItem)) {
      alert('This item number already exists. Please use a unique item number.');
      return;
    }

    const productIndex = data.products.findIndex(p => p.item === originalItem);
    if (productIndex === -1 && originalItem !== newItem) { // If originalItem not found and it's supposed to be an edit of an existing
      alert('Original bot data not found. Cannot update if item ID was changed. Please refresh.');
      btn.disabled = false; btn.textContent = 'Save Changes'; // Re-enable button
      return;
    }

    const productPayload = {
      // Preserve existing fileId and originalFileName unless a new file is uploaded (not handled in this form)
      fileId: productIndex !== -1 ? data.products[productIndex].fileId : null,
      originalFileName: productIndex !== -1 ? data.products[productIndex].originalFileName : null,

      item: newItem,
      name: document.getElementById('edit-name').value.trim(),
      price: parseFloat(document.getElementById('edit-price').value),
      desc: document.getElementById('edit-desc').value, // Synced from Quill's hidden input
      embed: document.getElementById('edit-embed').value.trim(),
      category: document.getElementById('edit-category').value,
      img: document.getElementById('edit-img').value.trim(),
      isNew: document.getElementById('edit-isNew').checked,
      isArchived: document.getElementById('edit-isArchived').checked
    };

    if (newItem !== originalItem) {
      productPayload.originalItem = originalItem; // Add originalItem only if ID changed
    }

    // Update local cache
    if (newItem !== originalItem) {
      // Item ID changed: remove old, add new
      if (productIndex !== -1) { // Should be found if originalItem was valid
        data.products.splice(productIndex, 1); // Remove the old item entry
      }
      data.products.push(productPayload); // Add the product with its new ID and data
    } else {
      // Item ID did not change: update in place
      if (productIndex !== -1) {
        data.products[productIndex] = productPayload;
      } else {
        // This case means originalItem was not found, and newItem is the same as originalItem (i.e., trying to edit a non-existent item without changing ID)
        alert('Bot data not found for update. Please refresh.');
        btn.disabled = false; btn.textContent = 'Save Changes'; // Re-enable button
        return;
      }
    }

    const success = await saveData({ products: [productPayload] });
    if (success) {
      renderBots();
      closeEditModal();
      alert('Bot updated successfully!');
    }
    // else: Error is already alerted by saveData(), button state handled by showButtonFeedback
  });

  document.getElementById('edit-cancel').addEventListener('click', () => {
    closeEditModal();
  });

  function initializeQuillEditors() {
    if (typeof Quill === 'undefined') {
      console.error('Quill library is not loaded. Please check the Quill script inclusion.');
      return;
    }

    const idsToClean = ['desc', 'edit-desc', 'urgent-message', 'page-content'];
    idsToClean.forEach(id => {
      const textarea = document.querySelector(`textarea[id="${id}"]`);
      if (textarea) {
        console.warn(`Found stray <textarea> with id "${id}". Removing it.`);
        textarea.remove();
      }
    });

    if (document.getElementById('desc-editor')) {
      // setTimeout(() => { // Removed setTimeout
        const descQuill = new Quill('#desc-editor', {
          theme: 'snow',
          modules: {
            toolbar: [
              [{ 'header': [1, 2, 3, false] }],
              ['bold', 'italic', 'underline'],
              ['link', 'image'],
              [{ 'list': 'ordered' }, { 'list': 'bullet' }],
              ['clean']
            ]
          },
          placeholder: 'Enter bot description...',
        });
        descQuill.on('text-change', () => {
          document.getElementById('desc').value = descQuill.root.innerHTML;
        });
        window.descQuill = descQuill; // Make it globally accessible
      // }, 100); // Removed setTimeout
    } else {
      console.warn('Element #desc-editor not found in DOM.');
    }

    if (document.getElementById('edit-desc-editor')) {
      // setTimeout(() => { // Removed setTimeout
        const editDescQuill = new Quill('#edit-desc-editor', {
          theme: 'snow',
          modules: {
            toolbar: [
              [{ 'header': [1, 2, 3, false] }],
              ['bold', 'italic', 'underline'],
              ['link', 'image'],
              [{ 'list': 'ordered' }, { 'list': 'bullet' }],
              ['clean']
            ]
          },
          placeholder: 'Enter bot description...',
        });
        editDescQuill.on('text-change', () => {
          document.getElementById('edit-desc').value = editDescQuill.root.innerHTML;
        });
        window.editDescQuill = editDescQuill;
      // }, 100); // Removed setTimeout
    } else {
      console.warn('Element #edit-desc-editor not found in DOM.');
    }

    if (document.getElementById('urgent-message-editor')) {
      // setTimeout(() => { // Removed setTimeout
        const urgentQuill = new Quill('#urgent-message-editor', {
          theme: 'snow',
          modules: {
            toolbar: [
              [{ 'header': [1, 2, 3, false] }],
              ['bold', 'italic', 'underline'],
              ['link'],
              [{ 'list': 'ordered' }, { 'list': 'bullet' }],
              ['clean']
            ]
          },
          placeholder: 'Enter urgent message...',
        });
        urgentQuill.on('text-change', () => {
          document.getElementById('urgent-message').value = urgentQuill.root.innerHTML;
        });
        window.urgentQuill = urgentQuill;
      // }, 100); // Removed setTimeout
    } else {
      console.warn('Element #urgent-message-editor not found in DOM.');
    }

    if (document.getElementById('page-content-editor')) {
      // setTimeout(() => { // Removed setTimeout
        const pageContentQuill = new Quill('#page-content-editor', {
          theme: 'snow',
          modules: {
            toolbar: [
              [{ 'header': [1, 2, 3, false] }],
              ['bold', 'italic', 'underline'],
              ['link', 'image'],
              [{ 'list': 'ordered' }, { 'list': 'bullet' }],
              ['clean']
            ]
          },
          placeholder: 'Enter page content (Markdown or HTML)...',
        });
        pageContentQuill.on('text-change', () => {
          document.getElementById('page-content').value = pageContentQuill.root.innerHTML;
        });
        window.pageContentQuill = pageContentQuill;
      // }, 100); // Removed setTimeout
    } else {
      console.warn('Element #page-content-editor not found in DOM.');
    }
  }

  // Categories
  function renderCategories() {
    const categoryList = document.getElementById('category-list');
    const categorySelect = document.getElementById('category');
    const editCategorySelect = document.getElementById('edit-category');
    categoryList.innerHTML = '';
    categorySelect.innerHTML = '';
    editCategorySelect.innerHTML = '';
    data.categories.forEach(cat => {
      const li = document.createElement('li');
      li.className = 'flex justify-between items-center bg-gray-50 p-2 rounded-md';
      li.innerHTML = `
        <span>${cat}</span>
        <button class="delete-category bg-red-600 text-white px-2 py-1 rounded-md hover:bg-red-700" data-category="${cat}">Delete</button>
      `;
      categoryList.appendChild(li);
      categorySelect.innerHTML += `<option value="${cat}">${cat}</option>`;
      editCategorySelect.innerHTML += `<option value="${cat}">${cat}</option>`;
    });

    document.querySelectorAll('.delete-category').forEach(btn => {
      btn.addEventListener('click', async () => {
        if (confirm('Are you sure you want to delete this category?')) {
          showButtonFeedback(btn, 'Deleting...', 'Delete');
          const category = btn.dataset.category;
          data.categories = data.categories.filter(c => c !== category);
          data.products.forEach(p => {
            if (p.category === category) p.category = 'General'; // Update products using the deleted category
          });
          // Send updated categories and products
          const success = await saveData({ categories: data.categories, products: data.products });
          if (success) {
            renderCategories();
            renderBots();
            alert('Category deleted and product categories updated successfully!');
          } else {
            // Error already alerted by saveData. Consider reverting optimistic updates if critical.
            // For simplicity here, we rely on a full refresh if things go very wrong.
          }
        }
      });
    });
  }

  document.getElementById('add-category').addEventListener('click', async () => {
    const btn = document.getElementById('add-category');
    const originalButtonText = btn.textContent; // Store original button text
    showButtonFeedback(btn, 'Adding...', originalButtonText);
    const newCategoryInput = document.getElementById('new-category');
    const newCategory = newCategoryInput.value.trim();

    if (newCategory) {
      const isDuplicate = data.categories.some(cat => cat.toLowerCase() === newCategory.toLowerCase());
      if (!isDuplicate) {
        data.categories.push(newCategory); // Optimistic update
        const success = await saveData({ categories: data.categories }); // Correct: Send categories at top-level

        if (success) {
          renderCategories(); // Re-render from the current data.categories
          newCategoryInput.value = '';
          alert('Category added successfully!');
          // showButtonFeedback will re-enable the button and restore text after timeout
        } else {
          // Revert optimistic update
          const index = data.categories.findIndex(cat => cat.toLowerCase() === newCategory.toLowerCase());
          if (index > -1) {
            data.categories.splice(index, 1);
          }
          // Error message is already shown by saveData()
          // Ensure button is re-enabled and text restored immediately on failure
          btn.disabled = false;
          btn.textContent = originalButtonText;
        }
      } else {
        alert(`Category "${newCategory}" (or a case-variant) already exists.`);
        btn.disabled = false;
        btn.textContent = originalButtonText;
      }
    } else {
      alert('Category name cannot be empty.');
      btn.disabled = false;
      btn.textContent = originalButtonText;
    }
  });

  // Settings - Urgent Message
  const urgentToggle = document.getElementById('urgent-toggle');
  const urgentMessage = document.getElementById('urgent-message');

  function initializeUrgentMessage() {
    const localUrgentToggle = document.getElementById('urgent-toggle'); // Re-fetch within function scope for safety

    // Check if Quill editor instance for urgent message is available
    if (!window.urgentQuill) {
      console.warn('Urgent Quill editor (window.urgentQuill) not ready yet in initializeUrgentMessage. Will retry or rely on later initialization.');
      // Optionally, set a timeout to retry, or rely on the main initialize() flow
      return;
    }
    // Check if the toggle element itself is found
    if (!localUrgentToggle) {
        console.error('Urgent toggle element (#urgent-toggle) not found in initializeUrgentMessage.');
        return;
    }

    localUrgentToggle.checked = data.settings.urgentMessage?.enabled || false;
    window.urgentQuill.enable(data.settings.urgentMessage?.enabled || false);
    window.urgentQuill.root.innerHTML = data.settings.urgentMessage?.text || '<p></p>';
    console.log('Urgent message editor initialized and populated.');
  }

  // Ensure event listener for urgentToggle also checks for Quill instance
  const urgentToggleElement = document.getElementById('urgent-toggle');
  if (urgentToggleElement) {
    urgentToggleElement.addEventListener('change', () => {
      if (!window.urgentQuill) {
        console.error('Urgent message Quill editor not found during toggle change.');
        return;
      }
      window.urgentQuill.enable(urgentToggleElement.checked);
      if (urgentToggleElement.checked) {
        window.urgentQuill.focus();
      }
    });
  } else {
    console.error("Failed to find #urgent-toggle to attach change listener.");
  }

  document.getElementById('save-urgent').addEventListener('click', async () => {
    const btn = document.getElementById('save-urgent');
    const localUrgentToggle = document.getElementById('urgent-toggle'); // Re-fetch for safety
    const urgentMessageInput = document.getElementById('urgent-message'); // Hidden input

    if (!localUrgentToggle || !urgentMessageInput) { // Check DOM elements
      console.error('Urgent message DOM elements not found for save.');
      return;
    }
    window.urgentQuill.enable(urgentToggle.checked);
    if (urgentToggle.checked) {
      window.urgentQuill.focus();
    }
  });

  document.getElementById('save-urgent').addEventListener('click', async () => {
    const btn = document.getElementById('save-urgent');
    if (!urgentToggle || !urgentMessage) {
      console.error('Urgent message elements not found');
      alert('Error: Unable to save urgent message. Elements not found.');
      return;
    }
    showButtonFeedback(btn, 'Saving...', 'Save Message');
    const urgentMessageData = {
      enabled: urgentToggle.checked,
      text: document.getElementById('urgent-message').value
    };
    // Update local cache before saving, so UI reflects change if save is slow but successful
    data.settings.urgentMessage = urgentMessageData;
    const success = await saveData({ settings: { urgentMessage: urgentMessageData } });
    if (success) {
      alert('Urgent message saved!');
    }
  });

  document.getElementById('save-email').addEventListener('click', async () => {
    const btn = document.getElementById('save-email');
    showButtonFeedback(btn, 'Saving...', 'Save Email');
    const supportEmailValue = document.getElementById('support-email').value.trim();
    data.settings.supportEmail = supportEmailValue; // Update local cache
    const success = await saveData({ settings: { supportEmail: supportEmailValue } });
    if (success) alert('Support email saved!');
  });

  document.getElementById('save-copyright').addEventListener('click', async () => {
    const btn = document.getElementById('save-copyright');
    showButtonFeedback(btn, 'Saving...', 'Save Copyright');
    const copyrightTextValue = document.getElementById('copyright-text').value.trim();
    data.settings.copyrightText = copyrightTextValue; // Update local cache
    const success = await saveData({ settings: { copyrightText: copyrightTextValue } });
    if (success) alert('Copyright text saved!');
  });

  document.getElementById('save-logo').addEventListener('click', async () => {
    const btn = document.getElementById('save-logo');
    showButtonFeedback(btn, 'Saving...', 'Save Logo');
    const logoUrlValue = document.getElementById('logo-url').value.trim();
    data.settings.logoUrl = logoUrlValue; // Update local cache
    const success = await saveData({ settings: { logoUrl: logoUrlValue } });
    if (success) alert('Logo URL saved!');
  });

  document.getElementById('save-mpesa-till').addEventListener('click', async () => {
    const btn = document.getElementById('save-mpesa-till');
    showButtonFeedback(btn, 'Saving...', 'Save Till Number');
    const mpesaTillValue = document.getElementById('mpesa-till').value.trim();
    data.settings.mpesaTill = mpesaTillValue; // Update local cache
    const success = await saveData({ settings: { mpesaTill: mpesaTillValue } });
    if (success) alert('MPESA Till Number saved!');
  });

  document.getElementById('save-payhero-channel-id').addEventListener('click', async () => {
    const btn = document.getElementById('save-payhero-channel-id');
    showButtonFeedback(btn, 'Saving...', 'Save Channel ID');
    const payheroChannelIdValue = document.getElementById('payhero-channel-id').value.trim();
    data.settings.payheroChannelId = payheroChannelIdValue; // Update local cache
    const success = await saveData({ settings: { payheroChannelId: payheroChannelIdValue } });
    if (success) alert('Pay Hero Channel ID saved!');
  });

  document.getElementById('save-payhero-payment-url').addEventListener('click', async () => {
    const btn = document.getElementById('save-payhero-payment-url');
    showButtonFeedback(btn, 'Saving...', 'Save Payment URL');
    const payheroPaymentUrlValue = document.getElementById('payhero-payment-url').value.trim();
    data.settings.payheroPaymentUrl = payheroPaymentUrlValue; // Update local cache
    const success = await saveData({ settings: { payheroPaymentUrl: payheroPaymentUrlValue } });
    if (success) alert('Pay Hero Payment URL saved!');
  });

  document.getElementById('save-payhero-auth-token').addEventListener('click', async () => {
    const btn = document.getElementById('save-payhero-auth-token');
    showButtonFeedback(btn, 'Saving...', 'Save Auth Token');
    const payheroAuthTokenValue = document.getElementById('payhero-auth-token').value.trim();
    data.settings.payheroAuthToken = payheroAuthTokenValue; // Update local cache
    const success = await saveData({ settings: { payheroAuthToken: payheroAuthTokenValue } });
    if (success) alert('Pay Hero Auth Token saved!');
  });

  document.getElementById('save-socials').addEventListener('click', async () => {
    const btn = document.getElementById('save-socials');
    showButtonFeedback(btn, 'Saving...', 'Save Socials');
    const socialsData = {
      tiktok: document.getElementById('tiktok').value.trim(),
      whatsapp: document.getElementById('whatsapp').value.trim(),
      call: document.getElementById('call').value.trim(),
      instagram: document.getElementById('instagram').value.trim(),
      x: document.getElementById('x').value.trim(),
      facebook: document.getElementById('facebook').value.trim(),
      youtube: document.getElementById('youtube').value.trim()
    };
    data.settings.socials = socialsData; // Update local cache
    const success = await saveData({ settings: { socials: socialsData } });
    if (success) alert('Social media links saved!');
  });

  document.getElementById('save-fallback-rate').addEventListener('click', async () => {
    const btn = document.getElementById('save-fallback-rate');
    showButtonFeedback(btn, 'Saving...', 'Save Rate');
    const fallbackRateValue = parseFloat(document.getElementById('fallback-rate').value);
    data.settings.fallbackRate = fallbackRateValue; // Update local cache
    const success = await saveData({ settings: { fallbackRate: fallbackRateValue } });
    if (success) alert('Fallback rate saved!');
  });

  document.getElementById('change-credentials').addEventListener('click', async () => {
    const btn = document.getElementById('change-credentials');
    showButtonFeedback(btn, 'Saving...', 'Change Credentials');
    const newEmail = document.getElementById('new-email').value.trim();
    const newPassword = document.getElementById('new-password').value.trim();
    const confirmPassword = document.getElementById('confirm-password').value.trim();

    if (newPassword !== confirmPassword) {
      alert('Passwords do not match!');
      // Re-enable button immediately for correction
      btn.disabled = false;
      btn.textContent = 'Change Credentials';
      return;
    }

    const settingsPayload = {};
    let credsChanged = false;

    if (newEmail && newEmail !== data.settings.adminEmail) {
      settingsPayload.adminEmail = newEmail;
      credsChanged = true;
    }
    if (newPassword) { // Only include password if it's new and not empty
      settingsPayload.adminPassword = newPassword;
      credsChanged = true;
    }

    if (!credsChanged) {
      alert('No changes to credentials detected.');
      btn.disabled = false;
      btn.textContent = 'Change Credentials';
      return;
    }

    // Optimistically update local cache for email for immediate UI reflection if needed,
    // password is not stored directly in `data.settings` in plain text after this point.
    if (settingsPayload.adminEmail) data.settings.adminEmail = settingsPayload.adminEmail;

    const saveSuccess = await saveData({ settings: settingsPayload });
    if (!saveSuccess) {
      // Error already alerted by saveData
      return;
    }

    try {
      const response = await fetch('/api/logout', {
        method: 'POST',
        credentials: 'include'
      });
      const result = await response.json();
      if (!result.success) {
        console.error('Failed to destroy session cookie:', result.error);
        alert('Credentials updated, but failed to log out. Please log in again manually.');
      }
    } catch (error) {
      console.error('Error during logout:', error);
      alert('Credentials updated, but failed to log out. Please log in again manually.');
    }

    alert('Credentials updated! Please login again.');
    document.getElementById('admin-panel').classList.add('hidden');
    document.getElementById('login-page').classList.remove('hidden');
  });

  // Static Pages
  function renderPages() {
    const pageList = document.getElementById('page-list');
    pageList.innerHTML = '';
    data.staticPages.forEach(page => {
      const li = document.createElement('li');
      li.className = 'bg-gray-50 p-4 rounded-md flex justify-between items-center';
      li.innerHTML = `
        <div>
          <h3 class="text-lg font-medium text-gray-900">${page.title}</h3>
          <p class="text-sm text-gray-600">Slug: ${page.slug}</p>
        </div>
        <div class="space-x-2">
          <button class="edit-page bg-blue-600 text-white px-3 py-1 rounded-md hover:bg-blue-700" data-slug="${page.slug}">Edit</button>
          <button class="delete-page bg-red-600 text-white px-3 py-1 rounded-md hover:bg-red-700" data-slug="${page.slug}">Delete</button>
        </div>
      `;
      pageList.appendChild(li);
    });

    document.querySelectorAll('.edit-page').forEach(btn => {
      btn.addEventListener('click', () => {
        const slug = btn.dataset.slug;
        const page = data.staticPages.find(p => p.slug === slug);
        if (!page) {
          alert('Page not found. Please refresh and try again.');
          return;
        }
        document.getElementById('page-title').value = page.title;
        document.getElementById('page-slug').value = page.slug;
        window.pageContentQuill.root.innerHTML = page.content || '<p></p>';
        document.getElementById('add-page').textContent = 'Save Changes';
        document.getElementById('add-page').dataset.editSlug = slug;
        document.getElementById('page-slug').dataset.originalSlug = slug;
        document.getElementById('cancel-page-edit').classList.remove('hidden');
      });
    });

    document.querySelectorAll('.delete-page').forEach(btn => {
      btn.addEventListener('click', async () => {
        if (confirm('Are you sure you want to delete this page?')) {
          showButtonFeedback(btn, 'Deleting...', 'Delete');
          const slug = btn.dataset.slug;
          data.staticPages = data.staticPages.filter(p => p.slug !== slug);
          await saveData({ staticPages: data.staticPages });
          renderPages();
          resetPageForm();
          alert('Page deleted successfully!');
        }
      });
    });
  }

  function resetPageForm() {
    document.getElementById('page-title').value = '';
    document.getElementById('page-slug').value = '';
    document.getElementById('page-content').value = '';
    window.pageContentQuill.root.innerHTML = '<p></p>';
    const addPageBtn = document.getElementById('add-page');
    addPageBtn.textContent = 'Add Page';
    delete addPageBtn.dataset.editSlug;
    delete document.getElementById('page-slug').dataset.originalSlug;
    document.getElementById('cancel-page-edit').classList.add('hidden');
  }

  document.getElementById('add-page').addEventListener('click', async function() {
    const btn = this;
    const pageTitle = document.getElementById('page-title').value.trim();
    const pageSlug = document.getElementById('page-slug').value.trim();
    const pageContent = document.getElementById('page-content').value;

    if (!pageTitle || !pageSlug || !pageContent) {
      alert('Please fill in all fields.');
      return;
    }

    const originalSlug = document.getElementById('page-slug').dataset.originalSlug;

    if (!btn.dataset.editSlug || (btn.dataset.editSlug && pageSlug !== originalSlug)) {
      if (data.staticPages.some(page => page.slug === pageSlug)) {
        alert('A page with this slug already exists. Please use a different slug.');
        return;
      }
    }

    if (btn.dataset.editSlug) {
      showButtonFeedback(btn, 'Saving...', 'Save Changes');
      data.staticPages = data.staticPages.filter(p => p.slug !== originalSlug);
      data.staticPages.push({
        title: pageTitle,
        slug: pageSlug,
        content: pageContent
      });
      // Send the entire (potentially modified) staticPages array
      const success = await saveData({ staticPages: data.staticPages });
      if (success) {
        renderPages();
        resetPageForm();
        alert('Page updated successfully!');
      } else {
        alert('Failed to update page. Please try again.');
        return;
      }
    } else {
      showButtonFeedback(btn, 'Adding...', 'Add Page');
      data.staticPages.push({
        title: pageTitle,
        slug: pageSlug,
        content: pageContent
      });
      const success = await saveData({ staticPages: data.staticPages });
      if (success) {
        renderPages();
        resetPageForm();
        alert('Page added successfully!');
      } else {
        alert('Failed to add page. Please try again.');
        return;
      }
    }
  });

  document.getElementById('cancel-page-edit').addEventListener('click', () => {
    resetPageForm();
  });

  // Initialize
  async function initialize() {
    const isAuthenticated = await checkSession();
    if (!isAuthenticated) {
      document.getElementById('admin-panel').classList.add('hidden');
      document.getElementById('login-page').classList.remove('hidden');
      return;
    }

    document.getElementById('login-page').classList.add('hidden');
    document.getElementById('admin-panel').classList.remove('hidden');
    document.getElementById('add-bot').classList.remove('hidden');
    document.querySelector('.nav-link[href="#add-bot"]').classList.add('border-b-2', 'border-green-500');

    const success = await fetchData();
    if (success) {
      renderBots();
      renderCategories();
      renderPages();
      initializeQuillEditors();
      document.getElementById('support-email').value = data.settings.supportEmail || '';
      document.getElementById('copyright-text').value = data.settings.copyrightText || '';
      document.getElementById('logo-url').value = data.settings.logoUrl || '';
      document.getElementById('mpesa-till').value = data.settings.mpesaTill || '';
      document.getElementById('payhero-channel-id').value = data.settings.payheroChannelId || '';
      document.getElementById('payhero-payment-url').value = data.settings.payheroPaymentUrl || '';
      document.getElementById('payhero-auth-token').value = data.settings.payheroAuthToken || '';
      document.getElementById('urgent-toggle').checked = data.settings.urgentMessage?.enabled || false;
      document.getElementById('urgent-message').value = data.settings.urgentMessage?.text || '';
      initializeUrgentMessage();
      document.getElementById('fallback-rate').value = data.settings.fallbackRate || '';
      Object.keys(data.settings.socials || {}).forEach(key => {
        document.getElementById(key).value = data.settings.socials[key] || '';
      });
      startOrdersPolling();
    }
  }

  document.addEventListener('DOMContentLoaded', initialize);
</script>
  
  <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'931e4c061aa005ea',t:'MTc0NDkxNzgwNy4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script>
  <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9327e8996b70bd03',t:'MTc0NTAxODU5Mi4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script>
  <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'93288924ca29676f',t:'MTc0NTAyNTE2OC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script>
  <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9328b0f2484553bc',t:'MTc0NTAyNjc5OC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script>
</body>
</html>
