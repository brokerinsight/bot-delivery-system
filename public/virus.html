<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Panel - Deriv Bot Store</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body:has(#login-modal:not(.hidden)) > *:not(#login-modal) {
      filter: blur(5px);
    }
    body:has(#edit-modal:not(.hidden)) > *:not(#edit-modal) {
      filter: blur(5px);
    }
    .loading-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }
    .spinner {
      border: 4px solid rgba(255, 255, 255, 0.3);
      border-top: 4px solid white;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body class="bg-gray-100">
  <!-- Loading Overlay -->
  <div id="loading-overlay" class="loading-overlay">
    <div class="spinner"></div>
  </div>

  <nav class="bg-white shadow-md sticky top-0 z-20">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex justify-between h-16">
        <div class="flex items-center">
          <h1 class="text-xl font-bold text-gray-800">Admin Panel</h1>
          <div class="ml-6 flex space-x-4 sm:space-x-8">
            <a href="#add-bot" class="nav-link text-gray-500 hover:text-gray-900 px-1 pt-1 text-sm font-medium border-b-2 border-green-500">Add Bot</a>
            <a href="#manage-bots" class="nav-link text-gray-500 hover:text-gray-900 px-1 pt-1 text-sm font-medium">Manage Bots</a>
            <a href="#settings" class="nav-link text-gray-500 hover:text-gray-900 px-1 pt-1 text-sm font-medium">Settings</a>
            <a href="#static-pages" class="nav-link text-gray-500 hover:text-gray-900 px-1 pt-1 text-sm font-medium">Static Pages</a>
            <a href="#orders" class="nav-link text-gray-500 hover:text-gray-900 px-1 pt-1 text-sm font-medium">Orders</a>
          </div>
        </div>
      </div>
    </div>
  </nav>

  <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
    <!-- Add Bot -->
    <section id="add-bot" class="section bg-white rounded-lg shadow-md p-6 mb-8">
      <h2 class="text-xl font-semibold text-gray-900 mb-4">Add New Bot</h2>
      <form id="product-form">
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
          <div>
            <label for="name" class="block text-sm font-medium text-gray-700">Name</label>
            <input type="text" id="name" required class="mt-1 w-full p-2 border rounded-md">
          </div>
          <div>
            <label for="price" class="block text-sm font-medium text-gray-700">Price ($)</label>
            <input type="number" id="price" step="0.01" required class="mt-1 w-full p-2 border rounded-md">
          </div>
          <div class="sm:col-span-2">
            <label for="desc" class="block text-sm font-medium text-gray-700">Description</label>
            <textarea id="desc" required class="mt-1 w-full p-2 border rounded-md"></textarea>
          </div>
          <div class="sm:col-span-2">
            <label for="embed" class="block text-sm font-medium text-gray-700">Embed Link (Optional, e.g., YouTube)</label>
            <input type="url" id="embed" class="mt-1 w-full p-2 border rounded-md" placeholder="https://www.youtube.com/embed/VIDEO_ID">
          </div>
          <div>
            <label for="category" class="block text-sm font-medium text-gray-700">Category</label>
            <select id="category" required class="mt-1 w-full p-2 border rounded-md"></select>
          </div>
          <div>
            <label for="item" class="block text-sm font-medium text-gray-700">Item Number</label>
            <input type="text" id="item" required class="mt-1 w-full p-2 border rounded-md">
          </div>
          <div class="sm:col-span-2">
            <label for="img" class="block text-sm font-medium text-gray-700">Image URL</label>
            <input type="url" id="img" required class="mt-1 w-full p-2 border rounded-md">
          </div>
          <div class="sm:col-span-2">
            <label for="file" class="block text-sm font-medium text-gray-700">Bot File</label>
            <input type="file" id="file" required class="mt-1 w-full p-2 border rounded-md">
          </div>
          <div class="sm:col-span-2">
            <label class="flex items-center">
              <input type="checkbox" id="isNew" class="mr-2">
              <span class="text-sm font-medium text-gray-700">Mark as New</span>
            </label>
          </div>
        </div>
        <button type="submit" class="mt-6 w-full bg-green-600 text-white py-2 rounded-md hover:bg-green-700">Add Bot</button>
      </form>
    </section>

    <!-- Manage Bots -->
    <section id="manage-bots" class="section bg-white rounded-lg shadow-md p-6 mb-8 hidden">
      <h2 class="text-xl font-semibold text-gray-900 mb-4">Manage Bots</h2>
      <ul id="bot-list" class="space-y-4"></ul>
    </section>

    <!-- Settings -->
    <section id="settings" class="section bg-white rounded-lg shadow-md p-6 mb-8 hidden">
      <h2 class="text-xl font-semibold text-gray-900 mb-4">Settings</h2>
      <div class="mb-6">
        <h3 class="text-lg font-semibold text-gray-900 mb-2">Manage Categories</h3>
        <div class="flex gap-4 mb-4">
          <input type="text" id="new-category" class="w-full p-2 border rounded-md" placeholder="e.g., Volatility Bots">
          <button id="add-category" class="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700">Add Category</button>
        </div>
        <ul id="category-list" class="space-y-2"></ul>
      </div>
      <div class="mb-6">
        <label class="flex items-center">
          <input type="checkbox" id="urgent-toggle" class="mr-2">
          <span class="text-sm font-medium text-gray-700">Show Urgent Message (Pop-up on Front End)</span>
        </label>
        <textarea id="urgent-message" class="mt-2 w-full p-2 border rounded-md" placeholder="Enter urgent message..."></textarea>
        <button id="save-urgent" class="mt-2 bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700">Save Message</button>
      </div>
      <div class="mb-6">
        <label for="support-email" class="block text-sm font-medium text-gray-700">Support Email</label>
        <input type="email" id="support-email" class="mt-1 w-full p-2 border rounded-md">
        <button id="save-email" class="mt-2 bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700">Save Email</button>
      </div>
      <div class="mb-6">
        <label for="copyright-text" class="block text-sm font-medium text-gray-700">Footer Copyright Text</label>
        <input type="text" id="copyright-text" class="mt-1 w-full p-2 border rounded-md">
        <button id="save-copyright" class="mt-2 bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700">Save Copyright</button>
      </div>
      <div class="mb-6">
        <label for="logo-url" class="block text-sm font-medium text-gray-700">Logo URL</label>
        <input type="url" id="logo-url" class="mt-1 w-full p-2 border rounded-md">
        <button id="save-logo" class="mt-2 bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700">Save Logo</button>
      </div>
      <div class="mb-6">
        <label for="mpesa-till" class="block text-sm font-medium text-gray-700">MPESA Till Number</label>
        <input type="text" id="mpesa-till" class="mt-1 w-full p-2 border rounded-md">
        <button id="save-mpesa-till" class="mt-2 bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700">Save Till Number</button>
      </div>
      <div class="mb-6">
        <h3 class="text-lg font-semibold text-gray-900 mb-2">Social Media Links</h3>
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
          <div><label for="tiktok" class="block text-sm font-medium text-gray-700">TikTok</label><input type="url" id="tiktok" class="mt-1 w-full p-2 border rounded-md"></div>
          <div><label for="whatsapp" class="block text-sm font-medium text-gray-700">WhatsApp</label><input type="url" id="whatsapp" class="mt-1 w-full p-2 border rounded-md"></div>
          <div><label for="instagram" class="block text-sm font-medium text-gray-700">Instagram</label><input type="url" id="instagram" class="mt-1 w-full p-2 border rounded-md"></div>
          <div><label for="x" class="block text-sm font-medium text-gray-700">X</label><input type="url" id="x" class="mt-1 w-full p-2 border rounded-md"></div>
          <div><label for="facebook" class="block text-sm font-medium text-gray-700">Facebook</label><input type="url" id="facebook" class="mt-1 w-full p-2 border rounded-md"></div>
          <div><label for="youtube" class="block text-sm font-medium text-gray-700">YouTube</label><input type="url" id="youtube" class="mt-1 w-full p-2 border rounded-md"></div>
        </div>
        <button id="save-socials" class="mt-4 bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700">Save Socials</button>
      </div>
      <div class="mb-6">
        <label for="fallback-rate" class="block text-sm font-medium text-gray-700">Fallback Exchange Rate (KES/USD)</label>
        <input type="number" id="fallback-rate" step="0.01" class="mt-1 w-full p-2 border rounded-md">
        <button id="save-fallback-rate" class="mt-2 bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700">Save Rate</button>
      </div>
      <div>
        <h3 class="text-lg font-semibold text-gray-900 mb-2">Change Admin Credentials</h3>
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
          <div>
            <label for="new-email" class="block text-sm font-medium text-gray-700">New Email</label>
            <input type="email" id="new-email" class="mt-1 w-full p-2 border rounded-md">
          </div>
          <div>
            <label for="new-password" class="block text-sm font-medium text-gray-700">New Password</label>
            <input type="password" id="new-password" class="mt-1 w-full p-2 border rounded-md">
          </div>
          <div>
            <label for="confirm-password" class="block text-sm font-medium text-gray-700">Confirm Password</label>
            <input type="password" id="confirm-password" class="mt-1 w-full p-2 border rounded-md">
          </div>
        </div>
        <button id="change-credentials" class="mt-4 bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700">Change Credentials</button>
      </div>
    </section>

    <!-- Static Pages -->
    <section id="static-pages" class="section bg-white rounded-lg shadow-md p-6 hidden">
      <h2 class="text-xl font-semibold text-gray-900 mb-4">Manage Static Pages</h2>
      <p class="text-sm text-gray-600 mb-4">To edit the Payment Modal, create a page with slug <code>/payment-modal</code>. For the Ref Code Modal, use <code>/ref-code-modal</code>. Use HTML in the content field.</p>
      <div class="mb-6">
        <h3 class="text-lg font-semibold text-gray-900 mb-2">Add New Page</h3>
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
          <div>
            <label for="page-title" class="block text-sm font-medium text-gray-700">Page Title</label>
            <input type="text" id="page-title" class="mt-1 w-full p-2 border rounded-md">
          </div>
          <div>
            <label for="page-slug" class="block text-sm font-medium text-gray-700">Slug (e.g., /my-page)</label>
            <input type="text" id="page-slug" class="mt-1 w-full p-2 border rounded-md" placeholder="/my-page">
          </div>
          <div class="sm:col-span-2">
            <label for="page-content" class="block text-sm font-medium text-gray-700">Content (Markdown or HTML)</label>
            <textarea id="page-content" class="mt-1 w-full p-2 border rounded-md" rows="6"></textarea>
          </div>
        </div>
        <button id="add-page" class="mt-4 bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700">Add Page</button>
      </div>
      <ul id="page-list" class="space-y-4"></ul>
    </section>

    <!-- Orders -->
    <section id="orders" class="section bg-white rounded-lg shadow-md p-6 hidden">
      <h2 class="text-xl font-semibold text-gray-900 mb-4">Manage Orders</h2>
      <ul id="order-list" class="space-y-4"></ul>
    </section>
  </main>

  <!-- Login Modal -->
  <div id="login-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-lg p-6 max-w-sm w-full">
      <h3 class="text-xl font-bold text-gray-900 mb-4">Admin Login</h3>
      <div class="mb-4">
        <label for="login-email" class="block text-sm font-medium text-gray-700">Email</label>
        <input type="email" id="login-email" class="mt-1 w-full p-2 border rounded-md" required>
      </div>
      <div class="mb-4 relative">
        <label for="login-password" class="block text-sm font-medium text-gray-700">Password</label>
        <input type="password" id="login-password" class="mt-1 w-full p-2 border rounded-md" required>
        <button type="button" id="toggle-password" class="absolute right-2 top-9 text-gray-500">Show</button>
      </div>
      <button id="login-submit" class="w-full bg-green-600 text-white py-2 rounded-md hover:bg-green-700">Login</button>
    </div>
  </div>

  <!-- Edit Bot Modal -->
  <div id="edit-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-lg p-6 max-w-lg w-full">
      <h3 class="text-xl font-bold text-gray-900 mb-4">Edit Bot</h3>
      <form id="edit-form">
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
          <div>
            <label for="edit-name" class="block text-sm font-medium text-gray-700">Name</label>
            <input type="text" id="edit-name" required class="mt-1 w-full p-2 border rounded-md">
          </div>
          <div>
            <label for="edit-price" class="block text-sm font-medium text-gray-700">Price ($)</label>
            <input type="number" id="edit-price" step="0.01" required class="mt-1 w-full p-2 border rounded-md">
          </div>
          <div class="sm:col-span-2">
            <label for="edit-desc" class="block text-sm font-medium text-gray-700">Description</label>
            <textarea id="edit-desc" required class="mt-1 w-full p-2 border rounded-md"></textarea>
          </div>
          <div class="sm:col-span-2">
            <label for="edit-embed" class="block text-sm font-medium text-gray-700">Embed Link (Optional)</label>
            <input type="url" id="edit-embed" class="mt-1 w-full p-2 border rounded-md">
          </div>
          <div>
            <label for="edit-category" class="block text-sm font-medium text-gray-700">Category</label>
            <select id="edit-category" required class="mt-1 w-full p-2 border rounded-md"></select>
          </div>
          <div>
            <label for="edit-item" class="block text-sm font-medium text-gray-700">Item Number</label>
            <input type="text" id="edit-item" required class="mt-1 w-full p-2 border rounded-md" readonly>
          </div>
          <div class="sm:col-span-2">
            <label for="edit-img" class="block text-sm font-medium text-gray-700">Image URL</label>
            <input type="url" id="edit-img" required class="mt-1 w-full p-2 border rounded-md">
          </div>
          <div class="sm:col-span-2">
            <label class="flex items-center">
              <input type="checkbox" id="edit-isNew" class="mr-2">
              <span class="text-sm font-medium text-gray-700">Mark as New</span>
            </label>
          </div>
        </div>
        <div class="mt-6 flex justify-end space-x-4">
          <button type="button" id="edit-cancel" class="bg-gray-600 text-white px-4 py-2 rounded-md hover:bg-gray-700">Cancel</button>
          <button type="submit" class="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700">Save Changes</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    let products = [];
    let categories = [];
    let settings = {};
    let staticPages = [];
    let orders = [];

    // Button loading state
    function setButtonLoading(button, isLoading) {
      button.disabled = isLoading;
      button.dataset.originalText = button.dataset.originalText || button.textContent;
      button.textContent = isLoading ? 'Saving...' : button.dataset.originalText;
    }

    // Show/hide loading overlay
    const loadingOverlay = document.getElementById('loading-overlay');
    function showLoadingOverlay() {
      loadingOverlay.style.display = 'flex';
    }
    function hideLoadingOverlay() {
      loadingOverlay.style.display = 'none';
    }

    // Fetch with retry logic
    async function fetchWithRetry(url, options = {}, retries = 3, delay = 1000) {
      for (let i = 0; i < retries; i++) {
        try {
          const response = await fetch(url, { ...options, credentials: 'include' });
          if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
          return await response.json();
        } catch (error) {
          if (i === retries - 1) throw error;
          console.warn(`Fetch attempt ${i + 1} failed, retrying in ${delay}ms...`, error);
          await new Promise(resolve => setTimeout(resolve, delay));
        }
      }
    }

    // Fetch initial data
    async function fetchData() {
      try {
        const data = await fetchWithRetry('/api/data');
        products = data.products || [];
        categories = data.categories || [];
        settings = data.settings || {};
        staticPages = data.staticPages || [];
      } catch (error) {
        console.error('Error fetching data:', error);
        alert('Failed to load data. Please try again later.');
      }
    }

    // Populate category dropdowns
    function populateCategories() {
      const categorySelect = document.getElementById('category');
      const editCategorySelect = document.getElementById('edit-category');
      categorySelect.innerHTML = '';
      editCategorySelect.innerHTML = '';
      categories.forEach(cat => {
        const option = document.createElement('option');
        option.value = cat;
        option.textContent = cat;
        categorySelect.appendChild(option.cloneNode(true));
        editCategorySelect.appendChild(option);
      });
    }

    // Render bots
    function renderBots() {
      const botList = document.getElementById('bot-list');
      botList.innerHTML = '';
      products.forEach(product => {
        const li = document.createElement('li');
        li.className = 'flex flex-col sm:flex-row items-center justify-between p-4 bg-gray-100 rounded-md';
        li.innerHTML = `
          <div class="flex items-center space-x-4">
            <img src="${product.img}" alt="${product.name}" class="w-16 h-16 object-cover rounded-md">
            <div>
              <h3 class="text-lg font-semibold text-gray-900">${product.name}</h3>
              <p class="text-sm text-gray-600">$${product.price} | ${product.category}</p>
            </div>
          </div>
          <div class="mt-4 sm:mt-0 space-x-2">
            <button data-item="${product.item}" class="edit-bot bg-blue-600 text-white px-3 py-1 rounded-md hover:bg-blue-700">Edit</button>
            <button data-item="${product.item}" class="archive-bot bg-red-600 text-white px-3 py-1 rounded-md hover:bg-red-700">${product.isArchived ? 'Unarchive' : 'Archive'}</button>
          </div>
        `;
        botList.appendChild(li);
      });

      document.querySelectorAll('.edit-bot').forEach(button => {
        button.addEventListener('click', () => {
          const item = button.dataset.item;
          const product = products.find(p => p.item === item);
          document.getElementById('edit-item').value = product.item;
          document.getElementById('edit-name').value = product.name;
          document.getElementById('edit-price').value = product.price;
          document.getElementById('edit-desc').value = product.desc;
          document.getElementById('edit-embed').value = product.embed || '';
          document.getElementById('edit-category').value = product.category;
          document.getElementById('edit-img').value = product.img;
          document.getElementById('edit-isNew').checked = product.isNew;
          document.getElementById('edit-modal').classList.remove('hidden');
        });
      });

      document.querySelectorAll('.archive-bot').forEach(button => {
        button.addEventListener('click', async () => {
          const item = button.dataset.item;
          const product = products.find(p => p.item === item);
          product.isArchived = !product.isArchived;
          try {
            await fetchWithRetry('/api/save-data', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ products, categories, settings, staticPages })
            });
            renderBots();
          } catch (error) {
            console.error('Error archiving bot:', error);
            alert('Failed to archive bot. Please try again.');
          }
        });
      });
    }

    // Render categories in settings
    function renderCategories() {
      const categoryList = document.getElementById('category-list');
      categoryList.innerHTML = '';
      categories.forEach(cat => {
        const li = document.createElement('li');
        li.className = 'flex justify-between items-center p-2 bg-gray-100 rounded-md';
        li.innerHTML = `
          <span>${cat}</span>
          <button data-category="${cat}" class="delete-category bg-red-600 text-white px-3 py-1 rounded-md hover:bg-red-700">Delete</button>
        `;
        categoryList.appendChild(li);
      });

      document.querySelectorAll('.delete-category').forEach(button => {
        button.addEventListener('click', async () => {
          const category = button.dataset.category;
          if (products.some(p => p.category === category && !p.isArchived)) {
            alert('Cannot delete category with active products.');
            return;
          }
          categories = categories.filter(c => c !== category);
          try {
            await fetchWithRetry('/api/save-data', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ products, categories, settings, staticPages })
            });
            renderCategories();
            populateCategories();
          } catch (error) {
            console.error('Error deleting category:', error);
            alert('Failed to delete category. Please try again.');
          }
        });
      });
    }

    // Render static pages
    function renderStaticPages() {
      const pageList = document.getElementById('page-list');
      pageList.innerHTML = '';
      staticPages.forEach(page => {
        const li = document.createElement('li');
        li.className = 'flex flex-col sm:flex-row justify-between items-center p-4 bg-gray-100 rounded-md';
        li.innerHTML = `
          <div>
            <h3 class="text-lg font-semibold text-gray-900">${page.title}</h3>
            <p class="text-sm text-gray-600">${page.slug}</p>
          </div>
          <div class="mt-4 sm:mt-0 space-x-2">
            <button data-slug="${page.slug}" class="edit-page bg-blue-600 text-white px-3 py-1 rounded-md hover:bg-blue-700">Edit</button>
            <button data-slug="${page.slug}" class="delete-page bg-red-600 text-white px-3 py-1 rounded-md hover:bg-red-700">Delete</button>
          </div>
        `;
        pageList.appendChild(li);
      });

      document.querySelectorAll('.edit-page').forEach(button => {
        button.addEventListener('click', () => {
          const slug = button.dataset.slug;
          const page = staticPages.find(p => p.slug === slug);
          document.getElementById('page-title').value = page.title;
          document.getElementById('page-slug').value = page.slug;
          document.getElementById('page-content').value = page.content;
          document.getElementById('add-page').textContent = 'Update Page';
          document.getElementById('add-page').dataset.editingSlug = slug;
        });
      });

      document.querySelectorAll('.delete-page').forEach(button => {
        button.addEventListener('click', async () => {
          const slug = button.dataset.slug;
          staticPages = staticPages.filter(p => p.slug !== slug);
          try {
            await fetchWithRetry('/api/save-data', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ products, categories, settings, staticPages })
            });
            renderStaticPages();
          } catch (error) {
            console.error('Error deleting page:', error);
            alert('Failed to delete page. Please try again.');
          }
        });
      });
    }

    // Render orders
    async function renderOrders() {
      try {
        const data = await fetchWithRetry('/api/orders');
        orders = data.orders || [];
        const orderList = document.getElementById('order-list');
        orderList.innerHTML = '';
        orders.forEach(order => {
          const li = document.createElement('li');
          li.className = 'p-4 bg-gray-100 rounded-md';
          li.innerHTML = `
            <div class="flex flex-col sm:flex-row justify-between items-center">
              <div>
                <p class="text-sm text-gray-600"><strong>Item:</strong> ${order.item}</p>
                <p class="text-sm text-gray-600"><strong>Ref Code:</strong> ${order.refCode}</p>
                <p class="text-sm text-gray-600"><strong>Amount:</strong> ${order.amount} KES</p>
                <p class="text-sm text-gray-600"><strong>Timestamp:</strong> ${order.timestamp}</p>
              </div>
              <button data-ref="${order.refCode}" data-item="${order.item}" class="confirm-order mt-4 sm:mt-0 bg-green-600 text-white px-3 py-1 rounded-md hover:bg-green-700">Confirm</button>
            </div>
          `;
          orderList.appendChild(li);
        });

        document.querySelectorAll('.confirm-order').forEach(button => {
          button.addEventListener('click', async () => {
            const refCode = button.dataset.ref;
            const item = button.dataset.item;
            const order = orders.find(o => o.refCode === refCode && o.item === item);
            try {
              const response = await fetchWithRetry('/api/confirm-order', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(order)
              });
              if (response.success) {
                alert('Order confirmed! Customer will receive the download link.');
                renderOrders();
              } else {
                throw new Error(response.error || 'Failed to confirm order.');
              }
            } catch (error) {
              console.error('Error confirming order:', error);
              alert(`Error: ${error.message}`);
            }
          });
        });
      } catch (error) {
        console.error('Error fetching orders:', error);
        alert('Failed to load orders. Please try again.');
      }
    }

    // Navigation
    document.querySelectorAll('.nav-link').forEach(link => {
      link.addEventListener('click', e => {
        e.preventDefault();
        const sectionId = link.getAttribute('href').substring(1);
        document.querySelectorAll('.section').forEach(section => section.classList.add('hidden'));
        document.getElementById(sectionId).classList.remove('hidden');
        document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('border-b-2', 'border-green-500'));
        link.classList.add('border-b-2', 'border-green-500');
        if (sectionId === 'orders') renderOrders();
      });
    });

    // Add bot
    document.getElementById('product-form').addEventListener('submit', async e => {
      e.preventDefault();
      const formData = new FormData();
      formData.append('item', document.getElementById('item').value);
      formData.append('name', document.getElementById('name').value);
      formData.append('price', document.getElementById('price').value);
      formData.append('desc', document.getElementById('desc').value);
      formData.append('embed', document.getElementById('embed').value);
      formData.append('category', document.getElementById('category').value);
      formData.append('img', document.getElementById('img').value);
      formData.append('isNew', document.getElementById('isNew').checked);
      formData.append('file', document.getElementById('file').files[0]);

      showLoadingOverlay();
      try {
        const response = await fetch('/api/add-bot', {
          method: 'POST',
          body: formData,
          credentials: 'include'
        });
        const data = await response.json();
        if (data.success) {
          products.push(data.product);
          renderBots();
          document.getElementById('product-form').reset();
          alert('Bot added successfully!');
        } else {
          throw new Error(data.error || 'Failed to add bot.');
        }
      } catch (error) {
        console.error('Error adding bot:', error);
        alert(`Error: ${error.message}`);
      } finally {
        hideLoadingOverlay();
      }
    });

    // Edit bot
    document.getElementById('edit-form').addEventListener('submit', async e => {
      e.preventDefault();
      const item = document.getElementById('edit-item').value;
      const product = products.find(p => p.item === item);
      product.name = document.getElementById('edit-name').value;
      product.price = parseFloat(document.getElementById('edit-price').value);
      product.desc = document.getElementById('edit-desc').value;
      product.embed = document.getElementById('edit-embed').value;
      product.category = document.getElementById('edit-category').value;
      product.img = document.getElementById('edit-img').value;
      product.isNew = document.getElementById('edit-isNew').checked;

      try {
        await fetchWithRetry('/api/save-data', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ products, categories, settings, staticPages })
        });
        renderBots();
        document.getElementById('edit-modal').classList.add('hidden');
        alert('Bot updated successfully!');
      } catch (error) {
        console.error('Error updating bot:', error);
        alert('Failed to update bot. Please try again.');
      }
    });

    document.getElementById('edit-cancel').addEventListener('click', () => {
      document.getElementById('edit-modal').classList.add('hidden');
    });

    // Add category
    document.getElementById('add-category').addEventListener('click', async () => {
      const newCategory = document.getElementById('new-category').value.trim();
      if (!newCategory) return alert('Please enter a category name.');
      if (categories.includes(newCategory)) return alert('Category already exists.');
      categories.push(newCategory);
      try {
        await fetchWithRetry('/api/save-data', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ products, categories, settings, staticPages })
        });
        renderCategories();
        populateCategories();
        document.getElementById('new-category').value = '';
      } catch (error) {
        console.error('Error adding category:', error);
        alert('Failed to add category. Please try again.');
      }
    });

    // Save urgent message
    document.getElementById('save-urgent').addEventListener('click', async () => {
      const button = document.getElementById('save-urgent');
      setButtonLoading(button, true);
      settings.urgentMessage = {
        enabled: document.getElementById('urgent-toggle').checked,
        text: document.getElementById('urgent-message').value
      };
      try {
        await fetchWithRetry('/api/save-data', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ products, categories, settings, staticPages })
        });
        alert('Urgent message saved!');
      } catch (error) {
        console.error('Error saving urgent message:', error);
        alert('Failed to save urgent message. Please try again.');
      } finally {
        setButtonLoading(button, false);
      }
    });

    // Save support email
    document.getElementById('save-email').addEventListener('click', async () => {
      const button = document.getElementById('save-email');
      setButtonLoading(button, true);
      settings.supportEmail = document.getElementById('support-email').value;
      try {
        await fetchWithRetry('/api/save-data', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ products, categories, settings, staticPages })
        });
        alert('Support email saved!');
      } catch (error) {
        console.error('Error saving email:', error);
        alert('Failed to save email. Please try again.');
      } finally {
        setButtonLoading(button, false);
      }
    });

    // Save copyright text
    document.getElementById('save-copyright').addEventListener('click', async () => {
      const button = document.getElementById('save-copyright');
      setButtonLoading(button, true);
      settings.copyrightText = document.getElementById('copyright-text').value;
      try {
        await fetchWithRetry('/api/save-data', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ products, categories, settings, staticPages })
        });
        alert('Copyright text saved!');
      } catch (error) {
        console.error('Error saving copyright:', error);
        alert('Failed to save copyright text. Please try again.');
      } finally {
        setButtonLoading(button, false);
      }
    });

    // Save logo URL
    document.getElementById('save-logo').addEventListener('click', async () => {
      const button = document.getElementById('save-logo');
      setButtonLoading(button, true);
      settings.logoUrl = document.getElementById('logo-url').value;
      try {
        await fetchWithRetry('/api/save-data', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ products, categories, settings, staticPages })
        });
        alert('Logo URL saved!');
      } catch (error) {
        console.error('Error saving logo:', error);
        alert('Failed to save logo URL. Please try again.');
      } finally {
        setButtonLoading(button, false);
      }
    });

    // Save MPESA Till Number
    document.getElementById('save-mpesa-till').addEventListener('click', async () => {
      const button = document.getElementById('save-mpesa-till');
      setButtonLoading(button, true);
      settings.mpesaTill = document.getElementById('mpesa-till').value;
      try {
        await fetchWithRetry('/api/save-data', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ products, categories, settings, staticPages })
        });
        alert('MPESA Till Number saved!');
      } catch (error) {
        console.error('Error saving MPESA Till:', error);
        alert('Failed to save MPESA Till Number. Please try again.');
      } finally {
        setButtonLoading(button, false);
      }
    });

    // Save socials
    document.getElementById('save-socials').addEventListener('click', async () => {
      const button = document.getElementById('save-socials');
      setButtonLoading(button, true);
      settings.socials = {
        tiktok: document.getElementById('tiktok').value,
        whatsapp: document.getElementById('whatsapp').value,
        instagram: document.getElementById('instagram').value,
        x: document.getElementById('x').value,
        facebook: document.getElementById('facebook').value,
        youtube: document.getElementById('youtube').value
      };
      try {
        await fetchWithRetry('/api/save-data', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ products, categories, settings, staticPages })
        });
        alert('Social media links saved!');
      } catch (error) {
        console.error('Error saving socials:', error);
        alert('Failed to save social media links. Please try again.');
      } finally {
        setButtonLoading(button, false);
      }
    });

    // Save fallback rate
    document.getElementById('save-fallback-rate').addEventListener('click', async () => {
      const button = document.getElementById('save-fallback-rate');
      setButtonLoading(button, true);
      settings.fallbackRate = parseFloat(document.getElementById('fallback-rate').value);
      try {
        await fetchWithRetry('/api/save-data', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ products, categories, settings, staticPages })
        });
        alert('Fallback rate saved!');
      } catch (error) {
        console.error('Error saving fallback rate:', error);
        alert('Failed to save fallback rate. Please try again.');
      } finally {
        setButtonLoading(button, false);
      }
    });

    // Change admin credentials
    document.getElementById('change-credentials').addEventListener('click', async () => {
      const newEmail = document.getElementById('new-email').value;
      const newPassword = document.getElementById('new-password').value;
      const confirmPassword = document.getElementById('confirm-password').value;

      if (!newEmail || !newPassword || !confirmPassword) {
        alert('Please fill in all fields.');
        return;
      }
      if (newPassword !== confirmPassword) {
        alert('Passwords do not match.');
        return;
      }

      settings.adminEmail = newEmail;
      settings.adminPassword = newPassword;
      try {
        await fetchWithRetry('/api/save-data', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ products, categories, settings, staticPages })
        });
        alert('Credentials updated! Please log in again.');
        window.location.reload();
      } catch (error) {
        console.error('Error changing credentials:', error);
        alert('Failed to change credentials. Please try again.');
      }
    });

    // Add or update static page
    document.getElementById('add-page').addEventListener('click', async () => {
      const title = document.getElementById('page-title').value;
      const slug = document.getElementById('page-slug').value;
      const content = document.getElementById('page-content').value;
      const editingSlug = document.getElementById('add-page').dataset.editingSlug;

      if (!title || !slug || !content) {
        alert('Please fill in all fields.');
        return;
      }

      if (editingSlug) {
        const page = staticPages.find(p => p.slug === editingSlug);
        if (page) {
          page.title = title;
          page.slug = slug;
          page.content = content;
        }
      } else {
        if (staticPages.some(p => p.slug === slug)) {
          alert('A page with this slug already exists.');
          return;
        }
        staticPages.push({ title, slug, content });
      }

      try {
        await fetchWithRetry('/api/save-data', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ products, categories, settings, staticPages })
        });
        renderStaticPages();
        document.getElementById('page-title').value = '';
        document.getElementById('page-slug').value = '';
        document.getElementById('page-content').value = '';
        document.getElementById('add-page').textContent = 'Add Page';
        delete document.getElementById('add-page').dataset.editingSlug;
        alert(editingSlug ? 'Page updated successfully!' : 'Page added successfully!');
      } catch (error) {
        console.error('Error saving page:', error);
        alert('Failed to save page. Please try again.');
      }
    });

    // Login
    document.getElementById('login-submit').addEventListener('click', async () => {
      const email = document.getElementById('login-email').value;
      const password = document.getElementById('login-password').value;

      try {
        const response = await fetch('/api/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, password }),
          credentials: 'include'
        });
        const data = await response.json();
        if (data.success) {
          document.getElementById('login-modal').classList.add('hidden');
          initialize();
        } else {
          alert('Invalid credentials. Please try again.');
        }
      } catch (error) {
        console.error('Error logging in:', error);
        alert('Failed to log in. Please try again.');
      }
    });

    // Toggle password visibility
    document.getElementById('toggle-password').addEventListener('click', () => {
      const passwordInput = document.getElementById('login-password');
      const toggleButton = document.getElementById('toggle-password');
      if (passwordInput.type === 'password') {
        passwordInput.type = 'text';
        toggleButton.textContent = 'Hide';
      } else {
        passwordInput.type = 'password';
        toggleButton.textContent = 'Show';
      }
    });

    // Check session on load
    async function checkSession() {
      try {
        const response = await fetchWithRetry('/api/check-session');
        if (response.isAuthenticated) {
          document.getElementById('login-modal').classList.add('hidden');
          initialize();
        }
      } catch (error) {
        console.error('Error checking session:', error);
      }
    }

    // Initialize
    async function initialize() {
      await fetchData();
      populateCategories();
      renderBots();
      renderCategories();
      renderStaticPages();

      document.getElementById('urgent-toggle').checked = settings.urgentMessage?.enabled || false;
      document.getElementById('urgent-message').value = settings.urgentMessage?.text || '';
      document.getElementById('support-email').value = settings.supportEmail || '';
      document.getElementById('copyright-text').value = settings.copyrightText || '';
      document.getElementById('logo-url').value = settings.logoUrl || '';
      document.getElementById('mpesa-till').value = settings.mpesaTill || '';
      document.getElementById('tiktok').value = settings.socials?.tiktok || '';
      document.getElementById('whatsapp').value = settings.socials?.whatsapp || '';
      document.getElementById('instagram').value = settings.socials?.instagram || '';
      document.getElementById('x').value = settings.socials?.x || '';
      document.getElementById('facebook').value = settings.socials?.facebook || '';
      document.getElementById('youtube').value = settings.socials?.youtube || '';
      document.getElementById('fallback-rate').value = settings.fallbackRate || 130;
    }

    checkSession();
  </script>
</body>
</html>
